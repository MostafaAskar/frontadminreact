{"ast":null,"code":"import React,{useEffect,useState}from'react';import{useNavigate,useParams}from'react-router-dom';import{toast}from'react-toastify';import{Card,Form,Spin,Steps}from'antd';import{IMG_URL}from'../../configs/app-global';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{disableRefetch,removeFromMenu,setMenuData}from'../../redux/slices/menu';import{useTranslation}from'react-i18next';import LanguageList from'../../components/language-list';import{steps}from'./steps';import recieptService from'../../services/reciept';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const{Step}=Steps;const RecieptEdit=()=>{var _activeMenu$data,_activeMenu$data2,_activeMenu$data3;const{t}=useTranslation();const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{id}=useParams();const dispatch=useDispatch();const{defaultLang}=useSelector(state=>state.formLang,shallowEqual);const[current,setCurrent]=useState(((_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.step)||0);const createImage=name=>{return{name,url:IMG_URL+name};};const[image,setImage]=useState((_activeMenu$data2=activeMenu.data)!==null&&_activeMenu$data2!==void 0&&_activeMenu$data2.galleries[0]?[createImage(activeMenu.data.galleries[0].path)]:[]);const[back,setBack]=useState((_activeMenu$data3=activeMenu.data)!==null&&_activeMenu$data3!==void 0&&_activeMenu$data3.galleries[1]?[createImage(activeMenu.data.galleries[1].path)]:[]);const next=()=>{const step=current+1;setCurrent(step);};const prev=()=>{const step=current-1;setCurrent(step);};const[form]=Form.useForm();const navigate=useNavigate();const[loading,setLoading]=useState(false);const[loadingBtn,setLoadingBtn]=useState(false);useEffect(()=>{return()=>{const data=form.getFieldsValue(true);dispatch(setMenuData({activeMenu,data}));};},[]);const fetchBox=id=>{setLoading(true);recieptService.getById(id).then(res=>{var _recept$nutritions,_recept$category$tran,_recept$shop$translat;let recept=res.data;form.setFieldsValue({...recept,title:{[defaultLang]:recept.translation.title},description:{[defaultLang]:recept.translation.description},instruction:Object.assign({},...recept.instructions.map(ins=>({[ins.locale]:ins.title}))),ingredient:Object.assign({},...recept.ingredients.map(ing=>({[ing.locale]:ing.title}))),nutrition:(_recept$nutritions=recept.nutritions)===null||_recept$nutritions===void 0?void 0:_recept$nutritions.map(nutrition=>{var _nutrition$percentage;return{percentage:nutrition===null||nutrition===void 0?void 0:(_nutrition$percentage=nutrition.percentage)===null||_nutrition$percentage===void 0?void 0:_nutrition$percentage.toString(),weight:nutrition.weight,...Object.assign({},...nutrition.translations.flatMap(translation=>({[translation.locale]:translation.title})))};}),category_id:{value:recept.category.id,label:(_recept$category$tran=recept.category.translation)===null||_recept$category$tran===void 0?void 0:_recept$category$tran.title},shop_id:{value:recept.shop.id,label:(_recept$shop$translat=recept.shop.translation)===null||_recept$shop$translat===void 0?void 0:_recept$shop$translat.title},stocks:recept.stocks.map(item=>{var _item$product,_item$product$transla;return{stock_id:{value:item.id,label:item===null||item===void 0?void 0:(_item$product=item.product)===null||_item$product===void 0?void 0:(_item$product$transla=_item$product.translation)===null||_item$product$transla===void 0?void 0:_item$product$transla.title},...item};})});setImage([createImage(recept.galleries[0].path)]);setBack([createImage(recept.galleries[1].path)]);}).finally(()=>{setLoading(false);dispatch(disableRefetch(activeMenu));});};const images=[...image,...back];const onFinish=values=>{var _values$stocks;form.validateFields();const body={...values,category_id:values.category_id.value,images:images.map(img=>img.name),shop_id:values.shop_id.value,active_time:values.active_time.toString(),total_time:values.total_time.toString(),nutrition:values.nutrition.map(item=>({...item,percentage:String(item.percentage),weight:String(item.weight)})),stocks:(_values$stocks=values.stocks)===null||_values$stocks===void 0?void 0:_values$stocks.map(stock=>({min_quantity:stock.min_quantity,stock_id:stock.stock_id.value}))};setLoadingBtn(true);const nextUrl='catalog/recept';recieptService.update(id,body).then(()=>{toast.success(t('successfully.updated'));navigate(`/${nextUrl}`);dispatch(removeFromMenu({...activeMenu,nextUrl}));}).finally(()=>setLoadingBtn(false));};useEffect(()=>{if(activeMenu.refetch){fetchBox(id);}},[activeMenu.refetch]);return/*#__PURE__*/_jsx(Card,{title:t('edit.recepe'),extra:/*#__PURE__*/_jsx(LanguageList,{}),children:!loading?/*#__PURE__*/_jsxs(Form,{layout:\"vertical\",onFinish:onFinish,form:form,initialValues:{active:true,...activeMenu.data},children:[/*#__PURE__*/_jsx(Steps,{current:current,children:steps.map(item=>/*#__PURE__*/_jsx(Step,{title:t(item.title)},item.title))}),steps.map(item=>{const Component=item.content;return/*#__PURE__*/_jsx(\"div\",{className:`steps-content ${item.step!==current+1&&'hidden'}`,children:/*#__PURE__*/_jsx(Component,{next:next,prev:prev,loading:loadingBtn,image:image,setImage:setImage,back:back,setBack:setBack})},item.title);})]}):/*#__PURE__*/_jsx(\"div\",{className:\"d-flex justify-content-center align-items-center\",children:/*#__PURE__*/_jsx(Spin,{size:\"large\",className:\"py-5\"})})});};export default RecieptEdit;","map":null,"metadata":{},"sourceType":"module"}