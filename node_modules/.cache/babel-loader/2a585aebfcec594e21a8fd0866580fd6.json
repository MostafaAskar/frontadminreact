{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Button,Card,Col,Form,Input,InputNumber,Row,Switch}from'antd';import{DebounceSelect}from'components/search';import shopService from'services/restaurant';import brandService from'services/brand';import categoryService from'services/category';import{shallowEqual,useDispatch,useSelector}from'react-redux';import productService from'services/product';import{addMenu,replaceMenu,setMenuData}from'redux/slices/menu';import unitService from'services/unit';import{useNavigate,useParams}from'react-router-dom';import{useTranslation}from'react-i18next';import MediaUpload from'components/upload';import TextArea from'antd/lib/input/TextArea';import{RefetchSearch}from'components/refetch-search';import{PlusOutlined,DeploymentUnitOutlined}from'@ant-design/icons';import{AsyncTreeSelect}from'components/async-tree-select-category';import VideoUploaderWithModal from'components/video-uploader';import generateRandomNumbers from'helpers/generateRandomNumbers';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const ProductsIndex=_ref=>{var _activeMenu$data,_activeMenu$data2,_activeMenu$data2$ima;let{next,action_type='',isRequest}=_ref;const{t}=useTranslation();const[form]=Form.useForm();const dispatch=useDispatch();const{uuid}=useParams();const navigate=useNavigate();const[error,setError]=useState(null);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{defaultLang,languages}=useSelector(state=>state.formLang,shallowEqual);const[mediaList,setMediaList]=useState((activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.initialMediaFile)||{images:[],previews:[]});const[fileList,setFileList]=useState(((_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:(_activeMenu$data2$ima=_activeMenu$data2.images)===null||_activeMenu$data2$ima===void 0?void 0:_activeMenu$data2$ima.filter(item=>!item.isVideo))||[]);const[loadingBtn,setLoadingBtn]=useState(false);const randomNumbersLength=6;useEffect(()=>{const data=form.getFieldsValue(true);dispatch(setMenuData({activeMenu,data:{...activeMenu.data,...data}}));},[]);async function fetchUserShopList(search){const params={search,active:1};return shopService.get(params).then(res=>res.data.map(item=>({label:item.translation?item.translation.title:'no name',value:item.id,key:item.id})));}async function fetchUserBrandList(search){const params={perPage:10,type:'main',search,active:1};return brandService.getAll(params).then(res=>res.data.map(item=>({label:item.title,value:item.id,key:item.id})));}async function fetchUserCategoryList(search){const params={perPage:100,type:'main',search};return categoryService.getAll(params).then(res=>res.data.map(item=>{var _item$translation,_item$children,_item$children2;return{label:(_item$translation=item.translation)===null||_item$translation===void 0?void 0:_item$translation.title,value:item.id,key:item.id,type:'main',disabled:(_item$children=item.children)===null||_item$children===void 0?void 0:_item$children.length,children:(_item$children2=item.children)===null||_item$children2===void 0?void 0:_item$children2.map(el=>{var _el$translation,_el$children,_el$children2;return{label:(_el$translation=el.translation)===null||_el$translation===void 0?void 0:_el$translation.title,value:el.id,key:el.id,type:'sub_main',disabled:(_el$children=el.children)===null||_el$children===void 0?void 0:_el$children.length,children:(_el$children2=el.children)===null||_el$children2===void 0?void 0:_el$children2.map(three=>{var _three$translation;return{label:(_three$translation=three.translation)===null||_three$translation===void 0?void 0:_three$translation.title,value:three.id,key:three.id,type:'child'};})};})};}));}const onFinish=values=>{var _values$brand,_values$category,_values$shop,_values$unit,_mediaList$previews;setLoadingBtn(true);const params={...values,digital:values.digital?1:0,active:Number(values.active),brand_id:(_values$brand=values.brand)===null||_values$brand===void 0?void 0:_values$brand.value,category_id:((_values$category=values.category)===null||_values$category===void 0?void 0:_values$category.value)||values.category,shop_id:(_values$shop=values.shop)===null||_values$shop===void 0?void 0:_values$shop.value,unit_id:(_values$unit=values.unit)===null||_values$unit===void 0?void 0:_values$unit.value,images:undefined,brand:undefined,category:undefined,shop:undefined,unit:undefined,tax:values.tax||0,...Object.assign({},...[...(mediaList===null||mediaList===void 0?void 0:mediaList.images),...fileList].map((item,index)=>({[`images[${index}]`]:item.name}))),...Object.assign({},...(mediaList===null||mediaList===void 0?void 0:(_mediaList$previews=mediaList.previews)===null||_mediaList$previews===void 0?void 0:_mediaList$previews.map((item,index)=>({[`previews[${index}]`]:item.name}))))};if(isRequest){dispatch(setMenuData({activeMenu,data:{...activeMenu.data,...params,images:fileList,brand:values.brand,category:values.category,shop:values.shop,unit:values.unit,tax:values.tax||0,title:{...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`title[${lang.locale}]`]})))},description:{...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`description[${lang.locale}]`]})))}}}));next();return;}if(action_type==='edit'){productUpdate(values,params);}else{productCreate(values,params);}};const createMediaFile=items=>{const mediaObject={images:[],previews:[]};const previews=items.filter(item=>item.preview).map(item=>({uid:item.id,name:item.preview,url:item.preview}));const videos=items.filter(item=>item.preview).map(item=>({uid:item.id,name:item.path,url:item.path,isVideo:true}));mediaObject.previews=previews;mediaObject.images=videos;return mediaObject;};function productCreate(values,params){productService.create(params).then(_ref2=>{let{data}=_ref2;dispatch(replaceMenu({id:`product-${data.uuid}`,url:`product/${data.uuid}`,name:t('add.product'),data:{...values,...data,initialMediaFile:createMediaFile(data.galleries)},refetch:false}));navigate(`/product/${data.uuid}/?step=1`);}).catch(err=>setError(err.response.data.params)).finally(()=>setLoadingBtn(false));}function productUpdate(values,params){productService.update(uuid,params).then(()=>{dispatch(setMenuData({activeMenu,data:{...values,...(activeMenu===null||activeMenu===void 0?void 0:activeMenu.data),digital:Boolean(params===null||params===void 0?void 0:params.digital)}}));next();}).catch(err=>setError(err.response.data.params)).finally(()=>setLoadingBtn(false));}function fetchUnits(search){const params={perPage:10,page:1,active:1,search};return unitService.getAll(params).then(_ref3=>{let{data}=_ref3;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation2;return{label:item===null||item===void 0?void 0:(_item$translation2=item.translation)===null||_item$translation2===void 0?void 0:_item$translation2.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});}useEffect(()=>{fetchUnits();return()=>{const data=form.getFieldsValue(true);dispatch(setMenuData({activeMenu,data:{...activeMenu.data,...data}}));};},[]);const goToAddCategory=()=>{dispatch(addMenu({id:'category-add',url:'category/add',name:t('add.category')}));navigate('/category/add');};const goToUnit=()=>{dispatch(addMenu({id:'unit-add',url:'unit/add',name:t('add.unit')}));navigate('/unit/add');};return/*#__PURE__*/_jsxs(Form,{layout:\"vertical\",form:form,initialValues:{active:true,vegetarian:true,min_qty:1,max_qty:1,tax:0,interval:1,age_limit:12,digital:false,...activeMenu.data},onFinish:onFinish,children:[/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('basic.info'),children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:languages.map(item=>/*#__PURE__*/_jsx(Form.Item,{label:t('name'),name:`title[${item.locale}]`,rules:[{validator(_,value){if(!value&&(item===null||item===void 0?void 0:item.locale)===defaultLang){return Promise.reject(new Error(t('required')));}else if(value&&(value===null||value===void 0?void 0:value.trim())===''){return Promise.reject(new Error(t('no.empty.space')));}else if(value&&(value===null||value===void 0?void 0:value.trim().length)<2){return Promise.reject(new Error(t('must.be.at.least.2')));}return Promise.resolve();}}],hidden:item.locale!==defaultLang,children:/*#__PURE__*/_jsx(Input,{})},'name'+item.id))}),/*#__PURE__*/_jsx(Col,{span:24,children:languages.map(item=>/*#__PURE__*/_jsx(Form.Item,{label:t('description'),name:`description[${item.locale}]`,rules:[{validator(_,value){if(!value&&(item===null||item===void 0?void 0:item.locale)===defaultLang){return Promise.reject(new Error(t('required')));}else if(value&&(value===null||value===void 0?void 0:value.trim())===''){return Promise.reject(new Error(t('no.empty.space')));}else if(value&&(value===null||value===void 0?void 0:value.trim().length)<5){return Promise.reject(new Error(t('must.be.at.least.5')));}return Promise.resolve();}}],hidden:item.locale!==defaultLang,children:/*#__PURE__*/_jsx(TextArea,{rows:3})},'description'+item.id))})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('pricing'),children:/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('min.qty'),name:\"min_qty\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(InputNumber,{min:1,className:\"w-100\"})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('max.qty'),name:\"max_qty\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(InputNumber,{min:1,className:\"w-100\"})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('tax'),name:\"tax\",rules:[{validator(_,value){if(value&&(value<0||value>100)){return Promise.reject(new Error(t('must.be.between.0.and.100')));}return Promise.resolve();}}],children:/*#__PURE__*/_jsx(InputNumber,{className:\"w-100\",addonAfter:\"%\"})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('interval.unit'),name:\"interval\",rules:[{required:true,message:t('required')},{type:'number',min:0,message:t('must.be.positive')}],help:error!==null&&error!==void 0&&error.interval?error.interval[0]:null,validateStatus:error!==null&&error!==void 0&&error.interval?'error':'success',children:/*#__PURE__*/_jsx(InputNumber,{className:\"w-100\"})})})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('additions'),children:/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('age.limit'),name:\"age_limit\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(InputNumber,{min:0,className:\"w-100\"})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('active'),name:\"active\",valuePropName:\"checked\",children:/*#__PURE__*/_jsx(Switch,{})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('digital'),name:\"digital\",valuePropName:\"checked\",children:/*#__PURE__*/_jsx(Switch,{})})})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('video'),children:/*#__PURE__*/_jsx(VideoUploaderWithModal,{form:form,mediaList:mediaList,setMediaList:setMediaList})})})]})}),/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('organization'),children:/*#__PURE__*/_jsxs(Row,{children:[!isRequest&&/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('shop/restaurant'),name:\"shop\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(RefetchSearch,{fetchOptions:fetchUserShopList,onChange:()=>form.setFieldsValue({category:undefined})// disabled={action_type === 'edit'}\n})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('category'),name:\"category\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(AsyncTreeSelect,{refetch:true,fetchOptions:fetchUserCategoryList,dropdownRender:menu=>/*#__PURE__*/_jsxs(_Fragment,{children:[menu,/*#__PURE__*/_jsx(\"div\",{className:\"p-1\",children:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(PlusOutlined,{}),className:\"w-100\",onClick:goToAddCategory,children:t('add.category')})})]}),allowClear:true})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('brand'),name:\"brand\",children:/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchUserBrandList})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('unit'),name:\"unit\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchUnits,dropdownRender:menu=>/*#__PURE__*/_jsxs(_Fragment,{children:[menu,/*#__PURE__*/_jsx(\"div\",{className:\"p-1\",children:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(PlusOutlined,{}),className:\"w-100\",onClick:goToUnit,children:t('add.unit')})})]})})})})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('media'),children:/*#__PURE__*/_jsx(Row,{children:/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{name:\"images\",rules:[{validator(){if((fileList===null||fileList===void 0?void 0:fileList.length)===0){return Promise.reject(new Error(t('required')));}return Promise.resolve();}}],children:/*#__PURE__*/_jsx(MediaUpload,{type:\"products\",imageList:fileList,setImageList:setFileList,form:form,multiple:true})})})})})})]})})]}),/*#__PURE__*/_jsx(Button,{type:\"primary\",htmlType:\"submit\",loading:loadingBtn,children:t('next')})]});};export default ProductsIndex;","map":null,"metadata":{},"sourceType":"module"}