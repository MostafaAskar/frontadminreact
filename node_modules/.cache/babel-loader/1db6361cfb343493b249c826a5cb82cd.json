{"ast":null,"code":"import React,{useState}from'react';import{CheckOutlined,CloseOutlined}from'@ant-design/icons';import{Button,Card,Col,Descriptions,Input,Row,Space,Spin}from'antd';import Meta from'antd/lib/card/Meta';import getImage from'../../../helpers/getImage';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addOrderCoupon,clearOrderProducts,removeFromOrder,setOrderTotal,verifyOrderCoupon}from'../../../redux/slices/order';import orderService from'../../../services/waiter/order';import calculateTotalPrice from'../../../helpers/calculateTotalPrice';import ExtrasModal from'./extrasModal';import numberToPrice from'../../../helpers/numberToPrice';import useDidUpdate from'../../../helpers/useDidUpdate';import{useNavigate}from'react-router-dom';import{addMenu}from'../../../redux/slices/menu';import{fetchSellerProducts}from'../../../redux/slices/product';import{useTranslation}from'react-i18next';import invokableService from'../../../services/rest/invokable';import{calculateTotalWithDeliveryPrice}from'../../../redux/selectors/orderSelector';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export default function OrderItems(){var _data$currency5,_data$currency6,_data$currency7,_data$currency8;const{t}=useTranslation();const dispatch=useDispatch();const navigate=useNavigate();const{orderItems,data,orderShops,total,coupons}=useSelector(state=>state.order,shallowEqual);const[loading,setLoading]=useState(false);const[extrasModal,setExtrasModal]=useState(null);const[loadingCoupon,setLoadingCoupon]=useState(null);function formatProducts(list){const result=list.map((item,index)=>({[`products[${index}][id]`]:item.id,[`products[${index}][quantity]`]:item.quantity}));return Object.assign({},...result);}useDidUpdate(()=>{dispatch(fetchSellerProducts({perPage:12,currency_id:data.currency.id}));},[data.currency]);useDidUpdate(()=>{if(orderItems.length){productCalculate();}else{dispatch(clearOrderProducts());}},[orderItems,data.currency]);function productCalculate(){const products=formatProducts(orderItems);const params={currency_id:data.currency.id,...products};setLoading(true);orderService.calculate(params).then(_ref=>{let{data}=_ref;const items=data.products.map(item=>({...orderItems.find(el=>el.id===item.id),...item}));dispatch(setOrderTotal(items));const orderData={product_total:data.product_total,product_tax:data.product_tax,order_tax:data.order_tax,order_total:data.order_total};dispatch(setOrderTotal(orderData));}).finally(()=>setLoading(false));}const goToProduct=item=>{dispatch(addMenu({id:`product-${item.uuid}`,url:`seller/product/${item.uuid}`,name:'Product edit'}));navigate(`/seller/product/${item.uuid}`);};function handleCheckCoupon(shopId){let coupon=coupons.find(item=>item.shop_id===shopId);if(!coupon){return;}setLoadingCoupon(shopId);invokableService.checkCoupon(coupon).then(res=>dispatch(verifyOrderCoupon({shop_id:shopId,price:res.data.price,verified:true}))).catch(()=>dispatch(verifyOrderCoupon({shop_id:shopId,price:0,verified:false}))).finally(()=>setLoadingCoupon(null));}return/*#__PURE__*/_jsxs(\"div\",{className:\"order-items\",children:[loading&&/*#__PURE__*/_jsx(\"div\",{className:\"loader\",children:/*#__PURE__*/_jsx(Spin,{})}),/*#__PURE__*/_jsxs(Row,{gutter:24,className:\"mt-4\",children:[/*#__PURE__*/_jsx(Col,{span:24,children:orderShops.map(shop=>{var _shop$translation,_coupons$find,_coupons$find2,_data$currency,_data$currency2,_data$currency3,_data$currency4;return/*#__PURE__*/_jsxs(Card,{className:\"shop-card\",children:[shop.products.map(item=>{var _item$translation,_item$translation2;return/*#__PURE__*/_jsxs(Card,{className:\"position-relative\",children:[/*#__PURE__*/_jsx(CloseOutlined,{className:\"close-order\",onClick:()=>dispatch(removeFromOrder(item))}),/*#__PURE__*/_jsxs(Space,{className:\"mr-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"order-item-img\",children:/*#__PURE__*/_jsx(\"img\",{src:getImage(item.img),alt:(_item$translation=item.translation)===null||_item$translation===void 0?void 0:_item$translation.title})}),/*#__PURE__*/_jsx(Meta,{title:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{className:\"cursor-pointer white-space-wrap\",onClick:()=>goToProduct(item),children:(_item$translation2=item.translation)===null||_item$translation2===void 0?void 0:_item$translation2.title}),/*#__PURE__*/_jsx(\"div\",{className:\"product-price\",children:numberToPrice(item.price_without_tax,data.currency.symbol)})]}),description:/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{children:[\"Quantity: \",item.quantity]}),/*#__PURE__*/_jsx(Space,{className:\"mt-2\",children:item.stock.extras.map(el=>{if(el.group.type==='color'){return/*#__PURE__*/_jsx(\"span\",{className:\"extras-color\",style:{backgroundColor:el.value}});}else if(el.group.type==='text'){return/*#__PURE__*/_jsx(\"span\",{className:\"extras-text rounded\",children:el.value});}return/*#__PURE__*/_jsx(\"img\",{src:getImage(el.value),alt:\"extra\",className:\"extras-image rounded\"});})})]})})]})]},item.id);}),/*#__PURE__*/_jsxs(\"div\",{className:\"d-flex align-items-center justify-content-between\",children:[/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(\"img\",{src:getImage(shop.logo_img),alt:\"shop logo\",width:40,className:\"rounded-circle\"}),/*#__PURE__*/_jsx(\"div\",{children:(_shop$translation=shop.translation)===null||_shop$translation===void 0?void 0:_shop$translation.title})]}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Input,{placeholder:t('coupon'),addonAfter:(_coupons$find=coupons.find(el=>el.shop_id===shop.id))!==null&&_coupons$find!==void 0&&_coupons$find.verified?/*#__PURE__*/_jsx(CheckOutlined,{style:{color:'#18a695'}}):null,defaultValue:(_coupons$find2=coupons.find(el=>el.shop_id===shop.id))===null||_coupons$find2===void 0?void 0:_coupons$find2.coupon,onBlur:event=>{var _data$user;return dispatch(addOrderCoupon({coupon:event.target.value,user_id:(_data$user=data.user)===null||_data$user===void 0?void 0:_data$user.value,shop_id:shop.id,verified:false}));}}),/*#__PURE__*/_jsx(Button,{onClick:()=>handleCheckCoupon(shop.id),loading:loadingCoupon===shop.id,children:t('check.coupon')})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 text-right shop-total\",children:[/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-weight-bold\",children:\"Product tax:\"}),/*#__PURE__*/_jsx(\"p\",{children:numberToPrice(calculateTotalPrice(shop).productTax,(_data$currency=data.currency)===null||_data$currency===void 0?void 0:_data$currency.symbol)})]}),/*#__PURE__*/_jsx(\"div\",{}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-weight-bold\",children:\"Shop tax:\"}),/*#__PURE__*/_jsx(\"p\",{children:numberToPrice(calculateTotalPrice(shop).shopTax,(_data$currency2=data.currency)===null||_data$currency2===void 0?void 0:_data$currency2.symbol)})]}),/*#__PURE__*/_jsx(\"div\",{}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-weight-bold\",children:\"Delivery fee:\"}),/*#__PURE__*/_jsx(\"p\",{children:numberToPrice(calculateTotalPrice(shop,data.deliveries).deliveryFee,(_data$currency3=data.currency)===null||_data$currency3===void 0?void 0:_data$currency3.symbol)})]}),/*#__PURE__*/_jsx(\"div\",{}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-weight-bold\",children:\"Total:\"}),/*#__PURE__*/_jsx(\"p\",{children:numberToPrice(calculateTotalPrice(shop,data.deliveries).total,(_data$currency4=data.currency)===null||_data$currency4===void 0?void 0:_data$currency4.symbol)})]})]})]})]},shop.uuid);})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(\"div\",{className:\"order-info\",children:/*#__PURE__*/_jsxs(Descriptions,{bordered:true,className:\"order-info-container\",children:[/*#__PURE__*/_jsx(Descriptions.Item,{label:\"Product total\",children:numberToPrice(total.product_total,(_data$currency5=data.currency)===null||_data$currency5===void 0?void 0:_data$currency5.symbol)}),/*#__PURE__*/_jsx(Descriptions.Item,{label:\"Product tax\",children:numberToPrice(total.product_tax,(_data$currency6=data.currency)===null||_data$currency6===void 0?void 0:_data$currency6.symbol)}),/*#__PURE__*/_jsx(Descriptions.Item,{label:\"Shop tax\",children:numberToPrice(total.order_tax,(_data$currency7=data.currency)===null||_data$currency7===void 0?void 0:_data$currency7.symbol)}),/*#__PURE__*/_jsx(Descriptions.Item,{label:\"Order total\",labelStyle:{fontWeight:700},children:/*#__PURE__*/_jsx(\"span\",{style:{fontWeight:700},children:numberToPrice(calculateTotalWithDeliveryPrice(data.deliveries,total.order_total),(_data$currency8=data.currency)===null||_data$currency8===void 0?void 0:_data$currency8.symbol)})})]})})})]}),extrasModal&&/*#__PURE__*/_jsx(ExtrasModal,{extrasModal:extrasModal,setExtrasModal:setExtrasModal})]});}","map":null,"metadata":{},"sourceType":"module"}