{"ast":null,"code":"import{Card,Col,Row,Space,Typography,Table,Tag,Button,DatePicker,Spin,Badge}from'antd';import React,{useContext,useEffect,useState}from'react';import SearchInput from'../../components/search-input';import{CloudDownloadOutlined}from'@ant-design/icons';import ReportService from'../../services/reports';import{disableRefetch}from'../../redux/slices/menu';import{shallowEqual,useDispatch,useSelector}from'react-redux';import ReportChart from'../../components/report/chart';import moment from'moment';import{ReportContext}from'../../context/report';import FilterColumns from'../../components/filter-column';import{export_url}from'../../configs/app-global';import{clearCompare,fetchReportProduct,fetchReportProductChart,ReportProductCompare}from'../../redux/slices/report/products';import useDidUpdate from'../../helpers/useDidUpdate';import{Link,useLocation,useNavigate}from'react-router-dom';import QueryString from'qs';import{t}from'i18next';import numberToPrice from'../../helpers/numberToPrice';import{useMemo}from'react';import shopService from'../../services/shop';import{DebounceSelect}from'components/search';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const{Text,Title}=Typography;const{RangePicker}=DatePicker;const ReportProducts=()=>{const dispatch=useDispatch();const location=useLocation();const navigate=useNavigate();const category_id=QueryString.parse(location.search,[])['?category_id'];const product_id=QueryString.parse(location.search,[])['?product_id'];const[shopId,setShopId]=useState();const{date_from,date_to,by_time,chart,handleChart,handleDateRange}=useContext(ReportContext);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{loading,chartData:reportData,productList}=useSelector(state=>state.productReport,shallowEqual);const[selectedRowKeys,setSelectedRowKeys]=useState([]);const[downloading,setDownloading]=useState(false);const[search,setSearch]=useState('');const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const[columns,setColumns]=useState([{title:t('product.title'),dataIndex:'title',key:'title',is_show:true,render:title=>{return title;},sorter:(a,b)=>{var _a$translation,_b$translation;return a===null||a===void 0?void 0:(_a$translation=a.translation)===null||_a$translation===void 0?void 0:_a$translation.title.localeCompare(b===null||b===void 0?void 0:(_b$translation=b.translation)===null||_b$translation===void 0?void 0:_b$translation.title);}},{title:t('orders'),dataIndex:'count',key:'count',is_show:true},{title:t('item.sold'),dataIndex:'quantity',key:'quantity',sorter:(a,b)=>a.quantity-b.quantity,is_show:true},{title:t('total.price'),dataIndex:'total_price',key:'total_price',is_show:true,render:total_price=>numberToPrice(total_price,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),sorter:(a,b)=>a.total_price-b.total_price}]);const chart_type=useMemo(()=>[{label:'item.sold',value:'quantity',qty:'quantity',price:false},{label:'net.sales',value:'price',qty:'price',price:true},{label:'orders',value:'count',qty:'count',price:false}],[]);const fetchReport=()=>{const params={date_from,date_to,type:by_time,chart};if(category_id)params.categories=[category_id];if(product_id)params.products=[product_id];if(chart_type.find(item=>item.value===chart)){dispatch(fetchReportProductChart(params));}};const fetchShops=search=>{const params={perPage:10,search};return shopService.selectPaginate(params).then(res=>res===null||res===void 0?void 0:res.map(shop=>{var _shop$translation;return{label:shop===null||shop===void 0?void 0:(_shop$translation=shop.translation)===null||_shop$translation===void 0?void 0:_shop$translation.title,value:shop===null||shop===void 0?void 0:shop.id};})).catch(err=>console.log('report product ERROR => ',err));};const fetchProduct=(page,perPage)=>{const params={date_from,date_to,type:by_time,page,perPage,search:search||null};if(category_id)params.categories=[category_id];if(product_id)params.products=[product_id];if(shopId)params.shop_id=shopId;dispatch(fetchReportProduct(params));};useEffect(()=>{handleChart(chart_type[0].value);},[]);useEffect(()=>{if(activeMenu.refetch){fetchProduct();fetchReport();dispatch(disableRefetch(activeMenu));}},[activeMenu.refetch]);useDidUpdate(()=>{fetchProduct();},[date_to,search,category_id,product_id,by_time,date_from,shopId]);useDidUpdate(()=>{fetchReport();},[date_to,by_time,chart,category_id,product_id,date_from]);const onChangePagination=pagination=>{const{pageSize:perPage,current:page}=pagination;fetchProduct(page,perPage);};const excelExport=()=>{setDownloading(true);ReportService.getReportProductList({date_from,date_to,type:by_time,export:'excel',shop_id:shopId,products:rowSelection!==null&&rowSelection!==void 0&&rowSelection.selectedRowKeys[0]?rowSelection===null||rowSelection===void 0?void 0:rowSelection.selectedRowKeys:product_id?[product_id]:undefined}).then(res=>{const body=export_url+res.data.file_name;window.location.href=body;}).finally(()=>setDownloading(false));};const onSelectChange=newSelectedRowKeys=>{setSelectedRowKeys(newSelectedRowKeys);};const rowSelection={selectedRowKeys,onChange:onSelectChange};const Compare=()=>{const params={date_from,date_to,type:by_time,chart,ids:selectedRowKeys,shop_id:shopId};dispatch(ReportProductCompare(params));};const clear=()=>{dispatch(clearCompare());setShopId(undefined);setSelectedRowKeys([]);fetchProduct();fetchReport();navigate(`/report/products`);};const onShopSelectClear=()=>{setShopId(undefined);fetchReportProduct();fetchReportProductChart({});};return/*#__PURE__*/_jsxs(Spin,{size:\"large\",spinning:loading,children:[/*#__PURE__*/_jsx(Row,{gutter:24,className:\"mb-3\",children:/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Space,{children:/*#__PURE__*/_jsx(RangePicker,{defaultValue:[moment(date_from),moment(date_to)],onChange:handleDateRange})})})}),/*#__PURE__*/_jsx(Row,{gutter:24,className:\"report-products\",children:chart_type===null||chart_type===void 0?void 0:chart_type.map(item=>/*#__PURE__*/_jsx(Col,{span:8,onClick:()=>handleChart(item.value),children:/*#__PURE__*/_jsxs(Card,{className:chart===item.value&&'active',children:[/*#__PURE__*/_jsx(Row,{className:\"mb-5\",children:/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Text,{children:t(item.label)})})}),/*#__PURE__*/_jsx(Row,{gutter:24,children:/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Title,{level:2,children:!(item!==null&&item!==void 0&&item.price)?reportData[item.qty]:numberToPrice(reportData[item.qty],defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol)})})})]})},item.label))}),/*#__PURE__*/_jsx(ReportChart,{reportData:reportData,chart_data:\"quantities_sum\"}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(Space,{className:\"d-flex justify-content-between align-center\",children:[/*#__PURE__*/_jsx(Typography.Text,{strong:true,level:3,children:t('products')}),/*#__PURE__*/_jsxs(Space,{className:\"d-flex justify-content-between\",children:[/*#__PURE__*/_jsx(SearchInput,{style:{minWidth:'300px'},handleChange:e=>setSearch(e)}),/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchShops,placeholder:t('select.shop'),onSelect:value=>setShopId(value.value),onClear:()=>onShopSelectClear()}),/*#__PURE__*/_jsx(Button,{type:Boolean(selectedRowKeys.length)||!!category_id||!!product_id||!!shopId?'primary':'default',danger:Boolean(selectedRowKeys.length)||!!category_id||!!product_id||!!shopId,onClick:clear,children:t('clear')}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(CloudDownloadOutlined,{}),loading:downloading,onClick:excelExport,children:t('download')}),/*#__PURE__*/_jsx(FilterColumns,{columns:columns,setColumns:setColumns})]})]}),/*#__PURE__*/_jsx(Table,{rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(item=>item.is_show),dataSource:Array.isArray(productList===null||productList===void 0?void 0:productList.data)?productList===null||productList===void 0?void 0:productList.data:[],rowKey:row=>row.id,loading:loading,pagination:{pageSize:10,page:(productList===null||productList===void 0?void 0:productList.page)||1,total:productList===null||productList===void 0?void 0:productList.total,defaultCurrent:1},onChange:onChangePagination,scroll:{x:1500}})]})]});};export default ReportProducts;","map":null,"metadata":{},"sourceType":"module"}