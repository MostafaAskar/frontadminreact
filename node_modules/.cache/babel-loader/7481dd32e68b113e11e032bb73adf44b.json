{"ast":null,"code":"import React,{useContext,useEffect,useState}from'react';import{Button,Space,Table,Card,Tabs,Tag,DatePicker,Spin}from'antd';import{useNavigate,useParams}from'react-router-dom';import{DeleteOutlined,DownloadOutlined,EditOutlined,EyeOutlined}from'@ant-design/icons';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addMenu,disableRefetch,setMenuData}from'../../redux/slices/menu';import{useTranslation}from'react-i18next';import useDidUpdate from'../../helpers/useDidUpdate';import{fetchOrders}from'../../redux/slices/orders';import formatSortType from'../../helpers/formatSortType';import SearchInput from'../../components/search-input';import numberToPrice from'../../helpers/numberToPrice';import OrderStatusModal from'../order/orderStatusModal';import OrderDeliveryman from'../order/orderDeliveryman';import FilterColumns from'../../components/filter-column';import{BiMap}from'react-icons/bi';import ShowLocationsMap from'../order/show-locations.map';import DownloadModal from'../order/downloadModal';import{toast}from'react-toastify';import DeleteButton from'../../components/delete-button';import orderService from'../../services/order';import{Context}from'../../context/context';import CustomModal from'../../components/modal';import{export_url}from'../../configs/app-global';import DeliveryStatistic from'../../components/delivery-statistic';import moment from'moment';import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";const{RangePicker}=DatePicker;const{TabPane}=Tabs;export default function DeliveryManOrder(){var _activeMenu$data,_activeMenu$data2;const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const[orderDetails,setOrderDetails]=useState(null);const[locationsMap,setLocationsMap]=useState(null);const[dowloadModal,setDowloadModal]=useState(null);const[orderDeliveryDetails,setOrderDeliveryDetails]=useState(null);const{id:deliverymanId}=useParams();const statuses=[{id:7,name:'all'},{id:3,name:'ready'},{id:4,name:'on_a_way'},{id:5,name:'delivered'},{id:6,name:'canceled'}];const goToShow=row=>{dispatch(addMenu({url:`order/details/${row.id}`,id:'order_details',name:t('order.details')}));navigate(`/order/details/${row.id}`);};const[columns,setColumns]=useState([{title:t('id'),is_show:true,dataIndex:'id',key:'id',sorter:true},{title:t('client'),is_show:true,dataIndex:'user',key:'user',render:user=>/*#__PURE__*/_jsxs(\"div\",{children:[user===null||user===void 0?void 0:user.firstname,\" \",user===null||user===void 0?void 0:user.lastname]})},{title:t('number.of.products'),is_show:true,dataIndex:'order_details_count',key:'order_details_count',render:order_details_count=>/*#__PURE__*/_jsxs(\"div\",{className:\"text-lowercase\",children:[order_details_count||0,\" \",t('products')]})},{title:t('status'),is_show:true,dataIndex:'status',key:'status',render:(status,row)=>/*#__PURE__*/_jsxs(\"div\",{children:[status==='new'?/*#__PURE__*/_jsx(Tag,{color:\"blue\",children:t(status)}):status==='canceled'?/*#__PURE__*/_jsx(Tag,{color:\"error\",children:t(status)}):/*#__PURE__*/_jsx(Tag,{color:\"cyan\",children:t(status)}),status!=='delivered'&&status!=='canceled'?/*#__PURE__*/_jsx(EditOutlined,{onClick:()=>setOrderDetails(row)}):'']})},{title:t('deliveryman'),is_show:true,dataIndex:'deliveryman',key:'deliveryman',render:(deliveryman,row)=>/*#__PURE__*/_jsx(\"div\",{children:row.status==='ready'&&row.delivery_type!=='pickup'?/*#__PURE__*/_jsx(Button,{type:\"link\",onClick:()=>setOrderDeliveryDetails(row),children:/*#__PURE__*/_jsxs(Space,{children:[deliveryman?`${deliveryman.firstname} ${deliveryman.lastname}`:t('add.deliveryman'),/*#__PURE__*/_jsx(EditOutlined,{})]})}):/*#__PURE__*/_jsxs(\"div\",{children:[deliveryman===null||deliveryman===void 0?void 0:deliveryman.firstname,\" \",deliveryman===null||deliveryman===void 0?void 0:deliveryman.lastname]})})},{title:t('amount'),is_show:true,dataIndex:'total_price',key:'total_price',render:total_price=>numberToPrice(total_price,defaultCurrency.symbol)},{title:t('payment.type'),is_show:true,dataIndex:'transaction',key:'transaction',render:transaction=>{var _transaction$payment_;return t(transaction===null||transaction===void 0?void 0:(_transaction$payment_=transaction.payment_system)===null||_transaction$payment_===void 0?void 0:_transaction$payment_.tag)||'-';}},{title:t('created.at'),is_show:true,dataIndex:'created_at',key:'created_at',render:created_at=>moment(created_at).format('YYYY-MM-DD HH:mm')},{title:t('options'),is_show:true,key:'options',render:(data,row)=>{return/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(BiMap,{}),onClick:()=>setLocationsMap(row.id)}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(EyeOutlined,{}),onClick:()=>goToShow(row)}),/*#__PURE__*/_jsx(DeleteButton,{icon:/*#__PURE__*/_jsx(DeleteOutlined,{}),onClick:()=>{setId([row.id]);setIsModalVisible(true);setText(true);}}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(DownloadOutlined,{}),onClick:()=>setDowloadModal(row.id)})]});}}]);const{setIsModalVisible}=useContext(Context);const[downloading,setDownloading]=useState(false);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const[id,setId]=useState(null);const[text,setText]=useState(null);const[loadingBtn,setLoadingBtn]=useState(false);const{orders,meta,loading,params,statistic}=useSelector(state=>state.orders,shallowEqual);const data=activeMenu===null||activeMenu===void 0?void 0:activeMenu.data;function onChangePagination(pagination,filter,sorter){const{pageSize:perPage,current:page}=pagination;const{field:column,order}=sorter;const sort=formatSortType(order);dispatch(setMenuData({activeMenu,data:{...activeMenu.data,perPage,page,column,sort}}));}const orderDelete=()=>{setLoadingBtn(true);const params={...Object.assign({},...id.map((item,index)=>({[`ids[${index}]`]:item})))};orderService.delete(params).then(()=>{toast.success(t('successfully.deleted'));setIsModalVisible(false);dispatch(fetchOrders());setText(null);setId(null);}).finally(()=>setLoadingBtn(false));};useDidUpdate(()=>{const paramsData={search:data===null||data===void 0?void 0:data.search,sort:data===null||data===void 0?void 0:data.sort,column:data===null||data===void 0?void 0:data.column,perPage:data===null||data===void 0?void 0:data.perPage,page:data===null||data===void 0?void 0:data.page,deliveryman:deliverymanId,date_from:data===null||data===void 0?void 0:data.date_from,date_to:data===null||data===void 0?void 0:data.date_to,// status:\n//   data?.status === 'deliveryman.attached' ? undefined : data?.status,\n// 'isset-deliveryman': data?.status === 'deliveryman.attached' ? 1 : 0,\nstatus:(data===null||data===void 0?void 0:data.status)==='all'?undefined:data===null||data===void 0?void 0:data.status};dispatch(fetchOrders(paramsData));},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.data]);const handleFilter=(item,name)=>{dispatch(setMenuData({activeMenu,data:{...data,[name]:item}}));};const excelExport=()=>{setDownloading(true);orderService.export({type:'delivery',deliveryman:deliverymanId,date_from:data===null||data===void 0?void 0:data.date_from,date_to:data===null||data===void 0?void 0:data.date_to,status:(data===null||data===void 0?void 0:data.status)==='all'?undefined:data===null||data===void 0?void 0:data.status}).then(res=>{const body=export_url+res.data.file_name;window.location.href=body;}).finally(()=>setDownloading(false));};const onChangeTab=status=>{const orderStatus=status;dispatch(setMenuData({activeMenu,data:{...data,status:orderStatus}}));};const handleCloseModal=()=>{setOrderDetails(null);setOrderDeliveryDetails(null);setLocationsMap(null);setDowloadModal(null);};useEffect(()=>{if(activeMenu!==null&&activeMenu!==void 0&&activeMenu.refetch){const params={status:data===null||data===void 0?void 0:data.status,page:data===null||data===void 0?void 0:data.page,perPage:10,type:'delivery',deliveryman:deliverymanId};dispatch(fetchOrders(params));dispatch(disableRefetch(activeMenu));}},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.refetch]);const rowSelection={selectedRowKeys:id,onChange:key=>{setId(key);}};const allDelete=()=>{if(id===null||id.length===0){toast.warning(t('select.the.product'));}else{setIsModalVisible(true);setText(false);}};const handleFilterDate=item=>{dispatch(setMenuData({activeMenu,data:{...data,date_from:item?moment(item===null||item===void 0?void 0:item[0]).format('YYYY-MM-DD').toString():undefined,date_to:item?moment(item===null||item===void 0?void 0:item[1]).format('YYYY-MM-DD').toString():undefined}}));};return/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Spin,{spinning:loading,children:/*#__PURE__*/_jsx(DeliveryStatistic,{data:statistic})}),/*#__PURE__*/_jsxs(Card,{title:t('orders'),extra:/*#__PURE__*/_jsxs(Space,{wrap:true,children:[/*#__PURE__*/_jsx(RangePicker,{format:\"YYYY-MM-DD\",onChange:e=>handleFilterDate(e)}),/*#__PURE__*/_jsx(DeleteButton,{type:\"danger\",onClick:allDelete,children:t('delete.all')}),/*#__PURE__*/_jsx(Button,{onClick:excelExport,loading:downloading,children:t('export')}),/*#__PURE__*/_jsx(FilterColumns,{setColumns:setColumns,columns:columns})]}),children:[/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 mb-4\",children:/*#__PURE__*/_jsx(SearchInput,{placeholder:t('search'),width:480,handleChange:search=>handleFilter(search,'search'),defaultValue:(_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.search,resetSearch:!((_activeMenu$data2=activeMenu.data)!==null&&_activeMenu$data2!==void 0&&_activeMenu$data2.search)})}),/*#__PURE__*/_jsx(Tabs,{onChange:onChangeTab,type:\"card\",activeKey:data===null||data===void 0?void 0:data.status,children:statuses.map(item=>/*#__PURE__*/_jsx(TabPane,{tab:t(item.name)},item.name))}),/*#__PURE__*/_jsx(Table,{scroll:{x:true},rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(items=>items.is_show),dataSource:orders,loading:loading,pagination:{pageSize:params.perPage,page:params.page,total:meta.total,defaultCurrent:params.page},rowKey:record=>record.id,onChange:onChangePagination}),orderDetails&&/*#__PURE__*/_jsx(OrderStatusModal,{orderDetails:orderDetails,handleCancel:handleCloseModal,status:statuses}),orderDeliveryDetails&&/*#__PURE__*/_jsx(OrderDeliveryman,{orderDetails:orderDeliveryDetails,handleCancel:handleCloseModal}),locationsMap&&/*#__PURE__*/_jsx(ShowLocationsMap,{id:locationsMap,handleCancel:handleCloseModal}),dowloadModal&&/*#__PURE__*/_jsx(DownloadModal,{id:dowloadModal,handleCancel:handleCloseModal}),/*#__PURE__*/_jsx(CustomModal,{click:orderDelete,text:text?t('delete'):t('all.delete'),loading:loadingBtn,setText:setId})]})]});}","map":null,"metadata":{},"sourceType":"module"}