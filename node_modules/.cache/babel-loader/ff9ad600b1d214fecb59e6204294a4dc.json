{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Card,Form,Steps}from'antd';import{useNavigate}from'react-router-dom';import{batch,shallowEqual,useSelector}from'react-redux';import{useTranslation}from'react-i18next';import{steps}from'./steps';import ParcelSender from'./parcel-sender';import ParcelReceiver from'./parcel-receiver';import ParcelDetails from'./parcel-details';import{useQueryParams}from'helpers/useQueryParams';import{useDispatch}from'react-redux';import{removeFromMenu,setMenuData}from'redux/slices/menu';import getDefaultLocation from'helpers/getDefaultLocation';import moment from'moment';import parcelOrderService from'services/parcelOrder';import{fetchParcelOrders}from'redux/slices/parcelOrders';import{toast}from'react-toastify';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const{Step}=Steps;export default function ParcelOrderAdd(){var _queryParams$values,_activeMenu$data,_activeMenu$data2,_activeMenu$data3,_activeMenu$data3$loc,_activeMenu$data4,_activeMenu$data4$loc,_activeMenu$data5,_activeMenu$data6,_activeMenu$data6$loc,_activeMenu$data7,_activeMenu$data7$loc;const{t}=useTranslation();const[form]=Form.useForm();const queryParams=useQueryParams();const dispatch=useDispatch();const navigate=useNavigate();const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{settings}=useSelector(state=>state.globalSettings,shallowEqual);const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const current=Number(((_queryParams$values=queryParams.values)===null||_queryParams$values===void 0?void 0:_queryParams$values.step)||0);const[loadingBtn,setLoadingBtn]=useState(false);const[image,setImage]=useState((activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.images)||[]);const[locationFrom,setLocationFrom]=useState(activeMenu!==null&&activeMenu!==void 0&&(_activeMenu$data2=activeMenu.data)!==null&&_activeMenu$data2!==void 0&&_activeMenu$data2.location_from?{lat:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:(_activeMenu$data3$loc=_activeMenu$data3.location_from)===null||_activeMenu$data3$loc===void 0?void 0:_activeMenu$data3$loc.latitude),lng:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:(_activeMenu$data4$loc=_activeMenu$data4.location_from)===null||_activeMenu$data4$loc===void 0?void 0:_activeMenu$data4$loc.longitude)}:getDefaultLocation(settings));const[locationTo,setLocationTo]=useState(activeMenu!==null&&activeMenu!==void 0&&(_activeMenu$data5=activeMenu.data)!==null&&_activeMenu$data5!==void 0&&_activeMenu$data5.location_to?{lat:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:(_activeMenu$data6$loc=_activeMenu$data6.location_to)===null||_activeMenu$data6$loc===void 0?void 0:_activeMenu$data6$loc.latitude),lng:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data7=activeMenu.data)===null||_activeMenu$data7===void 0?void 0:(_activeMenu$data7$loc=_activeMenu$data7.location_to)===null||_activeMenu$data7$loc===void 0?void 0:_activeMenu$data7$loc.longitude)}:getDefaultLocation(settings));useEffect(()=>{return()=>{const values=form.getFieldsValue(true);const date=JSON.stringify(values.delivery_date);const time=JSON.stringify(values.delivery_time);const data={...values,date,time};dispatch(setMenuData({activeMenu,data}));};},[]);const next=()=>{const step=current+1;queryParams.set('step',step);};const prev=()=>{const step=current-1;queryParams.set('step',step);};const onChange=step=>{queryParams.set('step',step);};const onFinish=values=>{var _values$user_from,_values$type;setLoadingBtn(true);const payload={user_id:(_values$user_from=values.user_from)===null||_values$user_from===void 0?void 0:_values$user_from.value,currency_id:defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.id,type_id:(_values$type=values.type)===null||_values$type===void 0?void 0:_values$type.value,rate:defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.rate,phone_from:values.phone_from.toString(),username_from:values.username_from,address_from:{longitude:locationFrom===null||locationFrom===void 0?void 0:locationFrom.lng,latitude:locationFrom===null||locationFrom===void 0?void 0:locationFrom.lat,address:values.address_from,house:values.house_from,stage:values.stage_from,room:values.room_from},phone_to:values.phone_to.toString(),username_to:values.username_to,address_to:{longitude:locationTo===null||locationTo===void 0?void 0:locationTo.lng,latitude:locationTo===null||locationTo===void 0?void 0:locationTo.lat,address:values.address_to,house:values.house_to,stage:values.stage_to,room:values.room_to},delivery_date:moment(values.delivery_date).format('YYYY-MM-DD HH:mm'),note:values.note,images:image.map(item=>item.name),payment_id:values.payment_type.value};const nextUrl='parcel-orders';parcelOrderService.create(payload).then(res=>{batch(()=>{dispatch(fetchParcelOrders({}));dispatch(removeFromMenu({...activeMenu,nextUrl}));});toast.success(t('successfully.created'));navigate(`/${nextUrl}`);}).finally(()=>setLoadingBtn(false));};const onFinishFailed=event=>{const steps=['','',''];const fields=event.errorFields.map(item=>item.name[0]);fields.forEach(el=>{if(el.includes('_from')){steps[0]='sender.details.invalid';return;}if(el.includes('_to')){steps[1]='receiver.details.invalid';return;}steps[2]='parcel.details.invalid';});steps.forEach(item=>{if(item)toast.error(t(item));});};return/*#__PURE__*/_jsxs(Card,{title:t('add.parcel.order'),children:[/*#__PURE__*/_jsx(Steps,{current:current,onChange:onChange,children:steps.map(item=>/*#__PURE__*/_jsx(Step,{title:t(item.title)},item.title))}),/*#__PURE__*/_jsx(\"div\",{className:\"steps-content\",children:/*#__PURE__*/_jsxs(Form,{form:form,name:\"parcel-create\",layout:\"vertical\",onFinish:onFinish,initialValues:{...activeMenu.data},onFinishFailed:onFinishFailed,children:[/*#__PURE__*/_jsx(\"div\",{className:steps[current].content==='First-content'?'':'d-none',children:/*#__PURE__*/_jsx(ParcelSender,{form:form,next:next,location:locationFrom,setLocation:setLocationFrom})}),/*#__PURE__*/_jsx(\"div\",{className:steps[current].content==='Second-content'?'':'d-none',children:/*#__PURE__*/_jsx(ParcelReceiver,{form:form,next:next,prev:prev,location:locationTo,setLocation:setLocationTo})}),/*#__PURE__*/_jsx(\"div\",{className:steps[current].content==='Third-content'?'':'d-none',children:/*#__PURE__*/_jsx(ParcelDetails,{form:form,loading:loadingBtn,prev:prev,locationFrom:locationFrom,locationTo:locationTo,image:image,setImage:setImage})})]})})]});}","map":null,"metadata":{},"sourceType":"module"}