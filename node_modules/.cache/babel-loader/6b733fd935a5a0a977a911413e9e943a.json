{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Card,Form,Steps}from'antd';import{useNavigate,useParams}from'react-router-dom';import{shallowEqual,useSelector}from'react-redux';import LanguageList from'components/language-list';import{useTranslation}from'react-i18next';import{steps}from'./steps';import ParcelSender from'./parcel-sender';import ParcelReceiver from'./parcel-receiver';import ParcelDetails from'./parcel-details';import{useQueryParams}from'helpers/useQueryParams';import{useDispatch}from'react-redux';import{disableRefetch,removeFromMenu,setMenuData}from'redux/slices/menu';import getDefaultLocation from'helpers/getDefaultLocation';import moment from'moment';import parcelOrderService from'services/parcelOrder';import{fetchParcelOrders}from'redux/slices/parcelOrders';import{toast}from'react-toastify';import createImage from'helpers/createImage';import Loading from'components/loading';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const{Step}=Steps;export default function ParcelOrderEdit(){var _queryParams$values,_activeMenu$data,_activeMenu$data2,_activeMenu$data3,_activeMenu$data3$loc,_activeMenu$data4,_activeMenu$data4$loc,_activeMenu$data5,_activeMenu$data6,_activeMenu$data6$loc,_activeMenu$data7,_activeMenu$data7$loc;const{t}=useTranslation();const[form]=Form.useForm();const{id}=useParams();const queryParams=useQueryParams();const dispatch=useDispatch();const navigate=useNavigate();const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{settings}=useSelector(state=>state.globalSettings,shallowEqual);const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const current=Number(((_queryParams$values=queryParams.values)===null||_queryParams$values===void 0?void 0:_queryParams$values.step)||0);const[loading,setLoading]=useState(false);const[loadingBtn,setLoadingBtn]=useState(false);const[image,setImage]=useState((activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.images)||[]);const[locationFrom,setLocationFrom]=useState(activeMenu!==null&&activeMenu!==void 0&&(_activeMenu$data2=activeMenu.data)!==null&&_activeMenu$data2!==void 0&&_activeMenu$data2.location_from?{lat:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:(_activeMenu$data3$loc=_activeMenu$data3.location_from)===null||_activeMenu$data3$loc===void 0?void 0:_activeMenu$data3$loc.latitude),lng:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:(_activeMenu$data4$loc=_activeMenu$data4.location_from)===null||_activeMenu$data4$loc===void 0?void 0:_activeMenu$data4$loc.longitude)}:getDefaultLocation(settings));const[locationTo,setLocationTo]=useState(activeMenu!==null&&activeMenu!==void 0&&(_activeMenu$data5=activeMenu.data)!==null&&_activeMenu$data5!==void 0&&_activeMenu$data5.location_to?{lat:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:(_activeMenu$data6$loc=_activeMenu$data6.location_to)===null||_activeMenu$data6$loc===void 0?void 0:_activeMenu$data6$loc.latitude),lng:parseFloat(activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data7=activeMenu.data)===null||_activeMenu$data7===void 0?void 0:(_activeMenu$data7$loc=_activeMenu$data7.location_to)===null||_activeMenu$data7$loc===void 0?void 0:_activeMenu$data7$loc.longitude)}:getDefaultLocation(settings));useEffect(()=>{return()=>{const values=form.getFieldsValue(true);const date=JSON.stringify(values.delivery_date);const time=JSON.stringify(values.delivery_time);const data={...values,date,time};dispatch(setMenuData({activeMenu,data}));};},[]);const next=()=>{const step=current+1;queryParams.set('step',step);};const prev=()=>{const step=current-1;queryParams.set('step',step);};const onChange=step=>{queryParams.set('step',step);};const fetchParcel=id=>{setLoading(true);parcelOrderService.getById(id).then(res=>{var _data$address_from,_data$address_from2,_data$address_to,_data$address_to2,_data$address_from3,_data$address_to3,_data$address_from4,_data$address_to4,_data$address_from5,_data$address_to5,_data$address_from6,_data$address_to6,_data$user,_data$user2,_data$user3,_data$user4,_data$type,_data$type2,_data$type3,_data$transaction,_data$transaction2,_data$transaction2$pa,_data$transaction3,_data$transaction3$pa;let data=res.data;setImage([createImage(data.img)]);setLocationFrom({lat:data===null||data===void 0?void 0:(_data$address_from=data.address_from)===null||_data$address_from===void 0?void 0:_data$address_from.latitude,lng:data===null||data===void 0?void 0:(_data$address_from2=data.address_from)===null||_data$address_from2===void 0?void 0:_data$address_from2.longitude});setLocationTo({lat:data===null||data===void 0?void 0:(_data$address_to=data.address_to)===null||_data$address_to===void 0?void 0:_data$address_to.latitude,lng:data===null||data===void 0?void 0:(_data$address_to2=data.address_to)===null||_data$address_to2===void 0?void 0:_data$address_to2.longitude});const body={...data,image:[createImage(data.img)],delivery_time:!!(data!==null&&data!==void 0&&data.delivery_date)?moment(data===null||data===void 0?void 0:data.delivery_date,'YYYY-MM-DD HH:mm:ss'):null,delivery_date:!!(data!==null&&data!==void 0&&data.delivery_date)?moment(data.delivery_date,'YYYY-MM-DD'):null,address_from:data===null||data===void 0?void 0:(_data$address_from3=data.address_from)===null||_data$address_from3===void 0?void 0:_data$address_from3.address,address_to:data===null||data===void 0?void 0:(_data$address_to3=data.address_to)===null||_data$address_to3===void 0?void 0:_data$address_to3.address,house_from:data===null||data===void 0?void 0:(_data$address_from4=data.address_from)===null||_data$address_from4===void 0?void 0:_data$address_from4.house,house_to:data===null||data===void 0?void 0:(_data$address_to4=data.address_to)===null||_data$address_to4===void 0?void 0:_data$address_to4.house,stage_from:data===null||data===void 0?void 0:(_data$address_from5=data.address_from)===null||_data$address_from5===void 0?void 0:_data$address_from5.stage,stage_to:data===null||data===void 0?void 0:(_data$address_to5=data.address_to)===null||_data$address_to5===void 0?void 0:_data$address_to5.stage,room_from:data===null||data===void 0?void 0:(_data$address_from6=data.address_from)===null||_data$address_from6===void 0?void 0:_data$address_from6.room,room_to:data===null||data===void 0?void 0:(_data$address_to6=data.address_to)===null||_data$address_to6===void 0?void 0:_data$address_to6.room,user_from:{label:[(_data$user=data.user)===null||_data$user===void 0?void 0:_data$user.firstname,(_data$user2=data.user)===null||_data$user2===void 0?void 0:_data$user2.lastname].join(' '),value:(_data$user3=data.user)===null||_data$user3===void 0?void 0:_data$user3.id,key:(_data$user4=data.user)===null||_data$user4===void 0?void 0:_data$user4.id},type:{label:(_data$type=data.type)===null||_data$type===void 0?void 0:_data$type.type,value:(_data$type2=data.type)===null||_data$type2===void 0?void 0:_data$type2.id,key:(_data$type3=data.type)===null||_data$type3===void 0?void 0:_data$type3.id},payment_type:{label:t(data===null||data===void 0?void 0:(_data$transaction=data.transaction)===null||_data$transaction===void 0?void 0:_data$transaction.payment_system.tag),value:data===null||data===void 0?void 0:(_data$transaction2=data.transaction)===null||_data$transaction2===void 0?void 0:(_data$transaction2$pa=_data$transaction2.payment_system)===null||_data$transaction2$pa===void 0?void 0:_data$transaction2$pa.id,key:data===null||data===void 0?void 0:(_data$transaction3=data.transaction)===null||_data$transaction3===void 0?void 0:(_data$transaction3$pa=_data$transaction3.payment_system)===null||_data$transaction3$pa===void 0?void 0:_data$transaction3$pa.id}};form.setFieldsValue(body);dispatch(setMenuData({activeMenu,data:body}));}).finally(()=>{setLoading(false);dispatch(disableRefetch(activeMenu));});};useEffect(()=>{if(activeMenu.refetch&&id){fetchParcel(id);}},[activeMenu.refetch]);const onFinish=values=>{var _moment$format,_values$user_from,_values$type;setLoadingBtn(true);const deliveryTime=(_moment$format=moment(values.delivery_time,'HH:mm').format('HH:mm'))===null||_moment$format===void 0?void 0:_moment$format.split(':');const deliveryDate=new Date(values.delivery_date);deliveryDate.setHours(Number(deliveryTime[0]));deliveryDate.setMinutes(Number(deliveryTime[1]));const payload={user_id:(_values$user_from=values.user_from)===null||_values$user_from===void 0?void 0:_values$user_from.value,currency_id:defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.id,type_id:(_values$type=values.type)===null||_values$type===void 0?void 0:_values$type.value,rate:defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.rate,phone_from:values.phone_from.toString(),username_from:values.username_from,address_from:{longitude:locationFrom===null||locationFrom===void 0?void 0:locationFrom.lng,latitude:locationFrom===null||locationFrom===void 0?void 0:locationFrom.lat,address:values.address_from,house:values.house_from,stage:values.stage_from,room:values.room_from},phone_to:values.phone_to.toString(),username_to:values.username_to,address_to:{longitude:locationTo===null||locationTo===void 0?void 0:locationTo.lng,latitude:locationTo===null||locationTo===void 0?void 0:locationTo.lat,address:values.address_to,house:values.house_to,stage:values.stage_to,room:values.room_to},delivery_date:moment(deliveryDate).format('YYYY-MM-DD HH:mm'),// delivery_time: moment(values.delivery_time, 'HH:mm').format('HH:mm'),\nnote:values.note,images:image.map(item=>item.name)};const nextUrl='parcel-orders';parcelOrderService.update(id,payload).then(()=>{dispatch(fetchParcelOrders());toast.success(t('successfully.created'));dispatch(removeFromMenu({...activeMenu,nextUrl}));navigate(`/${nextUrl}`);}).finally(()=>setLoadingBtn(false));};const onFinishFailed=event=>{const steps=['','',''];const fields=event.errorFields.map(item=>item.name[0]);fields.forEach(el=>{if(el.includes('_from')){steps[0]='sender.details.invalid';return;}if(el.includes('_to')){steps[1]='receiver.details.invalid';return;}steps[2]='parcel.details.invalid';});steps.forEach(item=>{if(item)toast.error(t(item));});};return/*#__PURE__*/_jsxs(Card,{title:!!id?t('edit.parcel.order'):t('add.parcel.order'),extra:/*#__PURE__*/_jsx(LanguageList,{}),children:[/*#__PURE__*/_jsx(Steps,{current:current,onChange:onChange,children:steps.map(item=>/*#__PURE__*/_jsx(Step,{title:t(item.title)},item.title))}),/*#__PURE__*/_jsx(\"div\",{className:\"steps-content\",children:!loading?/*#__PURE__*/_jsxs(Form,{form:form,name:\"parcel-create\",layout:\"vertical\",onFinish:onFinish,initialValues:{...activeMenu.data},onFinishFailed:onFinishFailed,children:[/*#__PURE__*/_jsx(\"div\",{className:steps[current].content==='First-content'?'':'d-none',children:/*#__PURE__*/_jsx(ParcelSender,{form:form,next:next,location:locationFrom,setLocation:setLocationFrom})}),/*#__PURE__*/_jsx(\"div\",{className:steps[current].content==='Second-content'?'':'d-none',children:/*#__PURE__*/_jsx(ParcelReceiver,{form:form,next:next,prev:prev,location:locationTo,setLocation:setLocationTo})}),/*#__PURE__*/_jsx(\"div\",{className:steps[current].content==='Third-content'?'':'d-none',children:/*#__PURE__*/_jsx(ParcelDetails,{form:form,loading:loadingBtn,prev:prev,locationFrom:locationFrom,locationTo:locationTo,image:image,setImage:setImage})})]}):/*#__PURE__*/_jsx(Loading,{})})]});}","map":null,"metadata":{},"sourceType":"module"}