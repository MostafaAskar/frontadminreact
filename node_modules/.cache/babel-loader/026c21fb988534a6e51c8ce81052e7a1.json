{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Button,Space,Table,Card,DatePicker,Row,Col}from'antd';import{useNavigate,useParams}from'react-router-dom';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addMenu,disableRefetch,setMenuData}from'../../redux/slices/menu';import{useTranslation}from'react-i18next';import useDidUpdate from'../../helpers/useDidUpdate';import formatSortType from'../../helpers/formatSortType';import numberToPrice from'../../helpers/numberToPrice';import{DebounceSelect}from'../../components/search';import userService from'../../services/user';import{toast}from'react-toastify';import moment from'moment';import shopService from'../../services/restaurant';import{fetchPaymentToPartnersList}from'redux/slices/paymentToPartners';import paymentToPartnerService from'services/payment-to-partner';import PaymentPartnersConfirmation from'./payment-type';import StatisticNumberWidget from'views/dashboard/statisticNumberWidget';import{nFormatter}from'helpers/nFormatter';import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const{RangePicker}=DatePicker;export default function PaymentToPartnersList(){var _activeMenu$data,_activeMenu$data2,_dateRange$,_dateRange$2,_activeMenu$data3,_activeMenu$data4,_activeMenu$data5;const{type}=useParams();const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const[confirmationModalOpen,setConfirmationModalOpen]=useState(false);const goToShow=id=>{dispatch(addMenu({url:`order/details/${id}`,id:'order_details',name:t('order.details')}));navigate(`/order/details/${id}`);};const columns=[{title:t('id'),is_show:true,dataIndex:'id',key:'id',sorter:true,render:id=>/*#__PURE__*/_jsxs(\"span\",{className:\"text-hover\",onClick:()=>goToShow(id),children:[\"#\",id]})},{title:t(type),is_show:true,dataIndex:'user',key:'user',render:(_,row)=>{var _row$shop;const user=type==='seller'?row===null||row===void 0?void 0:(_row$shop=row.shop)===null||_row$shop===void 0?void 0:_row$shop.seller:row.deliveryman;return/*#__PURE__*/_jsxs(\"div\",{children:[user===null||user===void 0?void 0:user.firstname,\" \",(user===null||user===void 0?void 0:user.lastname)||'']});}},{title:t('order.total_price'),is_show:true,dataIndex:'total_price',key:'total_price',render:(total_price,row)=>{var _row$transaction,_row$transaction2;const status=(_row$transaction=row.transaction)===null||_row$transaction===void 0?void 0:_row$transaction.status;return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"span\",{children:numberToPrice(total_price,defaultCurrency.symbol)}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"span\",{className:status==='progress'?'text-primary':status==='paid'?'text-success':status==='rejected'?'text-danger':'text-info',children:(_row$transaction2=row.transaction)===null||_row$transaction2===void 0?void 0:_row$transaction2.status})]});}},...(type==='seller'?[{title:t('coupon.price'),is_show:true,dataIndex:'coupon_price',key:'coupon_price',render:couponPrice=>numberToPrice(couponPrice)}]:[]),...(type==='seller'?[{title:t('total.cashback'),is_show:true,dataIndex:'point_histories',key:'point_histories',render:cashback=>{var _cashback$;return numberToPrice(cashback===null||cashback===void 0?void 0:(_cashback$=cashback[0])===null||_cashback$===void 0?void 0:_cashback$.price);}}]:[]),{title:t('delivery.fee'),is_show:true,dataIndex:'delivery_fee',key:'delivery_fee',render:deliveryFee=>numberToPrice(deliveryFee)},...(type==='seller'?[{title:t('service.fee'),is_show:true,dataIndex:'service_fee',key:'service_fee',render:(_,row)=>numberToPrice((row.service_fee||0)+(row.commission_fee||0))}]:[]),...(type==='seller'?[{title:t('seller.fee'),is_show:true,dataIndex:'seller_fee',key:'seller_fee',render:sellerFee=>numberToPrice(sellerFee)}]:[]),{title:t('payment.type'),is_show:true,dataIndex:'transaction',key:'transaction',render:transaction=>{var _transaction$payment_;return t(transaction===null||transaction===void 0?void 0:(_transaction$payment_=transaction.payment_system)===null||_transaction$payment_===void 0?void 0:_transaction$payment_.tag)||'-';}}];const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const[id,setId]=useState(null);const[loadingBtn,setLoadingBtn]=useState(false);const[dateRange,setDateRange]=useState(moment().subtract(1,'month'),moment());const{list,loading,params,meta}=useSelector(state=>state.paymentToPartners,shallowEqual);const data=activeMenu.data;const paramsData={search:data===null||data===void 0?void 0:data.search,sort:data===null||data===void 0?void 0:data.sort,column:data===null||data===void 0?void 0:data.column,perPage:data===null||data===void 0?void 0:data.perPage,page:data===null||data===void 0?void 0:data.page,user_id:data===null||data===void 0?void 0:data.user_id,shop_id:((_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.shop_id)!==null?(_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:_activeMenu$data2.shop_id:null,date_from:Array.isArray(dateRange)?(_dateRange$=dateRange[0])===null||_dateRange$===void 0?void 0:_dateRange$.format('YYYY-MM-DD'):moment().subtract(1,'month').format('YYYY-MM-DD'),date_to:Array.isArray(dateRange)?(_dateRange$2=dateRange[1])===null||_dateRange$2===void 0?void 0:_dateRange$2.format('YYYY-MM-DD'):moment().format('YYYY-MM-DD'),type};function onChangePagination(pagination,filters,sorter){const{pageSize:perPage,current:page}=pagination;const{field:column,order}=sorter;const sort=formatSortType(order);dispatch(setMenuData({activeMenu,data:{...data,perPage,page,column,sort}}));}async function getUsers(search){const params={search,perPage:10,role:type};return userService.search(params).then(_ref=>{let{data}=_ref;return data.map(item=>({label:`${item.firstname} ${item.lastname}`,value:item.id}));});}const payToUser=paymentId=>{setLoadingBtn(true);const params={data:id,type,payment_id:paymentId};paymentToPartnerService.pay(params).then(()=>{toast.success(t('successfully.payed'));dispatch(fetchPaymentToPartnersList(paramsData));}).finally(()=>{setId(null);setLoadingBtn(false);setConfirmationModalOpen(false);});};useDidUpdate(()=>{dispatch(fetchPaymentToPartnersList(paramsData));},[data,dateRange,type]);const handleFilter=(item,name)=>{dispatch(setMenuData({activeMenu,data:{...data,...{[name]:item}}}));};async function fetchShops(search){const params={search,status:'approved'};return shopService.getAll(params).then(_ref2=>{let{data}=_ref2;return data.map(item=>{var _item$translation;return{label:(_item$translation=item.translation)===null||_item$translation===void 0?void 0:_item$translation.title,value:item.id};});});}useEffect(()=>{if(activeMenu!==null&&activeMenu!==void 0&&activeMenu.refetch){dispatch(fetchPaymentToPartnersList(paramsData));dispatch(disableRefetch(activeMenu));}},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.refetch]);const rowSelection={selectedRowKeys:id,onChange:key=>{setId(key);}};useEffect(()=>{return()=>{dispatch(setMenuData({activeMenu,data:{}}));};},[]);return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-content-space-between\",children:[/*#__PURE__*/_jsxs(Space,{wrap:true,className:\"order-filter\",style:{flex:1,width:'100%'},children:[/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.shop'),fetchOptions:fetchShops,style:{width:'100%'},onSelect:shop=>handleFilter(shop.value,'shop_id'),onDeselect:()=>handleFilter(null,'shop_id'),allowClear:true,value:data===null||data===void 0?void 0:data.shop_id}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.user'),fetchOptions:getUsers,onSelect:user=>handleFilter(user.value,'user_id'),onDeselect:()=>handleFilter(null,'user_id'),style:{width:'100%'},value:data===null||data===void 0?void 0:data.user_id}),/*#__PURE__*/_jsx(RangePicker,{value:dateRange,onChange:values=>{handleFilter(prev=>{var _values$,_values$2;return{...prev,...{date_from:values===null||values===void 0?void 0:(_values$=values[0])===null||_values$===void 0?void 0:_values$.format('YYYY-MM-DD'),date_to:values===null||values===void 0?void 0:(_values$2=values[1])===null||_values$2===void 0?void 0:_values$2.format('YYYY-MM-DD')}};});setDateRange(values);},disabledDate:current=>{return current&&current>moment().endOf('day');},style:{width:'100%'}})]}),/*#__PURE__*/_jsx(Button,{type:\"primary\",disabled:!id||id.length===0,onClick:()=>setConfirmationModalOpen(true),children:t('pay')})]})}),/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(Row,{gutter:16,className:\"mt-3\",children:[/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('commission.fee'),value:numberToPrice(list===null||list===void 0?void 0:list.total_commission_fee,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"purple\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('coupon'),value:numberToPrice(list===null||list===void 0?void 0:list.total_coupon,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"red\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('delivery.fee'),value:numberToPrice(!!(list!==null&&list!==void 0&&list.total_delivery_fee)?Math.trunc(list===null||list===void 0?void 0:list.total_delivery_fee):0,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"green\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('point.history'),value:numberToPrice(!!(list!==null&&list!==void 0&&list.total_point_history)?Math.trunc(list===null||list===void 0?void 0:list.total_point_history):0,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"purple\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('price'),value:numberToPrice(!!(list!==null&&list!==void 0&&list.total_price)?Math.trunc(list===null||list===void 0?void 0:list.total_price):0,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"red\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('seller.fee'),value:numberToPrice(!!(list!==null&&list!==void 0&&list.total_seller_fee)?Math.trunc(list===null||list===void 0?void 0:list.total_seller_fee):0,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"purple\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('service.fee'),value:numberToPrice(!!(list!==null&&list!==void 0&&list.total_service_fee)?Math.trunc(list===null||list===void 0?void 0:list.total_service_fee):0,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"red\"})}),/*#__PURE__*/_jsx(Col,{flex:\"0 0 25%\",children:/*#__PURE__*/_jsx(StatisticNumberWidget,{title:t('tax'),value:numberToPrice(!!(list!==null&&list!==void 0&&list.total_tax)?Math.trunc(list===null||list===void 0?void 0:list.total_tax):0,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),color:\"green\"})})]})}),/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsx(Table,{scroll:{x:true},rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(items=>items.is_show),dataSource:list===null||list===void 0?void 0:list.data,loading:loading,pagination:{pageSize:params.perPage,page:((_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:_activeMenu$data3.page)||1,total:meta===null||meta===void 0?void 0:meta.total,defaultCurrent:(_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:_activeMenu$data4.page,current:(_activeMenu$data5=activeMenu.data)===null||_activeMenu$data5===void 0?void 0:_activeMenu$data5.page},rowKey:record=>record===null||record===void 0?void 0:record.id,onChange:onChangePagination})}),confirmationModalOpen&&/*#__PURE__*/_jsx(PaymentPartnersConfirmation,{open:confirmationModalOpen,onCancel:()=>{setConfirmationModalOpen(false);setId(null);},onConfirm:paymentId=>payToUser(paymentId),isPaying:loadingBtn})]});}","map":null,"metadata":{},"sourceType":"module"}