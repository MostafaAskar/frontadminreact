{"ast":null,"code":"import React,{useState,useEffect}from'react';import{Button,Col,Descriptions,Image,Modal,Row,Space,Spin}from'antd';import{shallowEqual,useDispatch,useSelector}from'react-redux';import getImage from'helpers/getImage';import{MinusOutlined,PlusCircleOutlined,PlusOutlined}from'@ant-design/icons';import numberToPrice from'helpers/numberToPrice';import{toast}from'react-toastify';import{useTranslation}from'react-i18next';import{addToCart}from'redux/slices/cart';import numberToQuantity from'helpers/numberToQuantity';import getImageFromStock from'helpers/getImageFromStock';import{getExtras,sortExtras}from'helpers/getExtras';import AddonsItem from'./addons';import productService from'services/product';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function ProductModal(_ref){var _data$translation,_showExtras$extras,_data$unit,_data$unit$translatio;let{extrasModal,setExtrasModal}=_ref;const[loading,setLoading]=useState(false);const[data,setData]=useState({});const{t}=useTranslation();const[currentStock,setCurrentStock]=useState({});const dispatch=useDispatch();const[extras,setExtras]=useState([]);const[stock,setStock]=useState([]);const[extrasIds,setExtrasIds]=useState([]);const[selectedValues,setSelectedValues]=useState([]);const[showExtras,setShowExtras]=useState({extras:[],stock:{id:0,quantity:1,price:0}});const[counter,setCounter]=useState(extrasModal.quantity||data.quantity||data.min_qty);const{currentBag,currency}=useSelector(state=>state.cart,shallowEqual);const handleSubmit=()=>{const orderItem={...data,stock:currentStock,quantity:counter,id:currentStock.id,img:getImageFromStock(currentStock)||data.img,bag_id:currentBag,stockID:currentStock};if(orderItem.quantity>currentStock.quantity){toast.warning(`${t('you.cannot.order.more.than')} ${currentStock.quantity}`);return;}dispatch(addToCart(orderItem));setExtrasModal(null);};const handleExtrasClick=e=>{var _extrasData$extras;const index=extrasIds.findIndex(item=>item.extra_group_id===e.extra_group_id);let array=extrasIds;if(index>-1)array=array.slice(0,index);array.push(e);const nextIds=array.map(item=>item.extra_value_id).join(',');var extrasData=getExtras(nextIds,extras,stock);setShowExtras(extrasData);(_extrasData$extras=extrasData.extras)===null||_extrasData$extras===void 0?void 0:_extrasData$extras.forEach(element=>{const index=extrasIds.findIndex(item=>element[0].extra_group_id!==e.extra_group_id?item.extra_group_id===element[0].extra_group_id:item.extra_group_id===e.extra_group_id);if(element[0].level>=e.level){var itemData=element[0].extra_group_id!==e.extra_group_id?element[0]:e;if(index===-1)array.push(itemData);else{array[index]=itemData;}}});setExtrasIds(array);};function addCounter(){if(counter===(data===null||data===void 0?void 0:data.quantity)){return;}if(counter===data.max_qty){return;}setCounter(prev=>prev+1);}function reduceCounter(){if(counter===1){return;}if(counter<=data.min_qty){return;}setCounter(prev=>prev-1);}const handleChange=item=>{const value=String(item.addon_id);if(selectedValues.includes(value)){setSelectedValues(prev=>prev.filter(el=>el!==value));}else{setSelectedValues(prev=>[...prev,value]);}};const handleCancel=()=>setExtrasModal(false);function calculateTotalPrice(priceKey){var _showExtras$stock;return(showExtras===null||showExtras===void 0?void 0:(_showExtras$stock=showExtras.stock)===null||_showExtras$stock===void 0?void 0:_showExtras$stock[priceKey||'price'])*counter||0;}function addonCalculate(id,quantity){setShowExtras(prev=>({...prev,stock:{...prev.stock,addons:prev.stock.addons.map(addon=>{if(addon.addon_id===id){return{...addon,product:{...addon.product,quantity}};}return addon;})}}));}useEffect(()=>{if(showExtras!==null&&showExtras!==void 0&&showExtras.stock){setCurrentStock({...showExtras.stock,extras:extrasIds});}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[showExtras]);useEffect(()=>{setLoading(true);productService.getById(extrasModal.uuid).then(_ref2=>{var _getExtras$extras;let{data}=_ref2;setData(data);const myData=sortExtras(data,extrasModal===null||extrasModal===void 0?void 0:extrasModal.addons);setExtras(myData.extras);setCounter(extrasModal.quantity||data.quantity||data.min_qty);setStock(myData.stock);setShowExtras(getExtras(extrasIds,myData.extras,myData.stock));(_getExtras$extras=getExtras('',myData.extras,myData.stock).extras)===null||_getExtras$extras===void 0?void 0:_getExtras$extras.forEach(element=>{setExtrasIds(prev=>[...prev,element[0]]);});if(extrasModal!==null&&extrasModal!==void 0&&extrasModal.addons){var _extrasModal$addons;setSelectedValues((extrasModal===null||extrasModal===void 0?void 0:(_extrasModal$addons=extrasModal.addons)===null||_extrasModal$addons===void 0?void 0:_extrasModal$addons.map(addon=>{var _addon$countable;return String((addon===null||addon===void 0?void 0:(_addon$countable=addon.countable)===null||_addon$countable===void 0?void 0:_addon$countable.id)||addon.countable_id);}))||[]);}}).finally(()=>setLoading(false));// eslint-disable-next-line react-hooks/exhaustive-deps\n},[extrasModal.uuid]);return/*#__PURE__*/_jsx(Modal,{visible:!!data,title:data.name,onCancel:handleCancel,footer:[loading?null:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(PlusCircleOutlined,{}),type:\"primary\",onClick:handleSubmit,children:t('add')},'add-product'),/*#__PURE__*/_jsx(Button,{type:\"default\",onClick:handleCancel,children:t('cancel')},'cancel-product')],children:/*#__PURE__*/_jsxs(Spin,{spinning:loading,children:[/*#__PURE__*/_jsxs(Row,{gutter:24,children:[/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(Image,{src:getImage(getImageFromStock(currentStock)||data.img),alt:data.name,height:200,style:{objectFit:'contain'}})}),/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsxs(Descriptions,{title:(_data$translation=data.translation)===null||_data$translation===void 0?void 0:_data$translation.title,children:[/*#__PURE__*/_jsxs(Descriptions.Item,{label:t('price'),span:3,children:[/*#__PURE__*/_jsx(\"div\",{className:currentStock!==null&&currentStock!==void 0&&currentStock.discount?'strike':'',children:numberToPrice(calculateTotalPrice(),currency===null||currency===void 0?void 0:currency.symbol,currency===null||currency===void 0?void 0:currency.position)}),currentStock!==null&&currentStock!==void 0&&currentStock.discount?/*#__PURE__*/_jsx(\"div\",{className:\"ml-2 font-weight-bold\",children:numberToPrice(calculateTotalPrice('total_price'),currency===null||currency===void 0?void 0:currency.symbol,currency===null||currency===void 0?void 0:currency.position)}):'']}),/*#__PURE__*/_jsx(Descriptions.Item,{label:t('in.stock'),span:3,children:numberToQuantity(currentStock===null||currentStock===void 0?void 0:currentStock.quantity,data.unit)}),/*#__PURE__*/_jsx(Descriptions.Item,{label:t('tax'),span:3,children:numberToPrice((currentStock===null||currentStock===void 0?void 0:currentStock.tax)||0,currency===null||currency===void 0?void 0:currency.symbol,currency===null||currency===void 0?void 0:currency.position)})]})})]}),showExtras===null||showExtras===void 0?void 0:(_showExtras$extras=showExtras.extras)===null||_showExtras$extras===void 0?void 0:_showExtras$extras.map((item,idx)=>{var _item$,_item$$group,_item$$group$translat;return/*#__PURE__*/_jsxs(\"div\",{className:\"extra-group\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-3\",children:[item===null||item===void 0?void 0:(_item$=item[0])===null||_item$===void 0?void 0:(_item$$group=_item$.group)===null||_item$$group===void 0?void 0:(_item$$group$translat=_item$$group.translation)===null||_item$$group$translat===void 0?void 0:_item$$group$translat.title,\":\"]}),/*#__PURE__*/_jsx(Space,{className:\"extras-select\",wrap:true,children:item.map(el=>{var _el$group;if((el===null||el===void 0?void 0:(_el$group=el.group)===null||_el$group===void 0?void 0:_el$group.type)==='color'){return/*#__PURE__*/_jsx(\"div\",{className:`extras-color-wrapper rounded ${!!extrasIds.find(extra=>extra.extra_value_id===el.extra_value_id)?'selected':''}`,onClick:()=>handleExtrasClick(el),children:/*#__PURE__*/_jsx(\"div\",{className:\"extras-color\",style:{backgroundColor:el.value.value}})});}return/*#__PURE__*/_jsx(\"span\",{className:`extras-text rounded ${!!extrasIds.find(extra=>extra.extra_value_id===el.extra_value_id)?'selected':''}`,onClick:()=>handleExtrasClick(el),children:el.value.value});})},'extra-group'+idx)]},'extra-group-container'+idx);}),/*#__PURE__*/_jsx(AddonsItem,{showExtras:showExtras,selectedValues:selectedValues,handleChange:handleChange,addonCalculate:addonCalculate}),/*#__PURE__*/_jsx(Row,{gutter:12,className:\"mt-3\",children:/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(MinusOutlined,{}),onClick:reduceCounter}),(counter||1)*((data===null||data===void 0?void 0:data.interval)||1),data===null||data===void 0?void 0:(_data$unit=data.unit)===null||_data$unit===void 0?void 0:(_data$unit$translatio=_data$unit.translation)===null||_data$unit$translatio===void 0?void 0:_data$unit$translatio.title,/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(PlusOutlined,{}),onClick:addCounter})]})})})]})},data===null||data===void 0?void 0:data.id);}","map":null,"metadata":{},"sourceType":"module"}