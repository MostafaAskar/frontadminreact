{"ast":null,"code":"import React,{useEffect,useState,useRef}from'react';import{Button,Col,Form,Modal,Row,Select,Input,Collapse,Divider}from'antd';import{shallowEqual,useSelector}from'react-redux';import{useTranslation}from'react-i18next';import orderService from'services/seller/order';import Loading from'components/loading';import LanguageList from'components/language-list';import{EditOutlined,SendOutlined}from'@ant-design/icons';import moment from'moment';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const{Panel}=Collapse;export default function OrderStatusModal(_ref){var _data$notes2;let{orderId,handleCancel,refetchPage}=_ref;const{statusList}=useSelector(state=>state.orderStatus,shallowEqual);const{defaultLang,languages}=useSelector(state=>state.formLang,shallowEqual);const[form]=Form.useForm();const{t}=useTranslation();const changeInputRef=useRef(null);const[loading,setLoading]=useState(false);const[loadingBtn,setLoadingBtn]=useState(false);const[statuses,setStatuses]=useState(!!(statusList!==null&&statusList!==void 0&&statusList.length)?statusList.map(item=>({value:item===null||item===void 0?void 0:item.name,label:t(item===null||item===void 0?void 0:item.name),key:item===null||item===void 0?void 0:item.id})):[]);const[data,setData]=useState(null);const[notes,setNotes]=useState(null);const[changeNote,setChangeNote]=useState(null);const[status,setStatus]=useState(null);const fetchOrderById=()=>{setLoading(true);orderService.getById(orderId).then(res=>{var _res$data,_res$data$notes,_res$data2,_res$data3;setData(res.data);setNotes((_res$data=res.data)===null||_res$data===void 0?void 0:(_res$data$notes=_res$data.notes)===null||_res$data$notes===void 0?void 0:_res$data$notes.filter(item=>{var _item$notes;return!!(item!==null&&item!==void 0&&(_item$notes=item.notes)!==null&&_item$notes!==void 0&&_item$notes.length);}));setStatus((_res$data2=res.data)===null||_res$data2===void 0?void 0:_res$data2.status);form.setFieldsValue({status:res===null||res===void 0?void 0:(_res$data3=res.data)===null||_res$data3===void 0?void 0:_res$data3.status});}).finally(()=>setLoading(false));};useEffect(()=>{fetchOrderById();},[orderId]);useEffect(()=>{var _statusList,_statusList$statusInd;if((data===null||data===void 0?void 0:data.status)==='pause'){setStatuses(statusList===null||statusList===void 0?void 0:statusList.map(item=>({value:item===null||item===void 0?void 0:item.name,label:t(item===null||item===void 0?void 0:item.name),key:item===null||item===void 0?void 0:item.id})));return;}const statusIndex=statusList.findIndex(item=>item.name===(data===null||data===void 0?void 0:data.status));const newStatuses=statusIndex>=0?[statusList[statusIndex],statusIndex<statusList.length-1?((_statusList=statusList[statusIndex+1])===null||_statusList===void 0?void 0:_statusList.name)==='pause'?statusList[statusIndex+2]:statusList[statusIndex+1]:null]:[statusIndex<statusList.length-1?statusList[statusIndex+1]:null];if(((_statusList$statusInd=statusList[statusIndex])===null||_statusList$statusInd===void 0?void 0:_statusList$statusInd.name)==='on_a_way'){newStatuses.push(statusList[statusIndex+3]);}if(statusList!==null&&statusList!==void 0&&statusList.filter(item=>(item===null||item===void 0?void 0:item.name)==='pause'&&(item===null||item===void 0?void 0:item.active))){var _statusList$filter;newStatuses===null||newStatuses===void 0?void 0:newStatuses.push(statusList===null||statusList===void 0?void 0:(_statusList$filter=statusList.filter(item=>(item===null||item===void 0?void 0:item.name)==='pause'&&(item===null||item===void 0?void 0:item.active)))===null||_statusList$filter===void 0?void 0:_statusList$filter[0]);}newStatuses.push({name:'canceled',id:8,active:true,sort:(statusList===null||statusList===void 0?void 0:statusList.length)+1});setStatuses(newStatuses.filter(Boolean).map(item=>({value:item===null||item===void 0?void 0:item.name,label:t(item===null||item===void 0?void 0:item.name),key:item===null||item===void 0?void 0:item.id})));// Remove null values\n},[data]);const removeUndefinedValues=obj=>{const filteredEntries=Object.entries(obj).filter(_ref2=>{let[_,value]=_ref2;return!!value;});if((filteredEntries===null||filteredEntries===void 0?void 0:filteredEntries.length)===0){return;}return Object.fromEntries(filteredEntries);};const onFinish=values=>{var _data$notes;let updatedNoteTitle=null;setLoadingBtn(true);if(!!changeNote&&(values===null||values===void 0?void 0:values.status)===(data===null||data===void 0?void 0:data.status)){updatedNoteTitle={...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`title[${lang.locale}]`]})))};updatedNoteTitle=removeUndefinedValues(updatedNoteTitle);}const currentNotes=removeUndefinedValues({...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`note[${lang.locale}]`]})))});const title=!!currentNotes?{title:currentNotes}:null;const previousNotes=(data===null||data===void 0?void 0:data.status)===(values===null||values===void 0?void 0:values.status)?data===null||data===void 0?void 0:(_data$notes=data.notes)===null||_data$notes===void 0?void 0:_data$notes.filter(item=>(item===null||item===void 0?void 0:item.status)===(values===null||values===void 0?void 0:values.status)).flatMap(item=>{var _item$notes2;return item===null||item===void 0?void 0:(_item$notes2=item.notes)===null||_item$notes2===void 0?void 0:_item$notes2.map((note,index)=>index===(changeNote===null||changeNote===void 0?void 0:changeNote.index)?{...note,title:{...(note===null||note===void 0?void 0:note.title),...updatedNoteTitle}}:note);}).filter(Boolean):[];const params={status:values===null||values===void 0?void 0:values.status,notes:[...previousNotes,title].filter(Boolean)};orderService.updateStatus(data.id,params).then(()=>{handleCancel();refetchPage();}).finally(()=>setLoadingBtn(false));};useEffect(()=>{var _changeNote$title;form.setFieldsValue({[`title[${defaultLang||'en'}]`]:changeNote===null||changeNote===void 0?void 0:(_changeNote$title=changeNote.title)===null||_changeNote$title===void 0?void 0:_changeNote$title[defaultLang||'en']});},[defaultLang]);return/*#__PURE__*/_jsx(Modal,{visible:!!orderId,title:[t('order.status')],onCancel:handleCancel,footer:[/*#__PURE__*/_jsx(Button,{type:\"primary\",onClick:()=>form.submit(),loading:loadingBtn,children:t('save')},'save-form'),/*#__PURE__*/_jsx(Button,{type:\"default\",onClick:handleCancel,children:t('cancel')},'cansel-modal')],children:!loading?/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsxs(Form,{form:form,layout:\"vertical\",onFinish:onFinish,name:\"order-status-change-form\",children:[/*#__PURE__*/_jsx(Row,{gutter:12,style:{marginBottom:'20px'},children:/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(LanguageList,{})})}),!!(data!==null&&data!==void 0&&(_data$notes2=data.notes)!==null&&_data$notes2!==void 0&&_data$notes2.some(item=>{var _item$notes3;return!!(item!==null&&item!==void 0&&(_item$notes3=item.notes)!==null&&_item$notes3!==void 0&&_item$notes3.length);}))&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Collapse,{children:notes===null||notes===void 0?void 0:notes.map(item=>{var _item$notes4;return/*#__PURE__*/_jsx(Panel,{header:t(item===null||item===void 0?void 0:item.status),children:(item===null||item===void 0?void 0:(_item$notes4=item.notes)===null||_item$notes4===void 0?void 0:_item$notes4.map((note,index)=>{var _note$title,_note$title2,_note$title3;return/*#__PURE__*/_jsxs(Row,{style:{marginBottom:'15px',display:'flex',justifyContent:'space-between'},gutter:12,children:[/*#__PURE__*/_jsxs(Col,{span:(item===null||item===void 0?void 0:item.status)===(data===null||data===void 0?void 0:data.status)&&status===(data===null||data===void 0?void 0:data.status)?22:24,children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',columnGap:'10px'},children:[/*#__PURE__*/_jsxs(\"span\",{style:{marginTop:'3px'},children:[index+1,\".\",' ']}),/*#__PURE__*/_jsxs(\"div\",{style:{width:'100%'},children:[/*#__PURE__*/_jsx(\"p\",{style:{margin:0,fontSize:'15px',wordBreak:'break-all'},hidden:(changeNote===null||changeNote===void 0?void 0:changeNote.orderId)===(item===null||item===void 0?void 0:item.id)&&(changeNote===null||changeNote===void 0?void 0:changeNote.index)===index&&(data===null||data===void 0?void 0:data.status)===status,children:(note===null||note===void 0?void 0:(_note$title=note.title)===null||_note$title===void 0?void 0:_note$title[defaultLang||'en'])||'--'}),/*#__PURE__*/_jsx(Form.Item,{name:`title[${defaultLang||'en'}]`,hidden:(changeNote===null||changeNote===void 0?void 0:changeNote.orderId)!==(item===null||item===void 0?void 0:item.id)||(changeNote===null||changeNote===void 0?void 0:changeNote.index)!==index||(data===null||data===void 0?void 0:data.status)!==status,children:/*#__PURE__*/_jsx(Input.TextArea,{maxLength:200,style:{width:'100%'},rows:Math.floor((note===null||note===void 0?void 0:(_note$title2=note.title)===null||_note$title2===void 0?void 0:(_note$title3=_note$title2[defaultLang||'en'])===null||_note$title3===void 0?void 0:_note$title3.length)/41||0)+1// defaultValue={\n//   note.title?.[defaultLang || 'en']\n// }\n,ref:changeInputRef},index)})]})]}),/*#__PURE__*/_jsx(\"p\",{style:{fontSize:'12px',margin:0,float:'right'},children:moment(note===null||note===void 0?void 0:note.created_at).format('DD-MM-YYYY HH:mm')})]}),(item===null||item===void 0?void 0:item.status)===(data===null||data===void 0?void 0:data.status)&&(data===null||data===void 0?void 0:data.status)===status&&/*#__PURE__*/_jsx(Col,{span:2,children:(changeNote===null||changeNote===void 0?void 0:changeNote.orderId)===(item===null||item===void 0?void 0:item.id)&&index===(changeNote===null||changeNote===void 0?void 0:changeNote.index)?/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(SendOutlined,{}),size:'small',onClick:()=>form.submit(),loading:loadingBtn}):(item===null||item===void 0?void 0:item.status)===(data===null||data===void 0?void 0:data.status)&&/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(EditOutlined,{}),size:\"small\",onClick:()=>{var _note$title4;changeInputRef.current.focus();setChangeNote({orderId:item===null||item===void 0?void 0:item.id,index:index,title:note===null||note===void 0?void 0:note.title});form.setFieldsValue({[`title[${defaultLang||'en'}]`]:note===null||note===void 0?void 0:(_note$title4=note.title)===null||_note$title4===void 0?void 0:_note$title4[defaultLang||'en']});}})})]},index);}))||'--'},item===null||item===void 0?void 0:item.id);})}),/*#__PURE__*/_jsx(Divider,{})]}),/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('status'),name:\"status\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(Select,{options:statuses,onSelect:item=>setStatus(item)})})}),/*#__PURE__*/_jsx(Col,{span:24,children:languages.map(item=>/*#__PURE__*/_jsx(Form.Item,{name:`note[${item===null||item===void 0?void 0:item.locale}]`,label:t('note'),hidden:(item===null||item===void 0?void 0:item.locale)!==defaultLang,children:/*#__PURE__*/_jsx(Input.TextArea,{maxLength:200})},`note_${item===null||item===void 0?void 0:item.id}`))})]})]})}):/*#__PURE__*/_jsx(Loading,{})});}","map":null,"metadata":{},"sourceType":"module"}