{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Button,Card,Col,Form,Row,Select,Space,Spin,InputNumber}from'antd';import{useTranslation}from'react-i18next';import{DebounceSelect}from'components/search';import{CloseOutlined,PlusOutlined,ShoppingCartOutlined,UserAddOutlined}from'@ant-design/icons';import{shallowEqual,useDispatch,useSelector}from'react-redux';import userService from'services/seller/user';import{isArray}from'lodash';import{addBag,removeBag,setCartData,setCurrency,setCurrentBag}from'redux/slices/cart';import{AsyncSelect}from'components/async-select';import{getCartData}from'redux/selectors/cartSelector';import UserAddModal from'./user-add-modal';import restPaymentService from'services/rest/payment';import DeliveryInfo from'./delivery-info';import{useLocation}from'react-router-dom';import moment from'moment';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function OrderTabs(){var _locat$state;const{t}=useTranslation();const[form]=Form.useForm();const dispatch=useDispatch();const{currencies,loading}=useSelector(state=>state.currency,shallowEqual);const{currentBag,bags,currency}=useSelector(state=>state.cart,shallowEqual);const{before_order_phone_required}=useSelector(state=>state.globalSettings.settings,shallowEqual);const locat=useLocation();const delivery_type=locat===null||locat===void 0?void 0:(_locat$state=locat.state)===null||_locat$state===void 0?void 0:_locat$state.delivery_type;const data=useSelector(state=>getCartData(state.cart));const[users,setUsers]=useState([]);const[userModal,setUserModal]=useState(null);const[userPhoneNumber,setUserPhoneNumber]=useState(null);async function getUsers(search){const params={search,perPage:10};return userService.getAll(params).then(_ref=>{let{data}=_ref;setUsers(data);return formatUser(data);});}function formatUser(data){if(!data)return;if(isArray(data)){return data.map(item=>({label:`${(item===null||item===void 0?void 0:item.firstname)||''} ${(item===null||item===void 0?void 0:item.lastname)||''}`,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id}));}else{return{label:`${(data===null||data===void 0?void 0:data.firstname)||''} ${(data===null||data===void 0?void 0:data.lastname)||''}`,value:data===null||data===void 0?void 0:data.id,key:data===null||data===void 0?void 0:data.id};}}function selectUser(userObj){const user=users.find(item=>item.id===userObj.value);dispatch(setCartData({user:userObj,userUuid:user.uuid,bag_id:currentBag,phone:user===null||user===void 0?void 0:user.phone}));setUserPhoneNumber(user===null||user===void 0?void 0:user.phone);form.setFieldsValue({address:null,phone:user===null||user===void 0?void 0:user.phone});}const goToAddClient=()=>{setUserModal(true);};const closeTab=(event,item)=>{event.preventDefault();event.stopPropagation();dispatch(removeBag(item));};function selectCurrency(item){const data=currencies.find(el=>el.id===item.value);dispatch(setCurrency(data));}useEffect(()=>{if(!currency){const currentCurrency=currencies.find(item=>item.default);const formCurrency={label:`${currentCurrency===null||currentCurrency===void 0?void 0:currentCurrency.title} (${currentCurrency===null||currentCurrency===void 0?void 0:currentCurrency.symbol})`,value:currentCurrency===null||currentCurrency===void 0?void 0:currentCurrency.id,key:currentCurrency===null||currentCurrency===void 0?void 0:currentCurrency.id};dispatch(setCartData({currentCurrency,bag_id:currentBag}));dispatch(setCurrency(currentCurrency));form.setFieldsValue({currency:formCurrency});}else{const formCurrency={label:`${currency===null||currency===void 0?void 0:currency.title} (${currency===null||currency===void 0?void 0:currency.symbol})`,value:currency===null||currency===void 0?void 0:currency.id,key:currency===null||currency===void 0?void 0:currency.id};dispatch(setCartData({formCurrency,bag_id:currentBag}));form.setFieldsValue({currency:formCurrency});}},[]);useEffect(()=>{form.setFieldsValue({user:data.user||null,payment_type:data.paymentType||null,address:data.address?{value:data.address.value,label:data.address.label}:null,delivery:data.deliveries||null,delivery_time:data!==null&&data!==void 0&&data.delivery_time?moment(`${data===null||data===void 0?void 0:data.delivery_date} ${data===null||data===void 0?void 0:data.delivery_time}`):null,delivery_date:data!==null&&data!==void 0&&data.delivery_date?moment(data===null||data===void 0?void 0:data.delivery_date):null,delivery_point:(data===null||data===void 0?void 0:data.delivery_point)||null,country:(data===null||data===void 0?void 0:data.country)||null,city:(data===null||data===void 0?void 0:data.city)||null,phone:(data===null||data===void 0?void 0:data.phone)||null,home_number:(data===null||data===void 0?void 0:data.street_house_number)||null,zip_code:(data===null||data===void 0?void 0:data.zip_code)||null});},[currentBag,data]);async function fetchPaymentList(){return restPaymentService.getAll().then(_ref2=>{let{data}=_ref2;return data.filter(el=>el.tag==='cash'||el.tag==='wallet').map(item=>({label:t(item===null||item===void 0?void 0:item.tag)||t('no.name'),value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id}));});}return/*#__PURE__*/_jsxs(\"div\",{className:\"order-tabs\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"tabs-container\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"tabs\",children:bags.map(item=>/*#__PURE__*/_jsx(\"div\",{className:item===currentBag?'tab active':'tab',onClick:()=>dispatch(setCurrentBag(item)),children:/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(ShoppingCartOutlined,{}),/*#__PURE__*/_jsxs(\"span\",{children:[t('bag'),\" - \",item+1]}),item&&item===currentBag?/*#__PURE__*/_jsx(CloseOutlined,{onClick:event=>closeTab(event,item),className:\"close-button\",size:12}):'']})},'tab'+item))}),/*#__PURE__*/_jsx(Button,{size:\"small\",type:\"primary\",shape:\"circle\",icon:/*#__PURE__*/_jsx(PlusOutlined,{}),className:\"tab-add-button\",onClick:()=>dispatch(addBag())})]}),/*#__PURE__*/_jsxs(Form,{layout:\"vertical\",name:\"pos-form\",form:form,children:[/*#__PURE__*/_jsxs(Card,{className:!!currentBag?'':'tab-card',children:[loading&&/*#__PURE__*/_jsx(\"div\",{className:\"loader\",children:/*#__PURE__*/_jsx(Spin,{})}),/*#__PURE__*/_jsxs(Row,{gutter:6,style:{marginBottom:15},children:[/*#__PURE__*/_jsx(Col,{span:21,children:/*#__PURE__*/_jsx(Form.Item,{name:\"user\",rules:[{required:true,message:''}],className:\"w-100\",children:/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.client'),fetchOptions:getUsers,onSelect:selectUser,onClear:()=>{form.setFieldsValue({phone:null,user:null});}})})}),/*#__PURE__*/_jsx(Col,{span:3,children:/*#__PURE__*/_jsx(Form.Item,{children:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(UserAddOutlined,{}),onClick:goToAddClient})})}),before_order_phone_required==='1'&&/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{name:\"phone\",rules:[{required:true,message:t('required')},{validator(_,value){if(value<0){return Promise.reject(new Error(t('must.be.positive')));}}}],children:/*#__PURE__*/_jsx(InputNumber,{className:\"w-100\",placeholder:t('phone.number'),disabled:userPhoneNumber,onChange:phone=>dispatch(setCartData({phone:phone,bag_id:currentBag}))})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{name:\"currency\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(Select,{placeholder:t('select.currency'),onSelect:selectCurrency,labelInValue:true,disabled:true,children:currencies===null||currencies===void 0?void 0:currencies.map((item,index)=>/*#__PURE__*/_jsx(Select.Option,{value:item===null||item===void 0?void 0:item.id,children:`${item===null||item===void 0?void 0:item.title} (${item===null||item===void 0?void 0:item.symbol})`},index))})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{name:\"payment_type\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(AsyncSelect,{fetchOptions:fetchPaymentList,className:\"w-100\",placeholder:t('select.payment.type'),onSelect:paymentType=>{dispatch(setCartData({paymentType,bag_id:currentBag}));}})})})]})]}),!delivery_type&&/*#__PURE__*/_jsx(DeliveryInfo,{})]}),userModal&&/*#__PURE__*/_jsx(UserAddModal,{visible:userModal,handleCancel:()=>setUserModal(false)})]});}","map":null,"metadata":{},"sourceType":"module"}