{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Form,PageHeader,Row,Col,Button,Spin}from'antd';import UserInfo from'./user-info';import ProductInfo from'./product-info';import PreviewInfo from'./preview-info';import{shallowEqual,useDispatch,useSelector}from'react-redux';import orderService from'services/order';import moment from'moment';import{clearOrder,setOrderCurrency,setOrderData,setOrderItems}from'redux/slices/order';import{useNavigate,useParams}from'react-router-dom';import getImageFromStock from'helpers/getImageFromStock';import{disableRefetch,removeFromMenu}from'redux/slices/menu';import{fetchOrders}from'redux/slices/orders';import{useTranslation}from'react-i18next';import transactionService from'services/transaction';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export default function SellerOrderEdit(){const{t}=useTranslation();const[form]=Form.useForm();const dispatch=useDispatch();const{id}=useParams();const navigate=useNavigate();const[loadingBtn,setLoadingBtn]=useState(false);const[orderId,setOrderId]=useState(null);const[loading,setLoading]=useState(false);const{orderItems,data,total,coupon}=useSelector(state=>state.order,shallowEqual);const{currencies}=useSelector(state=>state.currency,shallowEqual);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);useEffect(()=>{return()=>{const formData=form.getFieldsValue(true);const data={...formData,deliveries:formData.deliveries.map(item=>({...item,delivery_date:item.delivery_date?moment(item.delivery_date).format('YYYY-MM-DD'):undefined}))};dispatch(setOrderData(data));};},[]);function formatUser(user){return{label:user.firstname+' '+(user.lastname||''),value:user.id};}function formatAddress(item){if(!item)return null;return{label:item.address,value:item.id};}function formatPayment(item){if(!item)return null;return{label:item===null||item===void 0?void 0:item.tag,value:item.id};}function fetchOrder(){setLoading(true);orderService.getById(id).then(res=>{var _order$details,_order$transaction;const order=res.data;dispatch(setOrderCurrency(order.currency));const items=(_order$details=order.details)===null||_order$details===void 0?void 0:_order$details.map(el=>({...el.stock.product,...el.stock,quantity:el.quantity,stock:el.stock,img:getImageFromStock(el.stock)||el.stock.product.img,product:undefined}));dispatch(setOrderItems(items));form.setFieldsValue({user:formatUser(order.user),currency_id:order.currency.id,address:formatAddress(order.details[0].delivery_address),payment_type:formatPayment(order===null||order===void 0?void 0:(_order$transaction=order.transaction)===null||_order$transaction===void 0?void 0:_order$transaction.payment_system),note:order.note});}).finally(()=>{setLoading(false);dispatch(disableRefetch(activeMenu));});}useEffect(()=>{if(activeMenu.refetch){fetchOrder();}},[activeMenu.refetch]);function createTransaction(id,data){transactionService.create(id,data).then(res=>{setOrderId(res.data.id);dispatch(clearOrder());}).finally(()=>setLoadingBtn(false));}const orderUpdate=(data,paymentId)=>{const payment={payment_sys_id:paymentId};setLoadingBtn(true);orderService.update(id,data).then(res=>createTransaction(res.data.id,payment)).catch(()=>setLoadingBtn(false));};function formatProducts(list){const addons=list===null||list===void 0?void 0:list.map(item=>{var _item$stockID,_item$stock;return{quantity:item.quantity,stock_id:item.stockID?(_item$stockID=item.stockID)===null||_item$stockID===void 0?void 0:_item$stockID.id:(_item$stock=item.stock)===null||_item$stock===void 0?void 0:_item$stock.id};});const products=list===null||list===void 0?void 0:list.flatMap(item=>{var _item$addons;return(_item$addons=item.addons)===null||_item$addons===void 0?void 0:_item$addons.map(addon=>{var _item$stockID2,_item$stock2;return{quantity:addon.quantity,stock_id:addon.stock_id,parent_id:item.stockID?(_item$stockID2=item.stockID)===null||_item$stockID2===void 0?void 0:_item$stockID2.id:(_item$stock2=item.stock)===null||_item$stock2===void 0?void 0:_item$stock2.id};});});return addons.concat(products);}const onFinish=values=>{var _currencies$find,_values$payment_type,_values$payment_type2;const products=formatProducts(orderItems);const body={currency_id:values.currency_id,rate:(_currencies$find=currencies.find(item=>item.id===values.currency_id))===null||_currencies$find===void 0?void 0:_currencies$find.rate,// shop_id: data.shop.value,\ndelivery_fee:data.delivery_fee,coupon:coupon.coupon,tax:total.order_tax,payment_type:(_values$payment_type=values.payment_type)===null||_values$payment_type===void 0?void 0:_values$payment_type.label,note:values.note,delivery_date:moment(values.delivery_date).format('YYYY-MM-DD')+' '+moment(values.delivery_time).format('HH:mm'),user_id:values.user.value,products:products===null||products===void 0?void 0:products.filter(item=>!!item),status:data===null||data===void 0?void 0:data.status};orderUpdate(body,values===null||values===void 0?void 0:(_values$payment_type2=values.payment_type)===null||_values$payment_type2===void 0?void 0:_values$payment_type2.value);};const handleCloseInvoice=()=>{setOrderId(null);const nextUrl='orders';dispatch(removeFromMenu({...activeMenu,nextUrl}));navigate(`/${nextUrl}`);dispatch(fetchOrders());};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PageHeader,{title:t('edit.order'),extra:/*#__PURE__*/_jsx(Button,{type:\"primary\",loading:loadingBtn,onClick:()=>form.submit(),children:t('save')})}),/*#__PURE__*/_jsxs(Form,{name:\"order-form\",form:form,layout:\"vertical\",onFinish:onFinish,className:\"order-add\",initialValues:{user:data.user||null,address:data.address||null,currency_id:data.currency.id,payment_type:data.payment_type||null,note:data.note},children:[/*#__PURE__*/_jsxs(Row,{gutter:24,hidden:loading,children:[/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsx(ProductInfo,{form:form})}),/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(UserInfo,{form:form})})]}),loading&&/*#__PURE__*/_jsx(\"div\",{className:\"loader\",children:/*#__PURE__*/_jsx(Spin,{})})]}),orderId?/*#__PURE__*/_jsx(PreviewInfo,{orderId:orderId,handleClose:handleCloseInvoice}):'']});}","map":null,"metadata":{},"sourceType":"module"}