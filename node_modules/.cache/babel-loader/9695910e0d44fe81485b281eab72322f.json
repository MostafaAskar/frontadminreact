{"ast":null,"code":"import React,{useState,useEffect}from'react';import{Button,Checkbox,Col,Descriptions,Image,Modal,Row,Space,Spin}from'antd';import{shallowEqual,useDispatch,useSelector}from'react-redux';import getImage from'helpers/getImage';import{MinusOutlined,PlusOutlined}from'@ant-design/icons';import{addOrderItem,setOrderData}from'redux/slices/order';import numberToPrice from'helpers/numberToPrice';import{toast}from'react-toastify';import numberToQuantity from'helpers/numberToQuantity';import{useTranslation}from'react-i18next';import{getExtras,sortExtras}from'helpers/getExtras';import getImageFromStock from'helpers/getImageFromStock';import useDidUpdate from'helpers/useDidUpdate';import productService from'services/product';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function ExtrasModal(_ref){var _data$translation,_data$translation2,_showExtras$extras,_showExtras$stock3,_showExtras$stock3$ad,_data$unit,_data$unit$translatio;let{extrasModal,setExtrasModal}=_ref;const[loading,setLoading]=useState(false);const[data,setData]=useState({});const{t}=useTranslation();const[counter,setCounter]=useState(extrasModal.quantity||data.quantity||data.min_qty);const[currentStock,setCurrentStock]=useState({});const{currency}=useSelector(state=>state.order.data,shallowEqual);const dispatch=useDispatch();const[extras,setExtras]=useState([]);const[stock,setStock]=useState([]);const[showExtras,setShowExtras]=useState({extras:[],stock:{id:0,quantity:1,price:0}});const[extrasIds,setExtrasIds]=useState([]);const[addons,setAddons]=useState([]);const[selectedValues,setSelectedValues]=useState([]);const handleCancel=()=>setExtrasModal(false);const handleSubmit=()=>{const calculate=false;dispatch(setOrderData({calculate}));const products=addons.map(item=>({...item,quantity:item.product.quantity||item.product.min_qty,stock_id:item.product.stock.id}));const orderItem={...data,stock:currentStock,quantity:counter,id:currentStock.id,img:getImageFromStock(currentStock)||data.img,stockID:currentStock,addons:products,price:currentStock.price};if(orderItem.quantity>currentStock.quantity){toast.warning(`${t('you.cannot.order.more.than')} ${currentStock.quantity}`);return;}dispatch(addOrderItem(orderItem));setExtrasModal(null);};function addCounter(){if(counter===data.max_qty){return;}setCounter(prev=>prev+1);}function reduceCounter(){if(counter===1){return;}if(counter<=data.min_qty){return;}setCounter(prev=>prev-1);}const handleExtrasClick=e=>{var _extrasData$extras;const index=extrasIds.findIndex(item=>item.extra_group_id===e.extra_group_id);let array=extrasIds;if(index>-1)array=array.slice(0,index);array.push(e);const nextIds=array.map(item=>item.extra_value_id).join(',');var extrasData=getExtras(nextIds,extras,stock);setShowExtras(extrasData);(_extrasData$extras=extrasData.extras)===null||_extrasData$extras===void 0?void 0:_extrasData$extras.forEach(element=>{const index=extrasIds.findIndex(item=>element[0].extra_group_id!==e.extra_group_id?item.extra_group_id===element[0].extra_group_id:item.extra_group_id===e.extra_group_id);if(element[0].level>=e.level){var itemData=element[0].extra_group_id!==e.extra_group_id?element[0]:e;if(index===-1)array.push(itemData);else{array[index]=itemData;}}});setExtrasIds(array);};useEffect(()=>{if(showExtras!==null&&showExtras!==void 0&&showExtras.stock){setCurrentStock({...showExtras.stock,extras:extrasIds});}},[showExtras]);const handleChange=item=>{const value=String(item.addon_id);if(selectedValues.includes(value)){setSelectedValues(prev=>prev.filter(el=>el!==value));}else{setSelectedValues(prev=>[...prev,value]);}};function handleAddonClick(list){setAddons(list);}useDidUpdate(()=>{var _showExtras$stock,_showExtras$stock$add;const addons=showExtras===null||showExtras===void 0?void 0:(_showExtras$stock=showExtras.stock)===null||_showExtras$stock===void 0?void 0:(_showExtras$stock$add=_showExtras$stock.addons)===null||_showExtras$stock$add===void 0?void 0:_showExtras$stock$add.filter(item=>selectedValues.includes(String(item.addon_id)));handleAddonClick(addons);},[selectedValues]);function calculateTotalPrice(priceKey){var _showExtras$stock2;const addonPrice=addons===null||addons===void 0?void 0:addons.reduce((total,item)=>total+=item.product.stock.price*(item.product.quantity||item.product.min_qty),0);return addonPrice+(showExtras===null||showExtras===void 0?void 0:(_showExtras$stock2=showExtras.stock)===null||_showExtras$stock2===void 0?void 0:_showExtras$stock2[priceKey||'price'])*counter;}function addonCalculate(id,quantity){setShowExtras(prev=>({...prev,stock:{...prev.stock,addons:prev.stock.addons.map(addon=>{if(addon.addon_id===id){return{...addon,product:{...addon.product,quantity}};}return addon;})}}));setAddons(prev=>prev.map(addon=>{if(addon.addon_id===id){return{...addon,product:{...addon.product,quantity}};}return addon;}));}useEffect(()=>{setLoading(true);productService.getById(extrasModal.uuid).then(_ref2=>{var _getExtras$extras;let{data}=_ref2;setData(data);const myData=sortExtras(data,extrasModal===null||extrasModal===void 0?void 0:extrasModal.addons);setExtras(myData.extras);setCounter(extrasModal.quantity||data.quantity||data.min_qty);setStock(myData.stock);setShowExtras(getExtras('',myData.extras,myData.stock));(_getExtras$extras=getExtras('',myData.extras,myData.stock).extras)===null||_getExtras$extras===void 0?void 0:_getExtras$extras.forEach(element=>{setExtrasIds(prev=>[...prev,element[0]]);});if(extrasModal!==null&&extrasModal!==void 0&&extrasModal.addons){var _extrasModal$addons;setSelectedValues((extrasModal===null||extrasModal===void 0?void 0:(_extrasModal$addons=extrasModal.addons)===null||_extrasModal$addons===void 0?void 0:_extrasModal$addons.map(addon=>{var _addon$stock,_addon$stock$product;return String((addon===null||addon===void 0?void 0:(_addon$stock=addon.stock)===null||_addon$stock===void 0?void 0:(_addon$stock$product=_addon$stock.product)===null||_addon$stock$product===void 0?void 0:_addon$stock$product.id)||addon.addon_id);}))||[]);}}).finally(()=>setLoading(false));},[extrasModal.uuid]);return/*#__PURE__*/_jsx(Modal,{visible:!!data,title:data===null||data===void 0?void 0:(_data$translation=data.translation)===null||_data$translation===void 0?void 0:_data$translation.title,onCancel:handleCancel,footer:[loading?null:/*#__PURE__*/_jsx(Button,{type:\"primary\",onClick:handleSubmit,children:t('add')},'add-product'),/*#__PURE__*/_jsx(Button,{type:\"default\",onClick:handleCancel,children:t('cancel')},'cancel-modal')],children:/*#__PURE__*/_jsxs(Spin,{spinning:loading,children:[/*#__PURE__*/_jsxs(Row,{gutter:24,children:[/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(Image,{src:getImage(getImageFromStock(currentStock)||data.img),alt:data.name,height:200,style:{objectFit:'contain'}})}),/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsxs(Descriptions,{title:(_data$translation2=data.translation)===null||_data$translation2===void 0?void 0:_data$translation2.title,children:[/*#__PURE__*/_jsxs(Descriptions.Item,{label:t('price'),span:3,children:[/*#__PURE__*/_jsx(\"div\",{className:currentStock!==null&&currentStock!==void 0&&currentStock.discount?'strike':'',children:numberToPrice(calculateTotalPrice(),currency.symbol)}),currentStock!==null&&currentStock!==void 0&&currentStock.discount?/*#__PURE__*/_jsx(\"div\",{className:\"ml-2 font-weight-bold\",children:numberToPrice(calculateTotalPrice('total_price'),currency.symbol)}):'']}),/*#__PURE__*/_jsx(Descriptions.Item,{label:t('in.stock'),span:3,children:numberToQuantity(currentStock===null||currentStock===void 0?void 0:currentStock.quantity,data.unit)}),/*#__PURE__*/_jsx(Descriptions.Item,{label:t('tax'),span:3,children:numberToPrice(currentStock===null||currentStock===void 0?void 0:currentStock.tax,currency.symbol)})]})})]}),showExtras!==null&&showExtras!==void 0&&showExtras.extras?showExtras===null||showExtras===void 0?void 0:(_showExtras$extras=showExtras.extras)===null||_showExtras$extras===void 0?void 0:_showExtras$extras.map((extra,idx)=>{return/*#__PURE__*/_jsx(\"div\",{className:\"extra-group\",children:/*#__PURE__*/_jsx(Space,{className:\"extras-select\",wrap:true,children:extra===null||extra===void 0?void 0:extra.map((item,itemIdx)=>{var _item$group,_item$group2;if((item===null||item===void 0?void 0:(_item$group=item.group)===null||_item$group===void 0?void 0:_item$group.type)==='color'){var _item$value;return/*#__PURE__*/_jsx(\"span\",{className:`extras-color-wrapper ${!!extrasIds.find(extra=>extra.id===item.id)?'selected':''}`,onClick:()=>handleExtrasClick(item),children:/*#__PURE__*/_jsx(\"i\",{className:\"extras-color\",style:{backgroundColor:item===null||item===void 0?void 0:(_item$value=item.value)===null||_item$value===void 0?void 0:_item$value.value}})},'color'+itemIdx);}else if((item===null||item===void 0?void 0:(_item$group2=item.group)===null||_item$group2===void 0?void 0:_item$group2.type)==='text'){var _item$value2;return/*#__PURE__*/_jsx(\"span\",{className:`extras-text rounded ${!!extrasIds.find(extra=>extra.id===item.id)?'selected':''}`,onClick:()=>handleExtrasClick(item),children:item===null||item===void 0?void 0:(_item$value2=item.value)===null||_item$value2===void 0?void 0:_item$value2.value},'text'+itemIdx);}return null;})})},'extra-group'+idx);}):null,/*#__PURE__*/_jsx(Space,{direction:\"vertical\",size:\"middle\",children:(_showExtras$stock3=showExtras.stock)===null||_showExtras$stock3===void 0?void 0:(_showExtras$stock3$ad=_showExtras$stock3.addons)===null||_showExtras$stock3$ad===void 0?void 0:_showExtras$stock3$ad.filter(item=>!!item.product).map(item=>{var _item$unit,_item$unit$translatio;const selected=selectedValues.includes(String(item.addon_id));return/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsxs(\"label\",{htmlFor:String(item.id),children:[selected&&/*#__PURE__*/_jsxs(Space,{size:0,children:[/*#__PURE__*/_jsx(Button,{type:\"text\",className:\"minus-button\",style:{padding:0,height:'max-content'},size:\"small\",icon:/*#__PURE__*/_jsx(MinusOutlined,{}),disabled:item.product.quantity===1,onClick:e=>{e.stopPropagation();addonCalculate(item.addon_id,item.product.quantity-1);}}),/*#__PURE__*/_jsxs(\"span\",{className:\"ml-2\",children:[(item.product.quantity||item.product.min_qty)*((item===null||item===void 0?void 0:item.interval)||1),(_item$unit=item.unit)===null||_item$unit===void 0?void 0:(_item$unit$translatio=_item$unit.translation)===null||_item$unit$translatio===void 0?void 0:_item$unit$translatio.title]}),/*#__PURE__*/_jsx(Button,{type:\"text\",className:\"plus-button\",style:{padding:0,height:'max-content'},size:\"small\",icon:/*#__PURE__*/_jsx(PlusOutlined,{}),onClick:e=>{e.stopPropagation();addonCalculate(item.addon_id,item.product.quantity?item.product.quantity+1:item.product.min_qty+1);}})]}),/*#__PURE__*/_jsx(\"span\",{className:\"ml-2\",children:item.product.translation.title})]})},item.id);})}),/*#__PURE__*/_jsx(Row,{gutter:12,className:\"mt-3\",children:/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(MinusOutlined,{}),onClick:reduceCounter},'plus'),(counter||1)*((data===null||data===void 0?void 0:data.interval)||1),data===null||data===void 0?void 0:(_data$unit=data.unit)===null||_data$unit===void 0?void 0:(_data$unit$translatio=_data$unit.translation)===null||_data$unit$translatio===void 0?void 0:_data$unit$translatio.title,/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(PlusOutlined,{}),onClick:addCounter},'minus')]})})})]})});}","map":null,"metadata":{},"sourceType":"module"}