{"ast":null,"code":"import{Card,Col,Row,Space,Typography,Table,Button,DatePicker,Spin}from'antd';import React,{useContext,useEffect,useState}from'react';import SearchInput from'../../components/search-input';import{CloudDownloadOutlined}from'@ant-design/icons';import ReportService from'../../services/reports';import{addMenu,disableRefetch}from'../../redux/slices/menu';import{shallowEqual,useDispatch,useSelector}from'react-redux';import ReportChart from'../../components/report/chart';import moment from'moment';import{ReportContext}from'../../context/report';import FilterColumns from'../../components/filter-column';import{fetchReportProductChart}from'../../redux/slices/report/categories';import useDidUpdate from'../../helpers/useDidUpdate';import{Link,useNavigate}from'react-router-dom';import{useTranslation}from'react-i18next';import numberToPrice from'../../helpers/numberToPrice';import{useMemo}from'react';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const{Text,Title}=Typography;const{RangePicker}=DatePicker;const ReportProducts=()=>{var _activeMenu$data,_activeMenu$data2,_productList$data;const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const{date_from,date_to,by_time,chart,handleChart,handleDateRange}=useContext(ReportContext);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{loading,chartData:reportData,productList}=useSelector(state=>state.categoryReport,shallowEqual);const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const[selectedRowKeys,setSelectedRowKeys]=useState([]);const[search,setSearch]=useState();const[downloading,setDownloading]=useState(false);const goToProductReport=row=>{dispatch(addMenu({url:`report/products`,id:'report.products',name:t('report.products')}));navigate(`/report/products?category_id=${row.id}`);};const[columns,setColumns]=useState([{title:t('category'),key:'category',dataIndex:'category',render:(_,data)=>{var _data$title;const categoryList=data===null||data===void 0?void 0:(_data$title=data.title)===null||_data$title===void 0?void 0:_data$title.split('-');return categoryList===null||categoryList===void 0?void 0:categoryList.map((item,i)=>i===(categoryList===null||categoryList===void 0?void 0:categoryList.length)-1?/*#__PURE__*/_jsx(Link,{to:`/report/products?category_id=${data===null||data===void 0?void 0:data.id}`,children:item}):item);},sorter:(a,b)=>{var _a$title;return a===null||a===void 0?void 0:(_a$title=a.title)===null||_a$title===void 0?void 0:_a$title.localeCompare(b===null||b===void 0?void 0:b.title);},is_show:true},{title:t('item.sold'),dataIndex:'quantity',key:'quantity',is_show:true,sorter:(a,b)=>(a===null||a===void 0?void 0:a.quantity)-(b===null||b===void 0?void 0:b.quantity)},{title:t('price'),dataIndex:'price',key:'price',is_show:true,sorter:(a,b)=>(a===null||a===void 0?void 0:a.price)-(b===null||b===void 0?void 0:b.price),render:(_,data)=>{return numberToPrice(data===null||data===void 0?void 0:data.price,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol);}},{title:t('products'),key:'products_count',dataIndex:'products_count',sorter:(a,b)=>(a===null||a===void 0?void 0:a.products_count)-(b===null||b===void 0?void 0:b.products_count),render:(_,data)=>{return/*#__PURE__*/_jsx(\"span\",{onClick:()=>goToProductReport(data),children:data===null||data===void 0?void 0:data.products_count});},is_show:true},{title:t('orders'),key:'count',dataIndex:'count',is_show:true,sorter:(a,b)=>(a===null||a===void 0?void 0:a.count)-(b===null||b===void 0?void 0:b.count)}]);const chart_type=useMemo(()=>[{value:'quantity',label:'Item sold',qty:'total_quantity'},{value:'price',label:'Net Sales',qty:'total_price'},{value:'count',label:'Orders',qty:'total_count'},{value:'total_products_count',label:'Order products',qty:'total_products_count'}],[]);const fetchReport=()=>{if(chart_type.find(item=>item.value===chart)){const params={date_from,date_to,type:by_time,chart,search:(search===null||search===void 0?void 0:search.trim())===''?undefined:search===null||search===void 0?void 0:search.trim()};dispatch(fetchReportProductChart(params));}};useEffect(()=>{if(chart_type.every(item=>item.value!==chart)){handleChart(chart_type[0].value);}},[]);useEffect(()=>{if(activeMenu.refetch){fetchReport();dispatch(disableRefetch(activeMenu));}},[activeMenu.refetch]);useDidUpdate(()=>{fetchReport();},[date_to,by_time,chart,search,date_from]);const onSelectChange=newSelectedRowKeys=>{setSelectedRowKeys(newSelectedRowKeys);};const rowSelection={selectedRowKeys,onChange:onSelectChange};const excelExport=()=>{setDownloading(true);ReportService.getCategoriesChart({date_from,date_to,type:by_time,export:'excel'}).then(res=>{const body=res.data.link;if(body){window.location.href=body;}}).finally(()=>setDownloading(false));};return/*#__PURE__*/_jsxs(Spin,{size:\"large\",spinning:loading,children:[/*#__PURE__*/_jsx(Row,{gutter:24,className:\"mb-3\",children:/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Space,{size:\"large\",children:/*#__PURE__*/_jsx(RangePicker,{defaultValue:[moment(date_from),moment(date_to)],onChange:handleDateRange})})})}),/*#__PURE__*/_jsx(Row,{gutter:24,className:\"report-products\",children:chart_type===null||chart_type===void 0?void 0:chart_type.map(item=>/*#__PURE__*/_jsx(Col,{span:6,onClick:()=>handleChart(item.value),children:/*#__PURE__*/_jsxs(Card,{className:chart===item.value&&'active',children:[/*#__PURE__*/_jsx(Row,{className:\"mb-5\",children:/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Text,{children:item.label})})}),/*#__PURE__*/_jsx(Row,{gutter:24,children:/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Title,{level:2,children:item.qty==='total_price'?numberToPrice(reportData[item.qty]):reportData[item.qty]})})})]})},item.label))}),/*#__PURE__*/_jsx(ReportChart,{reportData:reportData,chart_data:\"quantities_sum\"}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(Space,{className:\"align-items-center justify-content-between mb-4 w-100\",children:[/*#__PURE__*/_jsx(Title,{level:2,className:\"mb-0\",children:t('categories')}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(SearchInput,{style:{width:'100%'},handleChange:e=>setSearch(e),defaultValue:(_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.search,resetSearch:!((_activeMenu$data2=activeMenu.data)!==null&&_activeMenu$data2!==void 0&&_activeMenu$data2.search)}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(CloudDownloadOutlined,{}),loading:downloading,disabled:(productList===null||productList===void 0?void 0:(_productList$data=productList.data)===null||_productList$data===void 0?void 0:_productList$data.length)===0,onClick:excelExport,children:t('download')}),/*#__PURE__*/_jsx(FilterColumns,{columns:columns,setColumns:setColumns})]})]}),/*#__PURE__*/_jsx(Table,{scroll:{x:true},rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(item=>item.is_show),dataSource:Object.values(productList)||[],rowKey:row=>row.id,loading:loading,pagination:{pageSize:productList===null||productList===void 0?void 0:productList.per_page,page:(productList===null||productList===void 0?void 0:productList.current_page)||1,total:productList===null||productList===void 0?void 0:productList.total,defaultCurrent:1}})]})]});};export default ReportProducts;","map":null,"metadata":{},"sourceType":"module"}