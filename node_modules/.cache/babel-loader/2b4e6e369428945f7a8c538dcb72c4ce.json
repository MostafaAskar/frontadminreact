{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Button,Col,Form,PageHeader,Row,Spin}from'antd';import UserInfo from'./user-info';import DeliveryInfo from'./delivery-info';import ProductInfo from'./product-info';import PreviewInfo from'./preview-info';import{batch,shallowEqual,useDispatch,useSelector}from'react-redux';import orderService from'services/order';import moment from'moment';import{clearOrder,setOrderCurrency,setOrderData,setOrderItems,setOrderProducts,setOrderTotal}from'redux/slices/order';import{useNavigate,useParams}from'react-router-dom';import{disableRefetch,removeFromMenu,setMenuData}from'redux/slices/menu';import{fetchOrders}from'redux/slices/orders';import{useTranslation}from'react-i18next';import transactionService from'services/transaction';import TransactionDetails from'./transaction-details';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export default function OrderEdit(){var _data$currency;const{t}=useTranslation();const[form]=Form.useForm();const dispatch=useDispatch();const{id}=useParams();const navigate=useNavigate();const[loadingBtn,setLoadingBtn]=useState(false);const[orderId,setOrderId]=useState(null);const[loading,setLoading]=useState(false);const{data,total,coupon,orderProducts,orderItems}=useSelector(state=>state.order,shallowEqual);const{currencies}=useSelector(state=>state.currency,shallowEqual);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{defaultLang}=useSelector(state=>state.formLang,shallowEqual);function formatUser(user){return{label:user.firstname+' '+(user.lastname||''),value:user.id,uuid:user.uuid,key:user.id};}function formatAddress(order){var _order$address,_order$location,_order$address2,_order$address2$locat,_order$location2,_order$address3,_order$address3$locat,_order$delivery_point,_order$delivery_point2,_order$delivery_point3,_order$delivery_point4,_order$delivery_point5,_order$delivery_point6,_order$my_address,_order$my_address2,_order$my_address2$lo,_order$my_address3,_order$my_address3$lo,_order$my_address4,_order$my_address4$lo;return order!==null&&order!==void 0&&order.address?{address:order===null||order===void 0?void 0:(_order$address=order.address)===null||_order$address===void 0?void 0:_order$address.address,lat:(order===null||order===void 0?void 0:(_order$location=order.location)===null||_order$location===void 0?void 0:_order$location.latitude)||(order===null||order===void 0?void 0:(_order$address2=order.address)===null||_order$address2===void 0?void 0:(_order$address2$locat=_order$address2.location)===null||_order$address2$locat===void 0?void 0:_order$address2$locat.latitude),lng:(order===null||order===void 0?void 0:(_order$location2=order.location)===null||_order$location2===void 0?void 0:_order$location2.longitude)||(order===null||order===void 0?void 0:(_order$address3=order.address)===null||_order$address3===void 0?void 0:(_order$address3$locat=_order$address3.location)===null||_order$address3$locat===void 0?void 0:_order$address3$locat.longitude)}:order!==null&&order!==void 0&&order.delivery_point?{address:order===null||order===void 0?void 0:(_order$delivery_point=order.delivery_point)===null||_order$delivery_point===void 0?void 0:(_order$delivery_point2=_order$delivery_point.address)===null||_order$delivery_point2===void 0?void 0:_order$delivery_point2[defaultLang],lat:order===null||order===void 0?void 0:(_order$delivery_point3=order.delivery_point)===null||_order$delivery_point3===void 0?void 0:(_order$delivery_point4=_order$delivery_point3.location)===null||_order$delivery_point4===void 0?void 0:_order$delivery_point4.latitude,lng:order===null||order===void 0?void 0:(_order$delivery_point5=order.delivery_point)===null||_order$delivery_point5===void 0?void 0:(_order$delivery_point6=_order$delivery_point5.location)===null||_order$delivery_point6===void 0?void 0:_order$delivery_point6.longitude}:order!==null&&order!==void 0&&(_order$my_address=order.my_address)!==null&&_order$my_address!==void 0&&_order$my_address.location?{address:order===null||order===void 0?void 0:(_order$my_address2=order.my_address)===null||_order$my_address2===void 0?void 0:(_order$my_address2$lo=_order$my_address2.location)===null||_order$my_address2$lo===void 0?void 0:_order$my_address2$lo.address,lat:order===null||order===void 0?void 0:(_order$my_address3=order.my_address)===null||_order$my_address3===void 0?void 0:(_order$my_address3$lo=_order$my_address3.location)===null||_order$my_address3$lo===void 0?void 0:_order$my_address3$lo.latitude,lng:order===null||order===void 0?void 0:(_order$my_address4=order.my_address)===null||_order$my_address4===void 0?void 0:(_order$my_address4$lo=_order$my_address4.location)===null||_order$my_address4$lo===void 0?void 0:_order$my_address4$lo.longitude}:null;}function fetchOrder(){setLoading(true);orderService.getById(id).then(res=>{var _order$details,_order$details$flatMa,_order$currency,_order$transaction,_order$transaction$pa,_order$transaction2,_order$transaction2$p,_order$shop;const order=res.data;const calculate=true;dispatch(setOrderData({calculate}));const items=order.details.map(item=>{var _item$stock,_item$stock2,_item$stock3,_item$stock3$product,_item$stock4;return{...(item===null||item===void 0?void 0:(_item$stock=item.stock)===null||_item$stock===void 0?void 0:_item$stock.product),stocks:item===null||item===void 0?void 0:(_item$stock2=item.stock)===null||_item$stock2===void 0?void 0:_item$stock2.extras,stock:item===null||item===void 0?void 0:item.stock,stockID:item===null||item===void 0?void 0:item.stock,quantity:item===null||item===void 0?void 0:item.quantity,img:item===null||item===void 0?void 0:(_item$stock3=item.stock)===null||_item$stock3===void 0?void 0:(_item$stock3$product=_item$stock3.product)===null||_item$stock3$product===void 0?void 0:_item$stock3$product.img,price:item===null||item===void 0?void 0:(_item$stock4=item.stock)===null||_item$stock4===void 0?void 0:_item$stock4.price,bonus:item===null||item===void 0?void 0:item.bonus,addons:item===null||item===void 0?void 0:item.addons};});const orderData={product_tax:order===null||order===void 0?void 0:(_order$details=order.details)===null||_order$details===void 0?void 0:(_order$details$flatMa=_order$details.flatMap(e=>e===null||e===void 0?void 0:e.total_price))===null||_order$details$flatMa===void 0?void 0:_order$details$flatMa.reduce((sum,e)=>sum+e,0),shop_tax:order===null||order===void 0?void 0:order.tax,order_total:order===null||order===void 0?void 0:order.total_price};batch(()=>{var _order$user;dispatch(setOrderProducts(items));dispatch(setOrderItems(items));dispatch(setOrderTotal(orderData));dispatch(setOrderCurrency(order===null||order===void 0?void 0:order.currency));dispatch(setMenuData({activeMenu,data:{...activeMenu.data,addressData:formatAddress(order)}}));dispatch(setOrderData({userUuid:order===null||order===void 0?void 0:(_order$user=order.user)===null||_order$user===void 0?void 0:_order$user.uuid,shop:getFirstShopFromList(order===null||order===void 0?void 0:order.shop),delivery_type:order===null||order===void 0?void 0:order.delivery_type,delivery_fee:order===null||order===void 0?void 0:order.delivery_fee,delivery_date:JSON.stringify(order===null||order===void 0?void 0:order.delivery_date),delivery_time:order===null||order===void 0?void 0:order.delivery_time,address:formatAddress(order),currency:{id:order===null||order===void 0?void 0:order.currency.payment_system},payment_type:order===null||order===void 0?void 0:order.transaction,deliveries:{label:order===null||order===void 0?void 0:order.delivery_type},status:order===null||order===void 0?void 0:order.status}));});form.setFieldsValue({delivery_time:moment(order===null||order===void 0?void 0:order.delivery_date,'HH:mm'),delivery_date:moment(order===null||order===void 0?void 0:order.delivery_date,'YYYY-MM-DD'),user:formatUser(order===null||order===void 0?void 0:order.user),currency_id:order===null||order===void 0?void 0:(_order$currency=order.currency)===null||_order$currency===void 0?void 0:_order$currency.id,payment_type:{label:(order===null||order===void 0?void 0:(_order$transaction=order.transaction)===null||_order$transaction===void 0?void 0:(_order$transaction$pa=_order$transaction.payment_system)===null||_order$transaction$pa===void 0?void 0:_order$transaction$pa.tag)||'cash',value:(order===null||order===void 0?void 0:(_order$transaction2=order.transaction)===null||_order$transaction2===void 0?void 0:(_order$transaction2$p=_order$transaction2.payment_system)===null||_order$transaction2$p===void 0?void 0:_order$transaction2$p.id)||1},note:order===null||order===void 0?void 0:order.note,delivery:{label:order===null||order===void 0?void 0:order.delivery_type,value:order===null||order===void 0?void 0:(_order$shop=order.shop)===null||_order$shop===void 0?void 0:_order$shop.price},transactionStatus:order.transaction.status});}).finally(()=>{setLoading(false);dispatch(disableRefetch(activeMenu));});}function getFirstShopFromList(shops){var _shops$translation;if(!shops){return null;}return{label:(_shops$translation=shops.translation)===null||_shops$translation===void 0?void 0:_shops$translation.title,value:shops.id,key:shops.id,open_time:shops.open_time,close_time:shops.close_time};}function createTransaction(id,data){transactionService.create(id,data).then(res=>{setOrderId(res.data.id);dispatch(clearOrder());}).finally(()=>setLoadingBtn(false));}const orderUpdate=(body,paymentData)=>{const payment={payment_sys_id:paymentData.value};setLoadingBtn(true);orderService.update(id,body).then(response=>{createTransaction(response.data.id,payment);}).catch(()=>setLoadingBtn(false));};function formatProducts(list){const addons=list===null||list===void 0?void 0:list.map(item=>{var _item$stockID,_item$stock5;return{quantity:item.quantity,stock_id:item.stockID?(_item$stockID=item.stockID)===null||_item$stockID===void 0?void 0:_item$stockID.id:(_item$stock5=item.stock)===null||_item$stock5===void 0?void 0:_item$stock5.id};});const products=list===null||list===void 0?void 0:list.flatMap(item=>{var _item$addons;return(_item$addons=item.addons)===null||_item$addons===void 0?void 0:_item$addons.map(addon=>{var _item$stockID2,_item$stock6;return{quantity:addon.quantity,stock_id:addon.stock_id,parent_id:item.stockID?(_item$stockID2=item.stockID)===null||_item$stockID2===void 0?void 0:_item$stockID2.id:(_item$stock6=item.stock)===null||_item$stock6===void 0?void 0:_item$stock6.id};});});return addons.concat(products);}const onFinish=values=>{var _currencies$find,_values$payment_type,_activeMenu$data$addr,_activeMenu$data$addr2,_activeMenu$data$addr3;const products=formatProducts(orderItems);const body={currency_id:values.currency_id,rate:(_currencies$find=currencies.find(item=>item.id===values.currency_id))===null||_currencies$find===void 0?void 0:_currencies$find.rate,// shop_id: data.shop.value,\ndelivery_fee:data.delivery_fee,coupon:coupon.coupon,tax:total.order_tax,payment_type:(_values$payment_type=values.payment_type)===null||_values$payment_type===void 0?void 0:_values$payment_type.label,note:values.note,address:{address:(_activeMenu$data$addr=activeMenu.data.addressData)===null||_activeMenu$data$addr===void 0?void 0:_activeMenu$data$addr.address,office:null,house:null,floor:null},location:{latitude:(_activeMenu$data$addr2=activeMenu.data.addressData)===null||_activeMenu$data$addr2===void 0?void 0:_activeMenu$data$addr2.lat,longitude:(_activeMenu$data$addr3=activeMenu.data.addressData)===null||_activeMenu$data$addr3===void 0?void 0:_activeMenu$data$addr3.lng},delivery_date:moment(values.delivery_date).format('YYYY-MM-DD')+' '+moment(values.delivery_time).format('HH:mm'),user_id:values.user.value,products:products===null||products===void 0?void 0:products.filter(item=>!!item),status:data===null||data===void 0?void 0:data.status};orderUpdate(body,values.payment_type);};const handleCloseInvoice=()=>{setOrderId(null);const nextUrl='orders-board';batch(()=>{dispatch(removeFromMenu({...activeMenu,nextUrl}));dispatch(fetchOrders({}));});navigate(`/${nextUrl}`);};useEffect(()=>{if(activeMenu.refetch){fetchOrder();}},[activeMenu.refetch]);return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(PageHeader,{title:t('edit.order'),extra:/*#__PURE__*/_jsx(Button,{type:\"primary\",loading:loadingBtn,onClick:()=>form.submit(),disabled:!(orderProducts!==null&&orderProducts!==void 0&&orderProducts.length),children:t('save')})}),/*#__PURE__*/_jsxs(Form,{name:\"order-form\",form:form,layout:\"vertical\",onFinish:onFinish,className:\"order-add\",initialValues:{user:data.user||undefined,address:data.address||null,currency_id:data===null||data===void 0?void 0:(_data$currency=data.currency)===null||_data$currency===void 0?void 0:_data$currency.id,payment_type:data.payment_type||null},children:[/*#__PURE__*/_jsxs(Row,{gutter:24,hidden:loading,children:[/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsx(ProductInfo,{form:form})}),/*#__PURE__*/_jsxs(Col,{span:8,children:[/*#__PURE__*/_jsx(UserInfo,{form:form}),/*#__PURE__*/_jsx(DeliveryInfo,{form:form}),/*#__PURE__*/_jsx(TransactionDetails,{form:form})]})]}),loading&&/*#__PURE__*/_jsx(\"div\",{className:\"loader\",children:/*#__PURE__*/_jsx(Spin,{})})]}),orderId?/*#__PURE__*/_jsx(PreviewInfo,{orderId:orderId,handleClose:handleCloseInvoice}):'']});}","map":null,"metadata":{},"sourceType":"module"}