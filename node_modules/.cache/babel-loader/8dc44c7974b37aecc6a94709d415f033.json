{"ast":null,"code":"import React,{useContext,useEffect,useState}from'react';import{Button,Space,Card,DatePicker}from'antd';import{useNavigate,useParams}from'react-router-dom';import{ClearOutlined,PlusCircleOutlined}from'@ant-design/icons';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addMenu,disableRefetch,setMenu,setMenuData}from'redux/slices/menu';import{useTranslation}from'react-i18next';import useDidUpdate from'helpers/useDidUpdate';import{clearItems,fetchAcceptedOrders,fetchCanceledOrders,fetchDeliveredOrders,fetchNewOrders,fetchOnAWayOrders,fetchOrders,fetchReadyOrders,fetchCookingOrders,fetchPauseOrders}from'redux/slices/orders';import{fetchRestOrderStatus,fetchOrderStatus}from'redux/slices/orderStatus';import SearchInput from'components/search-input';import{clearOrder}from'redux/slices/order';import{DebounceSelect}from'components/search';import userService from'services/user';import OrderStatusModal from'./orderStatusModal';import OrderDeliveryman from'./orderDeliveryman';import ShowLocationsMap from'./show-locations.map';import DownloadModal from'./downloadModal';import{toast}from'react-toastify';import orderService from'services/order';import{Context}from'context/context';import CustomModal from'components/modal';import moment from'moment';import shopService from'services/restaurant';import Incorporate from'./dnd/Incorporate';import{batch}from'react-redux';import OrderTypeSwitcher from'./order-type-switcher';import{CgExport}from'react-icons/cg';import{export_url}from'configs/app-global';import regionService from'services/deliveryzone/region';import countryService from'services/deliveryzone/country';import cityService from'services/deliveryzone/city';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const{RangePicker}=DatePicker;export default function OrderBoard(){var _data$region,_data$country,_data$city,_activeMenu$data,_activeMenu$data2,_dateRange$,_dateRange$2,_data$region3,_data$country3,_data$region4;const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const{type}=useParams();const{statusList}=useSelector(state=>state.orderStatus,shallowEqual);const[orderDetails,setOrderDetails]=useState(null);const[locationsMap,setLocationsMap]=useState(null);const[downloadModal,setDownloadModal]=useState(null);const[downloading,setDownLoading]=useState(false);const[orderDeliveryDetails,setOrderDeliveryDetails]=useState(null);const[tabType,setTabType]=useState(null);const goToEdit=row=>{dispatch(clearOrder());dispatch(addMenu({url:`order/${row.id}`,id:'order_edit',name:t('edit.order')}));navigate(`/order/${row.id}`);};const goToShow=row=>{dispatch(addMenu({url:`order/details/${row.id}`,id:'order_details',name:t('order.details')}));navigate(`/order/details/${row.id}`);};const goToOrderCreate=()=>{dispatch(clearOrder());dispatch(setMenu({id:'pos.system_01',url:'pos-system',name:'pos.system'}));navigate('/pos-system');};const{setIsModalVisible}=useContext(Context);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const[id,setId]=useState(null);const[text,setText]=useState(null);const[loadingBtn,setLoadingBtn]=useState(false);const[dateRange,setDateRange]=useState(null);const data=activeMenu===null||activeMenu===void 0?void 0:activeMenu.data;const paramsData={search:data!==null&&data!==void 0&&data.search?data.search:undefined,perPage:(data===null||data===void 0?void 0:data.perPage)||5,page:(data===null||data===void 0?void 0:data.page)||1,user_id:data===null||data===void 0?void 0:data.client_id,region_id:data===null||data===void 0?void 0:(_data$region=data.region)===null||_data$region===void 0?void 0:_data$region.value,country_id:data===null||data===void 0?void 0:(_data$country=data.country)===null||_data$country===void 0?void 0:_data$country.value,city_id:data===null||data===void 0?void 0:(_data$city=data.city)===null||_data$city===void 0?void 0:_data$city.value,status:data===null||data===void 0?void 0:data.role,type:'1',shop_id:((_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.shop_id)!==null?(_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:_activeMenu$data2.shop_id:null,delivery_type:type!=='scheduled'?type:undefined,delivery_date_from:type==='scheduled'?moment().add(1,'day').format('YYYY-MM-DD'):undefined,date_from:(dateRange===null||dateRange===void 0?void 0:(_dateRange$=dateRange[0])===null||_dateRange$===void 0?void 0:_dateRange$.format('YYYY-MM-DD'))||undefined,date_to:(dateRange===null||dateRange===void 0?void 0:(_dateRange$2=dateRange[1])===null||_dateRange$2===void 0?void 0:_dateRange$2.format('YYYY-MM-DD'))||undefined};const orderDelete=()=>{setLoadingBtn(true);const params={...Object.assign({},...id.map((item,index)=>({[`ids[${index}]`]:item})))};orderService.delete(params).then(()=>{setIsModalVisible(false);setText(null);dispatch(clearItems());fetchOrderAllItem({status:tabType});toast.success(t('successfully.deleted'));}).finally(()=>setLoadingBtn(false));};useDidUpdate(()=>{// dispatch(handleSearch(paramsData));\ndispatch(clearItems());fetchOrderAllItem();},[data,dateRange]);const excelExport=()=>{setDownLoading(true);orderService.export(paramsData).then(res=>window.location.href=export_url+res.data.file_name).finally(()=>setDownLoading(false));};const handleFilter=(item,name)=>{batch(()=>{dispatch(clearItems());dispatch(setMenuData({activeMenu,data:{...data,...{[name]:item}}}));});};async function getUsers(search){const params={search,perPage:10};return userService.search(params).then(_ref=>{let{data}=_ref;return data.map(item=>({label:`${item.firstname} ${item.lastname}`,value:item.id,key:item.id}));});}const handleCloseModal=()=>{setOrderDetails(null);setOrderDeliveryDetails(null);setLocationsMap(null);setDownloadModal(null);};async function fetchShops(search){const params={search,status:'approved'};return shopService.getAll(params).then(_ref2=>{let{data}=_ref2;return data.map(item=>{var _item$translation;return{label:(_item$translation=item.translation)===null||_item$translation===void 0?void 0:_item$translation.title,value:item.id,key:item.id};});});}const fetchRegions=search=>{const params={search,perPage:10,page:1};return regionService.get(params).then(_ref3=>{let{data}=_ref3;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation2;return{label:item===null||item===void 0?void 0:(_item$translation2=item.translation)===null||_item$translation2===void 0?void 0:_item$translation2.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});};const fetchCountry=search=>{var _activeMenu$data3,_activeMenu$data3$reg;const params={search,perPage:10,page:1,region_id:activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:(_activeMenu$data3$reg=_activeMenu$data3.region)===null||_activeMenu$data3$reg===void 0?void 0:_activeMenu$data3$reg.value};return countryService.get(params).then(_ref4=>{let{data}=_ref4;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation3;return{label:item===null||item===void 0?void 0:(_item$translation3=item.translation)===null||_item$translation3===void 0?void 0:_item$translation3.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});};const fetchCity=search=>{var _activeMenu$data4,_activeMenu$data4$cou;const params={search,perPage:10,page:1,country_id:activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:(_activeMenu$data4$cou=_activeMenu$data4.country)===null||_activeMenu$data4$cou===void 0?void 0:_activeMenu$data4$cou.value};return cityService.get(params).then(_ref5=>{let{data}=_ref5;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation4;return{label:item===null||item===void 0?void 0:(_item$translation4=item.translation)===null||_item$translation4===void 0?void 0:_item$translation4.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});};const fetchOrdersCase=params=>{var _data$region2,_data$country2,_data$city2,_activeMenu$data5,_activeMenu$data6,_dateRange$3,_dateRange$4;const paramsWithType={...params,delivery_type:type!=='scheduled'?type:undefined,delivery_date_from:type==='scheduled'?moment().add(1,'day').format('YYYY-MM-DD'):undefined,search:data!==null&&data!==void 0&&data.search?data.search:undefined,user_id:data===null||data===void 0?void 0:data.client_id,region_id:data===null||data===void 0?void 0:(_data$region2=data.region)===null||_data$region2===void 0?void 0:_data$region2.value,country_id:data===null||data===void 0?void 0:(_data$country2=data.country)===null||_data$country2===void 0?void 0:_data$country2.value,city_id:data===null||data===void 0?void 0:(_data$city2=data.city)===null||_data$city2===void 0?void 0:_data$city2.value,status:params===null||params===void 0?void 0:params.status,type:'1',shop_id:((_activeMenu$data5=activeMenu.data)===null||_activeMenu$data5===void 0?void 0:_activeMenu$data5.shop_id)!==null?(_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:_activeMenu$data6.shop_id:null,date_from:(dateRange===null||dateRange===void 0?void 0:(_dateRange$3=dateRange[0])===null||_dateRange$3===void 0?void 0:_dateRange$3.format('YYYY-MM-DD'))||undefined,date_to:(dateRange===null||dateRange===void 0?void 0:(_dateRange$4=dateRange[1])===null||_dateRange$4===void 0?void 0:_dateRange$4.format('YYYY-MM-DD'))||undefined};switch(params===null||params===void 0?void 0:params.status){case'new':dispatch(fetchNewOrders(paramsWithType));break;case'accepted':dispatch(fetchAcceptedOrders(paramsWithType));break;case'ready':dispatch(fetchReadyOrders(paramsWithType));break;case'on_a_way':dispatch(fetchOnAWayOrders(paramsWithType));break;case'delivered':dispatch(fetchDeliveredOrders(paramsWithType));break;case'canceled':dispatch(fetchCanceledOrders(paramsWithType));break;case'cooking':dispatch(fetchCookingOrders(paramsWithType));break;case'pause':dispatch(fetchPauseOrders(paramsWithType));break;default:console.log(`Sorry, we are out of`);}};const fetchOrderAllItem=()=>{fetchOrdersCase({status:'new'});fetchOrdersCase({status:'accepted'});fetchOrdersCase({status:'ready'});fetchOrdersCase({status:'on_a_way'});fetchOrdersCase({status:'delivered'});fetchOrdersCase({status:'canceled'});fetchOrdersCase({status:'cooking'});fetchOrdersCase({status:'pause'});};const handleClear=()=>{batch(()=>{dispatch(clearItems());dispatch(setMenuData({activeMenu,data:null}));});fetchOrderAllItem();};useEffect(()=>{if(activeMenu!==null&&activeMenu!==void 0&&activeMenu.refetch){batch(()=>{dispatch(fetchOrders(paramsData));dispatch(disableRefetch(activeMenu));dispatch(fetchOrderStatus({}));dispatch(fetchRestOrderStatus({}));});}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.refetch]);return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Space,{className:\"w-100 justify-content-end mb-3\",children:[/*#__PURE__*/_jsx(OrderTypeSwitcher,{listType:\"orders-board\"}),/*#__PURE__*/_jsxs(Button,{onClick:excelExport,loading:downloading,style:{width:'100%'},children:[/*#__PURE__*/_jsx(CgExport,{className:\"mr-2\"}),t('export')]}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(ClearOutlined,{}),onClick:handleClear,style:{width:'100%'},children:t('clear')}),/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(PlusCircleOutlined,{}),onClick:goToOrderCreate,style:{width:'100%'},children:t('add.order')})]}),/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(Space,{wrap:true,className:\"order-filter\",size:[8,15],children:[/*#__PURE__*/_jsx(SearchInput,{defaultValue:data===null||data===void 0?void 0:data.search,resetSearch:!(data!==null&&data!==void 0&&data.search),placeholder:t('search'),handleChange:search=>handleFilter(search,'search')}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.shop'),fetchOptions:fetchShops,style:{width:'100%'},onClear:()=>dispatch(clearItems()),onSelect:shop=>handleFilter(shop.value,'shop_id'),onDeselect:()=>handleFilter(null,'shop_id'),allowClear:true,value:data===null||data===void 0?void 0:data.shop_id}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.client'),fetchOptions:getUsers,onSelect:user=>handleFilter(user.value,'client_id'),onDeselect:()=>handleFilter(null,'client_id'),style:{width:'100%'},value:data===null||data===void 0?void 0:data.client_id}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.region'),fetchOptions:fetchRegions,onSelect:region=>{dispatch(setMenuData({activeMenu,data:{...data,region,country:null,city:null}}));},onDeselect:()=>{dispatch(setMenuData({activeMenu,data:{...data,region:null,country:null,city:null}}));},allowClear:true,style:{width:'100%'},value:data===null||data===void 0?void 0:data.region,autoComplete:'none'}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.country'),fetchOptions:fetchCountry,refetchOptions:true,onSelect:country=>{dispatch(setMenuData({activeMenu,data:{...data,country,city:null}}));},onDeselect:()=>{dispatch(setMenuData({activeMenu,data:{...data,country:null,city:null}}));},style:{width:'100%'},value:data===null||data===void 0?void 0:data.country,autoComplete:'none',disabled:!(data!==null&&data!==void 0&&(_data$region3=data.region)!==null&&_data$region3!==void 0&&_data$region3.value),allowClear:true}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.city'),fetchOptions:fetchCity,refetchOptions:true,onSelect:city=>dispatch(setMenuData({activeMenu,data:{...data,city}})),onDeselect:()=>dispatch(setMenuData({activeMenu,data:{...data,city:null}})),style:{width:'100%'},value:data===null||data===void 0?void 0:data.city,autoComplete:'none',disabled:!(data!==null&&data!==void 0&&(_data$country3=data.country)!==null&&_data$country3!==void 0&&_data$country3.value)||!(data!==null&&data!==void 0&&(_data$region4=data.region)!==null&&_data$region4!==void 0&&_data$region4.value),allowClear:true}),type!=='scheduled'&&/*#__PURE__*/_jsx(RangePicker,{defaultValue:dateRange,onChange:values=>{handleFilter(JSON.stringify(values),'data_time');setDateRange(values);},disabledDate:current=>{return current&&current>moment().endOf('day');},allowClear:true,style:{width:'100%'}})]})}),/*#__PURE__*/_jsx(Incorporate,{goToEdit:goToEdit,goToShow:goToShow,fetchOrderAllItem:fetchOrderAllItem,fetchOrders:fetchOrdersCase,setLocationsMap:setLocationsMap,setId:setId,setIsModalVisible:setIsModalVisible,setText:setText,setDowloadModal:setDownloadModal,type:type,setTabType:setTabType}),orderDetails&&/*#__PURE__*/_jsx(OrderStatusModal,{orderDetails:orderDetails,handleCancel:handleCloseModal,status:statusList}),orderDeliveryDetails&&/*#__PURE__*/_jsx(OrderDeliveryman,{orderDetails:orderDeliveryDetails,handleCancel:handleCloseModal}),locationsMap&&/*#__PURE__*/_jsx(ShowLocationsMap,{id:locationsMap,handleCancel:handleCloseModal}),downloadModal&&/*#__PURE__*/_jsx(DownloadModal,{id:downloadModal,handleCancel:handleCloseModal}),/*#__PURE__*/_jsx(CustomModal,{click:orderDelete,text:text?t('delete'):t('all.delete'),loading:loadingBtn,setText:setId})]});}","map":null,"metadata":{},"sourceType":"module"}