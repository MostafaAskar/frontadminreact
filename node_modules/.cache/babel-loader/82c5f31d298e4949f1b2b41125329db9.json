{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Button,Col,Descriptions,Image,Modal,Row,Space,Spin}from'antd';import{useTranslation}from'react-i18next';import getImage from'helpers/getImage';import getImageFromStock from'helpers/getImageFromStock';import numberToPrice from'helpers/numberToPrice';import numberToQuantity from'helpers/numberToQuantity';import{MinusOutlined,PlusOutlined}from'@ant-design/icons';import{shallowEqual,useSelector,useDispatch}from'react-redux';import{getExtras,sortExtras}from'helpers/getExtras';import productService from'services/product';import{setMenuData}from'redux/slices/menu';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";export default function ProductModal(_ref){var _productData$translat,_showExtras$extras,_productData$unit,_productData$unit$tra;let{productData,setProductData}=_ref;const{t}=useTranslation();const dispatch=useDispatch();const{currency}=useSelector(state=>state.order.data,shallowEqual);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const[data,setData]=useState({});const[loading,setLoading]=useState(false);const[currentStock,setCurrentStock]=useState({});const[extrasIds,setExtrasIds]=useState([]);const[extras,setExtras]=useState([]);const[stock,setStock]=useState([]);const[counter,setCounter]=useState((data===null||data===void 0?void 0:data.quantity)||productData.quantity||productData.min_qty);const[showExtras,setShowExtras]=useState({extras:[],stock:{id:0,quantity:1,price:0}});const handleCancel=()=>{setProductData(null);};const handleSubmit=()=>{const body={stock:{...currentStock,extras:extrasIds},quantity:counter,id:currentStock.id,img:getImageFromStock(currentStock)||(data===null||data===void 0?void 0:data.img),price:currentStock.price,translation:data===null||data===void 0?void 0:data.translation};dispatch(setMenuData({activeMenu,data:{newProduct:{...body}}}));setProductData(null);};const calculateTotalPrice=priceKey=>{var _showExtras$stock;return(showExtras===null||showExtras===void 0?void 0:(_showExtras$stock=showExtras.stock)===null||_showExtras$stock===void 0?void 0:_showExtras$stock[priceKey||'price'])*counter;};const handleExtrasClick=e=>{var _extrasData$extras;const index=extrasIds.findIndex(item=>item.extra_group_id===e.extra_group_id);let array=extrasIds;if(index>-1)array=array.slice(0,index);array.push(e);const nextIds=array.map(item=>item.extra_value_id).join(',');var extrasData=getExtras(nextIds,extras,stock);setShowExtras(extrasData);(_extrasData$extras=extrasData.extras)===null||_extrasData$extras===void 0?void 0:_extrasData$extras.forEach(element=>{const index=extrasIds.findIndex(item=>element[0].extra_group_id!==e.extra_group_id?item.extra_group_id===element[0].extra_group_id:item.extra_group_id===e.extra_group_id);if(element[0].level>=e.level){var itemData=element[0].extra_group_id!==e.extra_group_id?element[0]:e;if(index===-1)array.push(itemData);else{array[index]=itemData;}}});setExtrasIds(array);};const addCounter=()=>{if(counter===data.max_qty){return;}setCounter(prev=>prev+1);};const reduceCounter=()=>{if(counter===1){return;}if(counter<=(data===null||data===void 0?void 0:data.min_qty)){return;}setCounter(prev=>prev-1);};useEffect(()=>{setLoading(true);productService.getById(productData.uuid).then(_ref2=>{var _getExtras$extras;let{data}=_ref2;setData(data);const myData=sortExtras(data,{});setExtras(myData.extras);setCounter(data.quantity||data.min_qty);setStock(myData.stock);setShowExtras(getExtras(extrasIds,myData.extras,myData.stock));(_getExtras$extras=getExtras('',myData.extras,myData.stock).extras)===null||_getExtras$extras===void 0?void 0:_getExtras$extras.forEach(element=>{setExtrasIds(prev=>[...prev,element[0]]);});}).finally(()=>setLoading(false));},[productData.uuid]);useEffect(()=>{if(showExtras!==null&&showExtras!==void 0&&showExtras.stock){setCurrentStock({...showExtras.stock,extras:extrasIds});}},[showExtras]);return/*#__PURE__*/_jsx(Modal,{visible:!!productData,onCancel:handleCancel,footer:[loading?'':/*#__PURE__*/_jsx(Button,{type:\"primary\",onClick:handleSubmit,children:t('add')},'add-product'),/*#__PURE__*/_jsx(Button,{type:\"default\",onClick:handleCancel,children:t('cancel')},'cancel-modal')],children:/*#__PURE__*/_jsxs(Spin,{spinning:loading,children:[/*#__PURE__*/_jsxs(Row,{gutter:24,children:[/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(Image,{src:getImage(getImageFromStock(currentStock)||(productData===null||productData===void 0?void 0:productData.img)),alt:productData.name,height:200,style:{objectFit:'contain'}})}),/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsxs(Descriptions,{title:(_productData$translat=productData.translation)===null||_productData$translat===void 0?void 0:_productData$translat.title,children:[/*#__PURE__*/_jsxs(Descriptions.Item,{label:t('price'),span:3,children:[/*#__PURE__*/_jsx(\"div\",{className:currentStock!==null&&currentStock!==void 0&&currentStock.discount?'strike':'',children:numberToPrice(calculateTotalPrice(),currency.symbol)}),currentStock!==null&&currentStock!==void 0&&currentStock.discount?/*#__PURE__*/_jsx(\"div\",{className:\"ml-2 font-weight-bold\",children:numberToPrice(calculateTotalPrice('total_price'),currency.symbol)}):'']}),/*#__PURE__*/_jsx(Descriptions.Item,{label:t('in.stock'),span:3,children:numberToQuantity(currentStock===null||currentStock===void 0?void 0:currentStock.quantity,data===null||data===void 0?void 0:data.unit)}),/*#__PURE__*/_jsx(Descriptions.Item,{label:t('tax'),span:3,children:numberToPrice(currentStock===null||currentStock===void 0?void 0:currentStock.tax,currency.symbol)})]})})]}),showExtras!==null&&showExtras!==void 0&&showExtras.extras?showExtras===null||showExtras===void 0?void 0:(_showExtras$extras=showExtras.extras)===null||_showExtras$extras===void 0?void 0:_showExtras$extras.map((extra,idx)=>{return/*#__PURE__*/_jsx(\"div\",{className:\"extra-group\",children:/*#__PURE__*/_jsx(Space,{className:\"extras-select\",wrap:true,children:extra===null||extra===void 0?void 0:extra.map((item,itemIdx)=>{var _item$group,_item$group2;if((item===null||item===void 0?void 0:(_item$group=item.group)===null||_item$group===void 0?void 0:_item$group.type)==='color'){var _item$value;return/*#__PURE__*/_jsx(\"span\",{className:`extras-color-wrapper ${!!extrasIds.find(extra=>extra.id===item.id)?'selected':''}`,onClick:()=>handleExtrasClick(item),children:/*#__PURE__*/_jsx(\"i\",{className:\"extras-color\",style:{backgroundColor:item===null||item===void 0?void 0:(_item$value=item.value)===null||_item$value===void 0?void 0:_item$value.value}})},'color'+itemIdx);}else if((item===null||item===void 0?void 0:(_item$group2=item.group)===null||_item$group2===void 0?void 0:_item$group2.type)==='text'){var _item$value2;return/*#__PURE__*/_jsx(\"span\",{className:`extras-text rounded ${!!extrasIds.find(extra=>extra.id===item.id)?'selected':''}`,onClick:()=>handleExtrasClick(item),children:item===null||item===void 0?void 0:(_item$value2=item.value)===null||_item$value2===void 0?void 0:_item$value2.value},'text'+itemIdx);}return null;})})},'extra-group'+idx);}):null,/*#__PURE__*/_jsx(Space,{direction:\"vertical\",size:\"middle\"}),/*#__PURE__*/_jsx(Row,{gutter:12,className:\"mt-3\",children:/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(MinusOutlined,{}),onClick:reduceCounter},'plus'),(counter||1)*((productData===null||productData===void 0?void 0:productData.interval)||1),productData===null||productData===void 0?void 0:(_productData$unit=productData.unit)===null||_productData$unit===void 0?void 0:(_productData$unit$tra=_productData$unit.translation)===null||_productData$unit$tra===void 0?void 0:_productData$unit$tra.title,/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(PlusOutlined,{}),onClick:addCounter},'minus')]})})})]})});}","map":null,"metadata":{},"sourceType":"module"}