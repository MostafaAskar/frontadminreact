{"ast":null,"code":"import React,{useContext,useEffect,useState}from'react';import{Button,Space,Table,Card,Tabs,Tag,DatePicker,Tooltip}from'antd';import{useNavigate,useParams}from'react-router-dom';import{ClearOutlined,DeleteOutlined,EditOutlined,EyeOutlined,PlusCircleOutlined}from'@ant-design/icons';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addMenu,disableRefetch,setMenuData}from'redux/slices/menu';import{useTranslation}from'react-i18next';import useDidUpdate from'helpers/useDidUpdate';import{clearItems}from'redux/slices/orders';import{fetchParcelOrders}from'redux/slices/parcelOrders';import formatSortType from'helpers/formatSortType';import SearchInput from'components/search-input';import{clearOrder}from'redux/slices/order';import{DebounceSelect}from'components/search';import userService from'services/user';import FilterColumns from'components/filter-column';import{toast}from'react-toastify';import DeleteButton from'components/delete-button';import parcelOrderService from'../../services/parcelOrder';import{Context}from'context/context';import CustomModal from'components/modal';import moment from'moment';import{export_url}from'configs/app-global';import{BiMap}from'react-icons/bi';import{CgExport}from'react-icons/cg';import{batch}from'react-redux';import{useQueryParams}from'helpers/useQueryParams';import ParcelStatus from'./parcel-status';import ShowLocationsMap from'./show-locations-map';import ShowParcelDetails from'./show-parcel-details';import ParcelDeliveryman from'./parcel-deliveryman';import{fetchOrderStatus}from'redux/slices/orderStatus';import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const{TabPane}=Tabs;const{RangePicker}=DatePicker;export default function ParserOrders(){var _activeMenu$data,_activeMenu$data2,_activeMenu$data3,_dateRange$,_dateRange$2,_activeMenu$data4,_activeMenu$data5,_activeMenu$data6;const{type}=useParams();const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const{statusList,loading:roleLoading}=useSelector(state=>state.orderStatus,shallowEqual);const[orderDetails,setOrderDetails]=useState(null);const[locationsMap,setLocationsMap]=useState(null);const[parcelDeliveryDetails,setOrderDeliveryDetails]=useState(null);const[parcelId,setParcelId]=useState(null);const statuses=[{name:'all',id:'0',active:true,sort:0},...statusList];const goToEdit=row=>{dispatch(clearOrder());dispatch(addMenu({url:`parcel-orders/${row.id}`,id:'edit_parcel_order',name:t('edit.parcel.order')}));navigate(`/parcel-orders/${row.id}`);};const goToShow=row=>{setParcelId(row.id);};const[columns,setColumns]=useState([{title:t('id'),is_show:true,dataIndex:'id',key:'id',sorter:true},{title:t('client'),is_show:true,dataIndex:'user',key:'user',render:user=>/*#__PURE__*/_jsxs(\"div\",{children:[user===null||user===void 0?void 0:user.firstname,\" \",(user===null||user===void 0?void 0:user.lastname)||'']})},{title:t('status'),is_show:true,dataIndex:'status',key:'status',render:(status,row)=>/*#__PURE__*/_jsxs(\"div\",{className:\"cursor-pointer\",children:[status==='new'?/*#__PURE__*/_jsx(Tag,{color:\"blue\",children:t(status)}):status==='canceled'?/*#__PURE__*/_jsx(Tag,{color:\"error\",children:t(status)}):/*#__PURE__*/_jsx(Tag,{color:\"cyan\",children:t(status)}),status!=='delivered'&&status!=='canceled'?/*#__PURE__*/_jsx(EditOutlined,{onClick:e=>{e.stopPropagation();setOrderDetails(row);}}):'']})},{title:t('deliveryman'),is_show:true,dataIndex:'deliveryman',key:'deliveryman',render:(deliveryman,row)=>/*#__PURE__*/_jsx(\"div\",{children:(row===null||row===void 0?void 0:row.status)==='ready'&&(row===null||row===void 0?void 0:row.delivery_type)!=='pickup'?/*#__PURE__*/_jsx(Button,{type:\"link\",onClick:()=>setOrderDeliveryDetails(row),children:/*#__PURE__*/_jsxs(Space,{children:[deliveryman?`${deliveryman===null||deliveryman===void 0?void 0:deliveryman.firstname} ${deliveryman===null||deliveryman===void 0?void 0:deliveryman.lastname}`:t('add.deliveryman'),/*#__PURE__*/_jsx(EditOutlined,{})]})}):/*#__PURE__*/_jsxs(\"div\",{children:[deliveryman===null||deliveryman===void 0?void 0:deliveryman.firstname,\" \",deliveryman===null||deliveryman===void 0?void 0:deliveryman.lastname]})})},{title:t('payment.type'),is_show:true,dataIndex:'transaction',key:'transaction',render:transaction=>{var _transaction$payment_;return t(transaction===null||transaction===void 0?void 0:(_transaction$payment_=transaction.payment_system)===null||_transaction$payment_===void 0?void 0:_transaction$payment_.tag)||'-';}},{title:t('created.at'),is_show:true,dataIndex:'created_at',key:'created_at',render:date=>moment(date).format('YYYY-MM-DD HH:mm')},{title:t('delivery.date'),is_show:true,dataIndex:'delivery_date',key:'delivery_date',render:date=>moment(date).format('YYYY-MM-DD')},{title:t('options'),is_show:true,key:'options',render:(_,row)=>{return/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(BiMap,{}),onClick:e=>{e.stopPropagation();setLocationsMap(row.id);}}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(EyeOutlined,{}),onClick:e=>{e.stopPropagation();goToShow(row);}}),/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(EditOutlined,{}),onClick:e=>{e.stopPropagation();goToEdit(row);},disabled:row.status==='delivered'||row.status==='canceled'}),/*#__PURE__*/_jsx(DeleteButton,{icon:/*#__PURE__*/_jsx(DeleteOutlined,{}),onClick:e=>{e.stopPropagation();setId([row.id]);setIsModalVisible(true);setText(true);}})]});}}]);const{setIsModalVisible}=useContext(Context);const[downloading,setDownloading]=useState(false);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const queryParams=useQueryParams();const[role,setRole]=useState(queryParams.values.status||'all');const immutable=((_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.role)||role;const data=activeMenu.data;const[id,setId]=useState(null);const[text,setText]=useState(null);const[loadingBtn,setLoadingBtn]=useState(false);const[dateRange,setDateRange]=useState(moment().subtract(1,'months'),moment());const{data:orders,loading,params,meta}=useSelector(state=>state.parcelOrders,shallowEqual);const paramsData={search:data===null||data===void 0?void 0:data.search,sort:data===null||data===void 0?void 0:data.sort,column:data===null||data===void 0?void 0:data.column,perPage:data===null||data===void 0?void 0:data.perPage,page:data===null||data===void 0?void 0:data.page,user_id:data===null||data===void 0?void 0:data.user_id,status:immutable==='all'?undefined:immutable,shop_id:((_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:_activeMenu$data2.shop_id)!==null?(_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:_activeMenu$data3.shop_id:null,delivery_type:type!=='scheduled'?type:undefined,delivery_date_from:type==='scheduled'?moment().add(1,'day').format('YYYY-MM-DD'):undefined,date_from:dateRange?(_dateRange$=dateRange[0])===null||_dateRange$===void 0?void 0:_dateRange$.format('YYYY-MM-DD'):null,date_to:dateRange?(_dateRange$2=dateRange[1])===null||_dateRange$2===void 0?void 0:_dateRange$2.format('YYYY-MM-DD'):null};function onChangePagination(pagination,filters,sorter){const{pageSize:perPage,current:page}=pagination;const{field:column,order}=sorter;const sort=formatSortType(order);dispatch(setMenuData({activeMenu,data:{...data,perPage,page,column,sort}}));}const orderDelete=()=>{setLoadingBtn(true);const params={...Object.assign({},...id.map((item,index)=>({[`ids[${index}]`]:item})))};parcelOrderService.delete(params).then(()=>{toast.success(t('successfully.deleted'));setIsModalVisible(false);dispatch(fetchParcelOrders(paramsData));setText(null);setId(null);}).finally(()=>{setLoadingBtn(false);});};useDidUpdate(()=>{dispatch(fetchParcelOrders(paramsData));},[data,dateRange,type]);const handleFilter=(item,name)=>{dispatch(setMenuData({activeMenu,data:{...data,...{[name]:item}}}));};async function getUsers(search){const params={search,perPage:10};return userService.search(params).then(_ref=>{let{data}=_ref;return data.map(item=>({label:`${item===null||item===void 0?void 0:item.firstname} ${item===null||item===void 0?void 0:item.lastname}`,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id}));});}const goToOrderCreate=()=>{batch(()=>{dispatch(clearOrder());dispatch(addMenu({id:'parcel-orders/add',url:'parcel-orders/add',name:'add.parcel.order'}));});navigate('/parcel-orders/add');};const excelExport=()=>{setDownloading(true);const params=role!=='all'?{status:role}:null;parcelOrderService.export(params).then(res=>{var _res$data;window.location.href=export_url+(res===null||res===void 0?void 0:(_res$data=res.data)===null||_res$data===void 0?void 0:_res$data.file_name);}).finally(()=>setDownloading(false));};const onChangeTab=status=>{const orderStatus=status;dispatch(setMenuData({activeMenu,data:{role:orderStatus,page:1}}));setRole(status);navigate(`?status=${orderStatus}`);};const handleCloseModal=()=>{setOrderDetails(null);setOrderDeliveryDetails(null);setLocationsMap(null);setParcelId(null);};useEffect(()=>{if(activeMenu!==null&&activeMenu!==void 0&&activeMenu.refetch){batch(()=>{dispatch(fetchParcelOrders(paramsData));dispatch(disableRefetch(activeMenu));});}},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.refetch]);useEffect(()=>{dispatch(fetchOrderStatus({}));},[]);const rowSelection={selectedRowKeys:id,onChange:key=>{setId(key);}};const allDelete=()=>{if(id===null||id.length===0){toast.warning(t('select.the.product'));}else{setIsModalVisible(true);setText(false);}};const handleClear=()=>{batch(()=>{dispatch(clearItems());dispatch(setMenuData({activeMenu,data:null}));dispatch(fetchParcelOrders({status:undefined,page:data===null||data===void 0?void 0:data.page,perPage:20}));});setDateRange(undefined);};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Space,{className:\"justify-content-end w-100 mb-3\",children:/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(PlusCircleOutlined,{}),onClick:goToOrderCreate,style:{width:'100%'},children:t('add.parcel.order')})}),/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(Space,{wrap:true,className:\"order-filter\",children:[/*#__PURE__*/_jsx(SearchInput,{defaultValue:data===null||data===void 0?void 0:data.search,resetSearch:!(data!==null&&data!==void 0&&data.search),placeholder:t('search'),handleChange:search=>handleFilter(search,'search')}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.client'),fetchOptions:getUsers,onSelect:user=>handleFilter(user.value,'user_id'),onDeselect:()=>handleFilter(null,'user_id'),style:{width:'100%'},value:data===null||data===void 0?void 0:data.user_id}),/*#__PURE__*/_jsx(RangePicker,{value:dateRange,onChange:values=>setDateRange(values),disabledDate:current=>{return current&&current>moment().endOf('day');},style:{width:'100%'}}),/*#__PURE__*/_jsxs(Button,{onClick:excelExport,loading:downloading,style:{width:'100%'},children:[/*#__PURE__*/_jsx(CgExport,{className:\"mr-2\"}),t('export')]}),/*#__PURE__*/_jsx(Button,{onClick:handleClear,style:{width:'100%'},icon:/*#__PURE__*/_jsx(ClearOutlined,{}),children:t('clear')})]})}),/*#__PURE__*/_jsxs(Card,{loading:roleLoading,children:[/*#__PURE__*/_jsxs(Space,{className:\"justify-content-between align-items-start w-100\",children:[/*#__PURE__*/_jsx(Tabs,{onChange:onChangeTab,type:\"card\",activeKey:immutable,children:statuses.filter(ex=>ex.active===true).map(item=>{return/*#__PURE__*/_jsx(TabPane,{tab:t(item.name)},item.name);})}),/*#__PURE__*/_jsxs(Space,{children:[id!==null&&id.length!==0&&/*#__PURE__*/_jsx(Tooltip,{title:t('delete.selected'),children:/*#__PURE__*/_jsx(DeleteButton,{type:\"primary\",onClick:allDelete,danger:true})}),/*#__PURE__*/_jsx(FilterColumns,{setColumns:setColumns,columns:columns,iconOnly:true})]})]}),/*#__PURE__*/_jsx(Table,{scroll:{x:true},rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(items=>items.is_show),dataSource:orders,loading:loading,pagination:{pageSize:params.perPage,page:((_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:_activeMenu$data4.page)||1,total:meta.total,defaultCurrent:(_activeMenu$data5=activeMenu.data)===null||_activeMenu$data5===void 0?void 0:_activeMenu$data5.page,current:(_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:_activeMenu$data6.page},rowKey:record=>record.id,onChange:onChangePagination})]}),orderDetails&&/*#__PURE__*/_jsx(ParcelStatus,{orderDetails:orderDetails,handleCancel:handleCloseModal,status:statusList}),parcelDeliveryDetails&&/*#__PURE__*/_jsx(ParcelDeliveryman,{orderDetails:parcelDeliveryDetails,handleCancel:handleCloseModal}),locationsMap&&/*#__PURE__*/_jsx(ShowLocationsMap,{id:locationsMap,handleCancel:handleCloseModal}),!!parcelId&&/*#__PURE__*/_jsx(ShowParcelDetails,{id:parcelId,handleCancel:handleCloseModal}),/*#__PURE__*/_jsx(CustomModal,{click:orderDelete,text:text?t('delete'):t('all.delete'),loading:loadingBtn,setText:setId})]});}","map":null,"metadata":{},"sourceType":"module"}