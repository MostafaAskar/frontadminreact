{"ast":null,"code":"import React,{useState,useEffect}from'react';import{Button,Card,Col,DatePicker,Divider,Form,Input,InputNumber,Row,Select}from'antd';import{useNavigate,useParams}from'react-router-dom';import{toast}from'react-toastify';import{useLocation}from'react-router-dom';import{batch,shallowEqual,useDispatch,useSelector}from'react-redux';import{removeFromMenu,setMenuData}from'redux/slices/menu';import userService from'services/user';import{useTranslation}from'react-i18next';import moment from'moment';import MediaUpload from'components/upload';import{DebounceSelect}from'components/search';import shopService from'services/restaurant';import{fetchUsers}from'redux/slices/user';import deliveryService from'services/delivery';import getDefaultLocation from'helpers/getDefaultLocation';import DeliverySetting from'./deliveryman-settings';import{fetchDelivery}from'redux/slices/deliveries';import DeliverymanAddress from'./deliveryman-address';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";export default function UserAddRole(){var _activeMenu$data,_activeMenu$data2;const{t}=useTranslation();const[form]=Form.useForm();const[date,setDate]=useState();const[error,setError]=useState(null);const[loadingBtn,setLoadingBtn]=useState(false);const navigate=useNavigate();const user=useSelector(state=>state.user,shallowEqual);const{role}=useParams();const{settings}=useSelector(state=>state.globalSettings,shallowEqual);const[location,setLocation]=useState(getDefaultLocation(settings));useEffect(()=>{return()=>{const data=form.getFieldsValue(true);data.birthday=JSON.stringify(data===null||data===void 0?void 0:data.birthday);dispatch(setMenuData({activeMenu,data:{...activeMenu.data,...data}}));};// eslint-disable-next-line react-hooks/exhaustive-deps\n},[]);const changeData=(data,dataText)=>setDate(dataText);const locations=useLocation();const activeMenu=useSelector(list=>list.menu.activeMenu);const dispatch=useDispatch();const[image,setImage]=useState(activeMenu!==null&&activeMenu!==void 0&&(_activeMenu$data=activeMenu.data)!==null&&_activeMenu$data!==void 0&&_activeMenu$data.images?activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:_activeMenu$data2.images:[]);const[fields,setFields]=useState([]);async function fetchUserShop(search){const params={search,status:'approved'};return shopService.search(params).then(res=>res.data.map(item=>({label:item.translation!==null?item.translation.title:'no name',value:item.id,key:item.id})));}const onFinish=values=>{var _image$,_values$shop_id,_values$area,_values$city,_values$country,_values$region;setLoadingBtn(true);const body={firstname:values.firstname,lastname:values.lastname,email:values.user_email,phone:values.phone,birthday:date,gender:values.gender,password_confirmation:values.password_confirmation,password:values.password,images:image[0]?[(_image$=image[0])===null||_image$===void 0?void 0:_image$.name]:undefined,shop_id:values!==null&&values!==void 0&&values.shop_id?(values===null||values===void 0?void 0:values.shop_id.length)!==undefined?values===null||values===void 0?void 0:(_values$shop_id=values.shop_id)===null||_values$shop_id===void 0?void 0:_values$shop_id.map(item=>item.value):[values===null||values===void 0?void 0:values.shop_id.value]:undefined,role:role?role:undefined,online:Number(values.online),height:values.height,kg:values.kg,length:values.length,price:values.price,price_per_km:values.price_per_km,width:values.width,//user address\narea_id:values===null||values===void 0?void 0:(_values$area=values.area)===null||_values$area===void 0?void 0:_values$area.value,city_id:values===null||values===void 0?void 0:(_values$city=values.city)===null||_values$city===void 0?void 0:_values$city.value,country_id:values===null||values===void 0?void 0:(_values$country=values.country)===null||_values$country===void 0?void 0:_values$country.value,region_id:values===null||values===void 0?void 0:(_values$region=values.region)===null||_values$region===void 0?void 0:_values$region.value};const nextUrl=locations.pathname.search('/user/delivery/')?'deliveries/list':'users/admin';userService.create(body).then(_ref=>{let{data}=_ref;if(role==='deliveryman'){var _values$area2,_values$city2,_values$country2,_values$region2;const params={color:values.color,number:values.number,type_of_technique:values.type_of_technique,brand:values.brand,model:values.model,user_id:data.id,images:image.map(img=>img.name),location:{latitude:location.lat,longitude:location.lng},online:Number(values.online),height:values.height,kg:values.kg,length:values.length,price:values.price,price_per_km:values.price_per_km,width:values.width,//user address\narea_id:values===null||values===void 0?void 0:(_values$area2=values.area)===null||_values$area2===void 0?void 0:_values$area2.value,city_id:values===null||values===void 0?void 0:(_values$city2=values.city)===null||_values$city2===void 0?void 0:_values$city2.value,country_id:values===null||values===void 0?void 0:(_values$country2=values.country)===null||_values$country2===void 0?void 0:_values$country2.value,region_id:values===null||values===void 0?void 0:(_values$region2=values.region)===null||_values$region2===void 0?void 0:_values$region2.value};deliveryService.create(params).then(()=>{toast.success(t('successfully.created'));batch(()=>{dispatch(removeFromMenu({...activeMenu,nextUrl}));dispatch(locations.pathname.search('/user/delivery/')?fetchDelivery({}):fetchUsers({role:role}));});navigate(`/${nextUrl}`);});}else{const menu='users/admin';const userParamsData={...user.params,role:data.role};batch(()=>{dispatch(removeFromMenu({...activeMenu,menu}));dispatch(fetchUsers(userParamsData));});navigate(`/${menu}`);}// form.resetFields();\n}).catch(err=>{var _err$response,_err$response$data,_err$response3,_err$response3$data;if(!!(err!==null&&err!==void 0&&(_err$response=err.response)!==null&&_err$response!==void 0&&(_err$response$data=_err$response.data)!==null&&_err$response$data!==void 0&&_err$response$data.params)){var _Object$values,_err$response2,_err$response2$data;toast.dismiss();(_Object$values=Object.values(err===null||err===void 0?void 0:(_err$response2=err.response)===null||_err$response2===void 0?void 0:(_err$response2$data=_err$response2.data)===null||_err$response2$data===void 0?void 0:_err$response2$data.params))===null||_Object$values===void 0?void 0:_Object$values.map(errorArray=>toast.error(errorArray[0]));}setError(err===null||err===void 0?void 0:(_err$response3=err.response)===null||_err$response3===void 0?void 0:(_err$response3$data=_err$response3.data)===null||_err$response3$data===void 0?void 0:_err$response3$data.params);}).finally(()=>setLoadingBtn(false));};const getInitialTimes=()=>{var _activeMenu$data3,_activeMenu$data4;if(!((_activeMenu$data3=activeMenu.data)!==null&&_activeMenu$data3!==void 0&&_activeMenu$data3.birthday)){return{};}const birthday=JSON.parse((_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:_activeMenu$data4.birthday);return{birthday:moment(birthday)};};return/*#__PURE__*/_jsx(Card,{title:t('add.user'),children:/*#__PURE__*/_jsx(Form,{form:form,layout:\"vertical\",initialValues:{online:true,gender:'male',...activeMenu.data,...getInitialTimes()},onFinish:onFinish,children:/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{rules:[{required:!(image!==null&&image!==void 0&&image.length),message:t('required')}],name:\"images\",label:t('avatar'),children:/*#__PURE__*/_jsx(MediaUpload,{type:\"users\",imageList:image,setImageList:setImage,form:form,multiple:false})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('firstname'),name:\"firstname\",help:error!==null&&error!==void 0&&error.firstname?error.firstname[0]:null,validateStatus:error!==null&&error!==void 0&&error.firstname?'error':'success',rules:[{required:true,message:t('required')},{validator(_,value){var _value$trim;if(value&&(value===null||value===void 0?void 0:(_value$trim=value.trim())===null||_value$trim===void 0?void 0:_value$trim.length)<2){return Promise.reject(new Error(t('min.2.letters')));}return Promise.resolve();}},{pattern:new RegExp(/^[A-Za-z]+$/i),message:t('only.letters')}],children:/*#__PURE__*/_jsx(Input,{placeholder:t('type.here'),maxLength:20})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:'lastname',name:\"lastname\",help:error!==null&&error!==void 0&&error.lastname?error.lastname[0]:null,validateStatus:error!==null&&error!==void 0&&error.lastname?'error':'success',rules:[{required:true,message:t('required')},{validator(_,value){var _value$trim2;if(value&&(value===null||value===void 0?void 0:(_value$trim2=value.trim())===null||_value$trim2===void 0?void 0:_value$trim2.length)<2){return Promise.reject(new Error(t('min.2.letters')));}return Promise.resolve();}},{pattern:new RegExp(/^[A-Za-z]+$/i),message:t('only.letters')}],children:/*#__PURE__*/_jsx(Input,{placeholder:t('type.here'),maxLength:20})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('phone'),name:\"phone\",help:error!==null&&error!==void 0&&error.phone?error.phone[0]:null,validateStatus:error!==null&&error!==void 0&&error.phone?'error':'success',rules:[{required:true,message:t('required')},{type:'number',max:99999999,message:t('max.length.8')}],children:/*#__PURE__*/_jsx(InputNumber,{min:0,className:\"w-100\",placeholder:t('type.here')})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('birthday'),name:\"birthday\",rules:[{required:true,message:t('required')}],valuePropName:'date',children:/*#__PURE__*/_jsx(DatePicker,{onChange:changeData,className:\"w-100\",disabledDate:current=>moment().add(-18,'years')<=current,defaultPickerValue:moment().add(-18,'years')})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('gender'),name:\"gender\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsxs(Select,{picker:\"dayTime\",className:\"w-100\",children:[/*#__PURE__*/_jsx(Select.Option,{value:\"male\",children:t('male')}),/*#__PURE__*/_jsx(Select.Option,{value:\"female\",children:t('female')})]})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('email'),name:\"user_email\",help:error!==null&&error!==void 0&&error.email?error.email[0]:null,validateStatus:error!==null&&error!==void 0&&error.email?'error':'success',rules:[{required:true,message:t('required')},{type:'email',message:t('invalid.email')}],children:/*#__PURE__*/_jsx(Input,{type:\"email\",placeholder:t('type.here'),maxLength:20})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('password'),name:\"password\",help:error!==null&&error!==void 0&&error.password?error.password[0]:null,validateStatus:error!==null&&error!==void 0&&error.password?'error':'success',rules:[{required:true,message:t('required')},{validator(_,value){if(value&&(value===null||value===void 0?void 0:value.length)<6){return Promise.reject(new Error(t('min.6.letters')));}return Promise.resolve();}}],normalize:value=>(value===null||value===void 0?void 0:value.trim())===''?value===null||value===void 0?void 0:value.trim():value,children:/*#__PURE__*/_jsx(Input.Password,{type:\"password\",className:\"w-100\",placeholder:t('type.here'),maxLength:20})})}),role!=='admin'&&role!=='manager'&&role!=='moderator'&&role!=='seller'&&role!=='cook'&&role!=='user'&&/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('shop'),name:\"shop_id\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(DebounceSelect,{mode:\"multiple\",className:\"w-100\",placeholder:t('select.shop'),fetchOptions:fetchUserShop,allowClear:false})})}),role==='cook'&&/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('shop'),name:\"shop_id\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchUserShop,className:\"w-100\",placeholder:t('select.shop'),allowClear:false})})}),role==='moderator'&&/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('branches'),name:\"shop_id\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchUserShop,className:\"w-100\",placeholder:t('select.shop'),allowClear:false})})}),/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Form.Item,{label:t('password.confirmation'),help:error!==null&&error!==void 0&&error.password_confirmation?error.password_confirmation[0]:null,validateStatus:error!==null&&error!==void 0&&error.password_confirmation?'error':'success',name:\"password_confirmation\",dependencies:['password'],hasFeedback:true,rules:[{required:true,message:t('required')},_ref2=>{let{getFieldValue}=_ref2;return{validator(rule,value){if(!value||getFieldValue('password')===value){return Promise.resolve();}return Promise.reject(t('two.passwords.dont.match'));}};}],normalize:value=>(value===null||value===void 0?void 0:value.trim())===''?value===null||value===void 0?void 0:value.trim():value,children:/*#__PURE__*/_jsx(Input.Password,{type:\"password\",placeholder:t('type.here')})})}),role==='deliveryman'&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Divider,{className:\"pt-3 pb-3\",dashed:true,orientation:\"left\",plain:true,children:t('deliveryman.address')}),/*#__PURE__*/_jsx(DeliverymanAddress,{form:form})]}),role==='deliveryman'&&/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Divider,{className:\"pt-3 pb-3\",dashed:true,orientation:\"left\",plain:true,children:t('deliveryman.settings')}),/*#__PURE__*/_jsx(DeliverySetting,{setLocation:setLocation,location:location,setImage:setFields,image:fields,form:form})]}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Button,{type:\"primary\",htmlType:\"submit\",loading:loadingBtn,children:t('save')})})]})})});}","map":null,"metadata":{},"sourceType":"module"}