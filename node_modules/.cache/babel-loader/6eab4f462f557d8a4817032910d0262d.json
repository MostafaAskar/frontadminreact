{"ast":null,"code":"import React,{useEffect,useState,useContext}from'react';import{Button,Space,Table,Card,Tabs,Tag,Select,DatePicker}from'antd';import{useNavigate,useParams}from'react-router-dom';import{ClearOutlined,DeleteOutlined,EditOutlined,EyeOutlined,PlusCircleOutlined}from'@ant-design/icons';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addMenu,disableRefetch,setMenuData}from'redux/slices/menu';import{useTranslation}from'react-i18next';import useDidUpdate from'helpers/useDidUpdate';import{fetchOrders as fetchSellerOrders}from'redux/slices/sellerOrders';import formatSortType from'helpers/formatSortType';import SearchInput from'components/search-input';import{clearOrder}from'redux/slices/order';import numberToPrice from'helpers/numberToPrice';import{DebounceSelect}from'components/search';import userService from'services/seller/user';import FilterColumns from'components/filter-column';import{fetchRestOrderStatus}from'redux/slices/orderStatus';import DeleteButton from'components/delete-button';import{Context}from'context/context';import{toast}from'react-toastify';import CustomModal from'components/modal';import orderService from'services/seller/order';import{clearItems,fetchOrders}from'redux/slices/sellerOrders';import{batch}from'react-redux';import OrderDeliveryman from'./orderDeliveryman';import OrderStatusModal from'./orderStatusModal';import OrderTypeSwitcher from'./order-type-switcher';import{useQueryParams}from'helpers/useQueryParams';import moment from'moment';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const{RangePicker}=DatePicker;const{TabPane}=Tabs;export default function SellerOrder(){var _activeMenu$data,_activeMenu$data2,_activeMenu$data3,_activeMenu$data4,_activeMenu$data5,_dateRange$,_dateRange$2,_activeMenu$data6,_activeMenu$data7,_activeMenu$data8,_activeMenu$data9;const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const urlParams=useParams();const[id,setId]=useState(null);const[text,setText]=useState(null);const{setIsModalVisible}=useContext(Context);const[loadingBtn,setLoadingBtn]=useState(false);const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const{statusList}=useSelector(state=>state.orderStatus,shallowEqual);const orderType=urlParams===null||urlParams===void 0?void 0:urlParams.type;const statuses=[{name:'all',id:0,active:true,sort:0},...statusList];const[orderDeliveryDetails,setOrderDeliveryDetails]=useState(null);const[orderId,setOrderId]=useState(null);const goToShow=row=>{dispatch(addMenu({url:`seller/order/details/${row.id}`,id:'order_details',name:t('order.details')}));navigate(`/seller/order/details/${row.id}`);};const[columns,setColumns]=useState([{title:t('id'),dataIndex:'id',key:'id',sorter:true,is_show:true},{title:t('client'),dataIndex:'user',key:'user',is_show:true,render:user=>{if(!user){return/*#__PURE__*/_jsx(Tag,{color:\"red\",children:t('deleted.user')});}return/*#__PURE__*/_jsxs(\"div\",{children:[(user===null||user===void 0?void 0:user.firstname)||'',\" \",(user===null||user===void 0?void 0:user.lastname)||'']});}},{title:t('status'),is_show:true,dataIndex:'status',key:'status',render:(status,row)=>/*#__PURE__*/_jsxs(\"div\",{className:\"cursor-pointer\",children:[status==='new'?/*#__PURE__*/_jsx(Tag,{color:\"blue\",children:t(status)}):status==='canceled'?/*#__PURE__*/_jsx(Tag,{color:\"error\",children:t(status)}):/*#__PURE__*/_jsx(Tag,{color:\"cyan\",children:t(status)}),status!=='delivered'&&status!=='canceled'&&row.type!==1?/*#__PURE__*/_jsx(EditOutlined,{onClick:e=>{e.stopPropagation();setOrderId(row===null||row===void 0?void 0:row.id);}}):'']})},{title:t('deliveryman'),is_show:true,dataIndex:'deliveryman',key:'deliveryman',render:deliveryman=>/*#__PURE__*/_jsxs(\"div\",{children:[(deliveryman===null||deliveryman===void 0?void 0:deliveryman.firstname)||'-',\" \",(deliveryman===null||deliveryman===void 0?void 0:deliveryman.lastname)||'-']})},{title:t('number.of.products'),dataIndex:'order_details_count',key:'order_details_count',is_show:true,render:order_details_count=>{return/*#__PURE__*/_jsxs(\"div\",{className:\"text-lowercase\",children:[order_details_count||0,\" \",t('products')]});}},{title:t('amount'),dataIndex:'total_price',key:'total_price',is_show:true,render:total_price=>numberToPrice(total_price,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol)},{title:t('payment.type'),dataIndex:'transaction',key:'transaction',is_show:true,render:transaction=>{var _transaction$payment_;return t(transaction===null||transaction===void 0?void 0:(_transaction$payment_=transaction.payment_system)===null||_transaction$payment_===void 0?void 0:_transaction$payment_.tag)||'-';}},{title:t('created.at'),is_show:true,dataIndex:'created_at',key:'created_at',render:created_at=>moment(created_at).format('YYYY-MM-DD HH:mm')},{title:t('delivery.date'),is_show:true,dataIndex:'delivery_date',key:'delivery_date',render:delivery_date=>moment(delivery_date).format('YYYY-MM-DD HH:mm')},{title:t('options'),key:'options',is_show:true,render:(_,row)=>{return/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(EyeOutlined,{}),onClick:()=>goToShow(row)}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(EditOutlined,{}),onClick:()=>goToEdit(row),disabled:(row===null||row===void 0?void 0:row.type)!==2||(row===null||row===void 0?void 0:row.status)==='canceled'||(row===null||row===void 0?void 0:row.status)==='delivered'}),/*#__PURE__*/_jsx(DeleteButton,{icon:/*#__PURE__*/_jsx(DeleteOutlined,{}),onClick:()=>{setId([row.id]);setIsModalVisible(true);setText(true);}})]});}}]);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const querryParams=useQueryParams();const[role,setRole]=useState(querryParams.values.status||'all');const immutable=((_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.role)||role;const{orders,meta,loading,params}=useSelector(state=>state.sellerOrders,shallowEqual);const[dateRange,setDateRange]=useState(null);const data=activeMenu===null||activeMenu===void 0?void 0:activeMenu.data;const paramsData={search:data===null||data===void 0?void 0:data.search,sort:data===null||data===void 0?void 0:data.sort,column:data===null||data===void 0?void 0:data.column,perPage:data===null||data===void 0?void 0:data.perPage,page:data===null||data===void 0?void 0:data.page,user_id:data===null||data===void 0?void 0:data.user_id,status:immutable==='all'?undefined:immutable,shop_id:((_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:_activeMenu$data2.shop_id)!==null?(_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:_activeMenu$data3.shop_id:null,delivery_type:orderType?orderType:((_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:_activeMenu$data4.delivery_type)!==null?(_activeMenu$data5=activeMenu.data)===null||_activeMenu$data5===void 0?void 0:_activeMenu$data5.delivery_type:null,date_from:(dateRange===null||dateRange===void 0?void 0:(_dateRange$=dateRange[0])===null||_dateRange$===void 0?void 0:_dateRange$.format('YYYY-MM-DD'))||undefined,date_to:(dateRange===null||dateRange===void 0?void 0:(_dateRange$2=dateRange[1])===null||_dateRange$2===void 0?void 0:_dateRange$2.format('YYYY-MM-DD'))||undefined};function onChangePagination(pagination,filters,sorter){const{pageSize:perPage,current:page}=pagination;const{field:column,order}=sorter;const sort=formatSortType(order);dispatch(setMenuData({activeMenu,data:{...data,perPage,page,column,sort}}));}const orderDelete=()=>{setLoadingBtn(true);const params={...Object.assign({},...id.map((item,index)=>({[`ids[${index}]`]:item})))};orderService.delete(params).then(()=>{toast.success(t('successfully.deleted'));setIsModalVisible(false);dispatch(fetchSellerOrders(paramsData));setText(null);}).finally(()=>setLoadingBtn(false));};useDidUpdate(()=>{dispatch(fetchSellerOrders(paramsData));},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.data,dateRange]);useEffect(()=>{if(activeMenu!==null&&activeMenu!==void 0&&activeMenu.refetch){batch(()=>{dispatch(fetchSellerOrders(paramsData));dispatch(fetchRestOrderStatus({}));dispatch(disableRefetch(activeMenu));});}},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.refetch]);const handleFilter=(item,name)=>{dispatch(setMenuData({activeMenu,data:{...data,[name]:item}}));};async function getUsers(search){const params={search,perPage:10};return userService.getAll(params).then(_ref=>{let{data}=_ref;return data.map(item=>({label:`${item.firstname} ${item.lastname}`,value:item.id,key:item.id}));});}const goToAddOrder=()=>{dispatch(clearOrder());dispatch(addMenu({id:'pos.system',url:'seller/pos-system',name:t('add.order')}));navigate('/seller/pos-system',{state:{delivery_type:orderType}});};const goToEdit=row=>{batch(()=>{dispatch(clearOrder());dispatch(addMenu({url:`seller/order/${row.id}`,id:'seller_order_edit',name:t('edit.order')}));});navigate(`/seller/order/${row.id}`);};const onChangeTab=status=>{const orderStatus=status;dispatch(setMenuData({activeMenu,data:{role:orderStatus,page:1}}));setRole(status);navigate(`?status=${orderStatus}`);};const rowSelection={selectedRowKeys:id,onChange:key=>{setId(key);}};const allDelete=()=>{if(id===null||id.length===0){toast.warning(t('select.the.product'));}else{setIsModalVisible(true);setText(false);}};const handleClear=()=>{batch(()=>{dispatch(clearItems());dispatch(setMenuData({activeMenu,data:null}));});dispatch(fetchOrders({status:'all',page:data===null||data===void 0?void 0:data.page,perPage:10}));};const handleCloseModal=()=>{setOrderDeliveryDetails(null);setOrderId(null);};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Space,{className:\"justify-content-end w-100 mb-3\",children:[/*#__PURE__*/_jsx(OrderTypeSwitcher,{listType:\"seller/orders\"}),/*#__PURE__*/_jsx(Button,{type:\"primary\",icon:/*#__PURE__*/_jsx(PlusCircleOutlined,{}),onClick:goToAddOrder,style:{width:'100%'},children:t('add.order')})]}),/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(Space,{wrap:true,className:\"p-0 mb-0\",children:[/*#__PURE__*/_jsx(SearchInput,{placeholder:t('search'),handleChange:search=>handleFilter(search,'search'),defaultValue:(_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:_activeMenu$data6.search}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.client'),fetchOptions:getUsers,onSelect:user=>handleFilter(user.value,'search'),onDeselect:()=>handleFilter(null,'search'),style:{minWidth:200}}),/*#__PURE__*/_jsx(RangePicker,{value:dateRange,onChange:values=>{handleFilter(JSON.stringify(values),'data_time');setDateRange(values);},disabledDate:current=>{return current&&current>moment().endOf('day');},style:{width:'100%'}}),!orderType&&/*#__PURE__*/_jsx(Select,{value:data===null||data===void 0?void 0:data.delivery_type,placeholder:t('order.type'),onSelect:type=>handleFilter(type,'delivery_type'),options:[{label:t('pickup'),value:'pickup'},{label:t('delivery'),value:'delivery'}],allowClear:true,style:{width:'100%'},onDeselect:()=>handleFilter(null,'delivery_type')}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(ClearOutlined,{}),onClick:handleClear,children:t('clear')}),/*#__PURE__*/_jsx(DeleteButton,{size:\"\",onClick:allDelete,children:t('delete.selected')}),/*#__PURE__*/_jsx(FilterColumns,{columns:columns,setColumns:setColumns})]})}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsx(Tabs,{onChange:onChangeTab,type:\"card\",activeKey:immutable,children:statuses.filter(ex=>ex.active===true).map(item=>{return/*#__PURE__*/_jsx(TabPane,{tab:t(item.name)},item.name);})}),/*#__PURE__*/_jsx(Table,{scroll:{x:true},rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(item=>item.is_show),dataSource:orders,loading:loading,pagination:{pageSize:params.perPage,page:((_activeMenu$data7=activeMenu.data)===null||_activeMenu$data7===void 0?void 0:_activeMenu$data7.page)||1,total:meta===null||meta===void 0?void 0:meta.total,defaultCurrent:(_activeMenu$data8=activeMenu.data)===null||_activeMenu$data8===void 0?void 0:_activeMenu$data8.page,current:(_activeMenu$data9=activeMenu.data)===null||_activeMenu$data9===void 0?void 0:_activeMenu$data9.page},rowKey:record=>record.id,onChange:onChangePagination}),/*#__PURE__*/_jsx(CustomModal,{click:orderDelete,text:text?t('delete'):t('all.delete'),loading:loadingBtn,setText:setId})]}),orderId&&/*#__PURE__*/_jsx(OrderStatusModal,{orderId:orderId,handleCancel:handleCloseModal,refetchPage:()=>batch(()=>{dispatch(fetchOrders(paramsData));dispatch(disableRefetch(activeMenu));})}),orderDeliveryDetails&&/*#__PURE__*/_jsx(OrderDeliveryman,{orderDetails:orderDeliveryDetails,handleCancel:handleCloseModal})]});}","map":null,"metadata":{},"sourceType":"module"}