{"ast":null,"code":"import React,{useContext,useEffect,useState}from'react';import{Button,Space,Table,Card,Tabs,Tag,DatePicker,Tooltip}from'antd';import{useNavigate,useParams}from'react-router-dom';import{ClearOutlined,DeleteOutlined,DownloadOutlined,EyeOutlined}from'@ant-design/icons';import{shallowEqual,useDispatch,useSelector}from'react-redux';import{addMenu,disableRefetch,setMenuData}from'redux/slices/menu';import{useTranslation}from'react-i18next';import useDidUpdate from'helpers/useDidUpdate';import{clearItems,fetchOrders}from'redux/slices/orders';import formatSortType from'helpers/formatSortType';import SearchInput from'components/search-input';import numberToPrice from'helpers/numberToPrice';import{DebounceSelect}from'components/search';import userService from'services/user';import FilterColumns from'components/filter-column';import{fetchOrderStatus}from'redux/slices/orderStatus';import ShowLocationsMap from'./show-locations.map';import DownloadModal from'./downloadModal';import{toast}from'react-toastify';import DeleteButton from'components/delete-button';import orderService from'services/order';import{Context}from'context/context';import CustomModal from'components/modal';import moment from'moment';import{export_url}from'configs/app-global';import{BiMap}from'react-icons/bi';import{CgExport}from'react-icons/cg';import shopService from'services/restaurant';import{batch}from'react-redux';import{useQueryParams}from'helpers/useQueryParams';import regionService from'services/deliveryzone/region';import countryService from'services/deliveryzone/country';import cityService from'services/deliveryzone/city';import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const{TabPane}=Tabs;const{RangePicker}=DatePicker;export default function OrderList(){var _activeMenu$data,_data$region,_data$country,_data$city,_activeMenu$data2,_activeMenu$data3,_dateRange$,_dateRange$2,_data$region2,_data$country2,_data$region3,_activeMenu$data6,_activeMenu$data7,_activeMenu$data8;const{type}=useParams();const dispatch=useDispatch();const navigate=useNavigate();const{t}=useTranslation();const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const{statusList}=useSelector(state=>state.orderStatus,shallowEqual);const[locationsMap,setLocationsMap]=useState(null);const[downloadModal,setDownloadModal]=useState(null);const statuses=[{name:'all',id:'0',active:true,sort:0},...statusList];const goToShow=row=>{dispatch(addMenu({url:`order/details/seller/${row.id}`,id:'order_details',name:t('order.details')}));navigate(`/order/details/seller/${row.id}`);};const[columns,setColumns]=useState([{title:t('id'),is_show:true,dataIndex:'id',key:'id',sorter:true},{title:t('client'),is_show:true,dataIndex:'user',key:'user',render:user=>/*#__PURE__*/_jsxs(\"div\",{children:[user===null||user===void 0?void 0:user.firstname,\" \",(user===null||user===void 0?void 0:user.lastname)||'']})},{title:t('status'),is_show:true,dataIndex:'status',key:'status',render:(status,row)=>/*#__PURE__*/_jsx(\"div\",{className:\"cursor-pointer\",children:status==='new'?/*#__PURE__*/_jsx(Tag,{color:\"blue\",children:t(status)}):status==='canceled'?/*#__PURE__*/_jsx(Tag,{color:\"error\",children:t(status)}):/*#__PURE__*/_jsx(Tag,{color:\"cyan\",children:t(status)})})},{title:t('deliveryman'),is_show:true,dataIndex:'deliveryman',key:'deliveryman',render:(deliveryman,row)=>/*#__PURE__*/_jsx(\"div\",{children:row.status==='ready'&&row.delivery_type!=='pickup'?null:/*#__PURE__*/_jsxs(\"div\",{children:[deliveryman===null||deliveryman===void 0?void 0:deliveryman.firstname,\" \",deliveryman===null||deliveryman===void 0?void 0:deliveryman.lastname]})})},{title:t('number.of.products'),dataIndex:'order_details_count',key:'order_details_count',is_show:true,render:order_details_count=>{return/*#__PURE__*/_jsxs(\"div\",{className:\"text-lowercase\",children:[order_details_count||0,\" \",t('products')]});}},{title:t('amount'),is_show:true,dataIndex:'total_price',key:'total_price',render:(total_price,row)=>{var _row$transaction,_row$transaction2;const status=(_row$transaction=row.transaction)===null||_row$transaction===void 0?void 0:_row$transaction.status;return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"span\",{children:numberToPrice(total_price,defaultCurrency.symbol)}),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsx(\"span\",{className:status==='progress'?'text-primary':status==='paid'?'text-success':status==='rejected'?'text-danger':'text-info',children:(_row$transaction2=row.transaction)===null||_row$transaction2===void 0?void 0:_row$transaction2.status})]});}},{title:t('payment.type'),is_show:true,dataIndex:'transaction',key:'transaction',render:transaction=>{var _transaction$payment_;return t(transaction===null||transaction===void 0?void 0:(_transaction$payment_=transaction.payment_system)===null||_transaction$payment_===void 0?void 0:_transaction$payment_.tag)||'-';}},{title:t('created.at'),is_show:true,dataIndex:'created_at',key:'created_at',render:created_at=>moment(created_at).format('YYYY-MM-DD HH:mm')},{title:t('delivery.date'),is_show:true,dataIndex:'delivery_date',key:'delivery_date',render:delivery_date=>moment(delivery_date).format('YYYY-MM-DD HH:mm')},{title:t('options'),is_show:true,key:'options',render:(_,row)=>{return/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(BiMap,{}),onClick:e=>{e.stopPropagation();setLocationsMap(row.id);}}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(EyeOutlined,{}),onClick:e=>{e.stopPropagation();goToShow(row);}}),/*#__PURE__*/_jsx(DeleteButton,{icon:/*#__PURE__*/_jsx(DeleteOutlined,{}),onClick:e=>{e.stopPropagation();setId([row.id]);setIsModalVisible(true);setText(true);}}),/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(DownloadOutlined,{}),onClick:e=>{e.stopPropagation();setDownloadModal(row.id);}})]});}}]);const{setIsModalVisible}=useContext(Context);const[downloading,setDownloading]=useState(false);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const queryParams=useQueryParams();const[role,setRole]=useState(queryParams.values.status||'all');const immutable=((_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.role)||role;const[id,setId]=useState(null);const[text,setText]=useState(null);const[loadingBtn,setLoadingBtn]=useState(false);const[dateRange,setDateRange]=useState(moment().subtract(1,'months'),moment());const{orders,loading,params,meta}=useSelector(state=>state.orders,shallowEqual);const data=activeMenu.data;const paramsData={search:data===null||data===void 0?void 0:data.search,sort:data===null||data===void 0?void 0:data.sort,column:data===null||data===void 0?void 0:data.column,perPage:data===null||data===void 0?void 0:data.perPage,page:data===null||data===void 0?void 0:data.page,user_id:data===null||data===void 0?void 0:data.user_id,region_id:data===null||data===void 0?void 0:(_data$region=data.region)===null||_data$region===void 0?void 0:_data$region.value,country_id:data===null||data===void 0?void 0:(_data$country=data.country)===null||_data$country===void 0?void 0:_data$country.value,city_id:data===null||data===void 0?void 0:(_data$city=data.city)===null||_data$city===void 0?void 0:_data$city.value,status:immutable==='all'?undefined:immutable,type:'2',shop_id:((_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:_activeMenu$data2.shop_id)!==null?(_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:_activeMenu$data3.shop_id:null,delivery_type:type!=='scheduled'?type:undefined,delivery_date_from:type==='scheduled'?moment().add(1,'day').format('YYYY-MM-DD'):undefined,date_from:(dateRange===null||dateRange===void 0?void 0:(_dateRange$=dateRange[0])===null||_dateRange$===void 0?void 0:_dateRange$.format('YYYY-MM-DD'))||null,date_to:(dateRange===null||dateRange===void 0?void 0:(_dateRange$2=dateRange[1])===null||_dateRange$2===void 0?void 0:_dateRange$2.format('YYYY-MM-DD'))||null};function onChangePagination(pagination,filters,sorter){const{pageSize:perPage,current:page}=pagination;const{field:column,order}=sorter;const sort=formatSortType(order);dispatch(setMenuData({activeMenu,data:{...data,perPage,page,column,sort}}));}const orderDelete=()=>{setLoadingBtn(true);const params={...Object.assign({},...id.map((item,index)=>({[`ids[${index}]`]:item})))};orderService.delete(params).then(()=>{toast.success(t('successfully.deleted'));setIsModalVisible(false);dispatch(fetchOrders(paramsData));setText(null);}).finally(()=>{setId(null);setLoadingBtn(false);});};useDidUpdate(()=>{dispatch(fetchOrders(paramsData));},[data,dateRange,type]);const handleFilter=(item,name)=>{dispatch(setMenuData({activeMenu,data:{...data,...{[name]:item}}}));};async function getUsers(search){const params={search,perPage:10};return userService.search(params).then(_ref=>{let{data}=_ref;return data.map(item=>({label:`${item===null||item===void 0?void 0:item.firstname} ${item===null||item===void 0?void 0:item.lastname}`,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id}));});}const excelExport=()=>{setDownloading(true);orderService.export(paramsData).then(res=>{var _res$data;return window.location.href=export_url+(res===null||res===void 0?void 0:(_res$data=res.data)===null||_res$data===void 0?void 0:_res$data.file_name);}).finally(()=>setDownloading(false));};const onChangeTab=status=>{const orderStatus=status;dispatch(setMenuData({activeMenu,data:{role:orderStatus,page:1}}));setRole(status);navigate(`?status=${orderStatus}`);};const handleCloseModal=()=>{setLocationsMap(null);setDownloadModal(null);};async function fetchShops(search){const params={search,status:'approved'};return shopService.getAll(params).then(_ref2=>{let{data}=_ref2;return data.map(item=>{var _item$translation;return{label:item===null||item===void 0?void 0:(_item$translation=item.translation)===null||_item$translation===void 0?void 0:_item$translation.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});}const fetchRegions=search=>{const params={search,perPage:10,page:1};return regionService.get(params).then(_ref3=>{let{data}=_ref3;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation2;return{label:item===null||item===void 0?void 0:(_item$translation2=item.translation)===null||_item$translation2===void 0?void 0:_item$translation2.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});};const fetchCountry=search=>{var _activeMenu$data4,_activeMenu$data4$reg;const params={search,perPage:10,page:1,region_id:activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:(_activeMenu$data4$reg=_activeMenu$data4.region)===null||_activeMenu$data4$reg===void 0?void 0:_activeMenu$data4$reg.value};return countryService.get(params).then(_ref4=>{let{data}=_ref4;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation3;return{label:item===null||item===void 0?void 0:(_item$translation3=item.translation)===null||_item$translation3===void 0?void 0:_item$translation3.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});};const fetchCity=search=>{var _activeMenu$data5,_activeMenu$data5$cou;const params={search,perPage:10,page:1,country_id:activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data5=activeMenu.data)===null||_activeMenu$data5===void 0?void 0:(_activeMenu$data5$cou=_activeMenu$data5.country)===null||_activeMenu$data5$cou===void 0?void 0:_activeMenu$data5$cou.value};return cityService.get(params).then(_ref5=>{let{data}=_ref5;return data===null||data===void 0?void 0:data.map(item=>{var _item$translation4;return{label:item===null||item===void 0?void 0:(_item$translation4=item.translation)===null||_item$translation4===void 0?void 0:_item$translation4.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});});};useEffect(()=>{if(activeMenu!==null&&activeMenu!==void 0&&activeMenu.refetch){batch(()=>{dispatch(fetchOrders(paramsData));dispatch(disableRefetch(activeMenu));});}},[activeMenu===null||activeMenu===void 0?void 0:activeMenu.refetch]);useEffect(()=>{dispatch(fetchOrderStatus({}));},[]);const rowSelection={selectedRowKeys:id,onChange:key=>{setId(key);}};const allDelete=()=>{if(id===null||id.length===0){toast.warning(t('select.the.product'));}else{setIsModalVisible(true);setText(false);}};const handleClear=()=>{batch(()=>{dispatch(clearItems());dispatch(setMenuData({activeMenu,data:null}));dispatch(fetchOrders({status:null,page:data===null||data===void 0?void 0:data.page,perPage:20}));});};return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(Space,{className:\"justify-content-end w-100 mb-3\",children:[/*#__PURE__*/_jsxs(Button,{onClick:excelExport,loading:downloading,style:{width:'100%'},children:[/*#__PURE__*/_jsx(CgExport,{className:\"mr-2\"}),t('export')]}),/*#__PURE__*/_jsx(Button,{onClick:handleClear,style:{width:'100%'},icon:/*#__PURE__*/_jsx(ClearOutlined,{}),children:t('clear')})]}),/*#__PURE__*/_jsx(Card,{children:/*#__PURE__*/_jsxs(Space,{wrap:true,className:\"order-filter\",children:[/*#__PURE__*/_jsx(SearchInput,{defaultValue:data===null||data===void 0?void 0:data.search,resetSearch:!(data!==null&&data!==void 0&&data.search),placeholder:t('search'),handleChange:search=>handleFilter(search,'search')}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.shop'),fetchOptions:fetchShops,style:{width:'100%'},onSelect:shop=>handleFilter(shop.value,'shop_id'),onDeselect:()=>handleFilter(null,'shop_id'),allowClear:true,value:data===null||data===void 0?void 0:data.shop_id}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.client'),fetchOptions:getUsers,onSelect:user=>handleFilter(user.value,'user_id'),onDeselect:()=>handleFilter(null,'user_id'),style:{width:'100%'},value:data===null||data===void 0?void 0:data.user_id}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.region'),fetchOptions:fetchRegions,onSelect:region=>{dispatch(setMenuData({activeMenu,data:{...data,region,country:null,city:null}}));},onDeselect:()=>{dispatch(setMenuData({activeMenu,data:{...data,region:null,country:null,city:null}}));},allowClear:true,style:{width:'100%'},value:data===null||data===void 0?void 0:data.region,autoComplete:'none'}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.country'),fetchOptions:fetchCountry,refetchOptions:true,onSelect:country=>{dispatch(setMenuData({activeMenu,data:{...data,country,city:null}}));},onDeselect:()=>{dispatch(setMenuData({activeMenu,data:{...data,country:null,city:null}}));},style:{width:'100%'},value:data===null||data===void 0?void 0:data.country,autoComplete:'none',disabled:!(data!==null&&data!==void 0&&(_data$region2=data.region)!==null&&_data$region2!==void 0&&_data$region2.value),allowClear:true}),/*#__PURE__*/_jsx(DebounceSelect,{placeholder:t('select.city'),fetchOptions:fetchCity,refetchOptions:true,onSelect:city=>dispatch(setMenuData({activeMenu,data:{...data,city}})),onDeselect:()=>dispatch(setMenuData({activeMenu,data:{...data,city:null}})),style:{width:'100%'},value:data===null||data===void 0?void 0:data.city,autoComplete:'none',disabled:!(data!==null&&data!==void 0&&(_data$country2=data.country)!==null&&_data$country2!==void 0&&_data$country2.value)||!(data!==null&&data!==void 0&&(_data$region3=data.region)!==null&&_data$region3!==void 0&&_data$region3.value),allowClear:true}),/*#__PURE__*/_jsx(RangePicker,{value:dateRange,onChange:values=>{handleFilter(prev=>{var _values$,_values$2;return{...prev,...{date_from:values===null||values===void 0?void 0:(_values$=values[0])===null||_values$===void 0?void 0:_values$.format('YYYY-MM-DD'),date_to:values===null||values===void 0?void 0:(_values$2=values[1])===null||_values$2===void 0?void 0:_values$2.format('YYYY-MM-DD')}};});setDateRange(values);},disabledDate:current=>{return current&&current>moment().endOf('day');},style:{width:'100%'}})]})}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(Space,{className:\"justify-content-between align-items-start w-100\",children:[/*#__PURE__*/_jsx(Tabs,{onChange:onChangeTab,type:\"card\",activeKey:immutable,children:statuses.filter(ex=>ex.active===true).map(item=>{return/*#__PURE__*/_jsx(TabPane,{tab:t(item.name)},item.name);})}),/*#__PURE__*/_jsxs(Space,{children:[/*#__PURE__*/_jsx(Tooltip,{title:t('delete.selected'),children:/*#__PURE__*/_jsx(DeleteButton,{type:\"primary\",onClick:allDelete})}),/*#__PURE__*/_jsx(FilterColumns,{setColumns:setColumns,columns:columns,iconOnly:true})]})]}),/*#__PURE__*/_jsx(Table,{scroll:{x:true},rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(items=>items.is_show),dataSource:orders,loading:loading,pagination:{pageSize:params.perPage,page:((_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:_activeMenu$data6.page)||1,// total: statistic?.orders_count,\ntotal:meta===null||meta===void 0?void 0:meta.total,defaultCurrent:(_activeMenu$data7=activeMenu.data)===null||_activeMenu$data7===void 0?void 0:_activeMenu$data7.page,current:(_activeMenu$data8=activeMenu.data)===null||_activeMenu$data8===void 0?void 0:_activeMenu$data8.page},rowKey:record=>record.id,onChange:onChangePagination,onRow:record=>{return{onClick:()=>{goToShow(record);}};}})]}),locationsMap&&/*#__PURE__*/_jsx(ShowLocationsMap,{id:locationsMap,handleCancel:handleCloseModal}),downloadModal&&/*#__PURE__*/_jsx(DownloadModal,{id:downloadModal,handleCancel:handleCloseModal}),/*#__PURE__*/_jsx(CustomModal,{click:orderDelete,text:text?t('delete'):t('all.delete'),loading:loadingBtn,setText:setId})]});}","map":null,"metadata":{},"sourceType":"module"}