{"ast":null,"code":"import{Card,Col,Row,Space,Typography,Table,Tag,Button,DatePicker,Spin}from'antd';import React,{useContext,useEffect,useState}from'react';import{CloudDownloadOutlined}from'@ant-design/icons';import ReportService from'../../services/reports';import{disableRefetch}from'../../redux/slices/menu';import{shallowEqual,useDispatch,useSelector}from'react-redux';import moment from'moment';import{ReportContext}from'../../context/report';import FilterColumns from'../../components/filter-column';import useDidUpdate from'../../helpers/useDidUpdate';import{useLocation}from'react-router-dom';import QueryString from'qs';import{t}from'i18next';import numberToPrice from'../../helpers/numberToPrice';import{fetchExtrasChart,fetchExtrasList}from'../../redux/slices/report/extras';import ReportChart from'../../components/report/chart';import{useMemo}from'react';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const{Text,Title}=Typography;const{RangePicker}=DatePicker;const ReportExtras=()=>{const dispatch=useDispatch();const location=useLocation();const category_id=QueryString.parse(location.search,[])['?category_id'];const product_id=QueryString.parse(location.search,[])['?product_id'];const{date_from,date_to,by_time,chart,handleChart,handleDateRange}=useContext(ReportContext);const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const{loading,chartData:reportData,extrasList}=useSelector(state=>state.extrasReport,shallowEqual);const[selectedRowKeys,setSelectedRowKeys]=useState([]);const[downloading,setDownloading]=useState(false);const[search,setSearch]=useState('');const{defaultCurrency}=useSelector(state=>state.currency,shallowEqual);const[columns,setColumns]=useState([{title:t('title'),dataIndex:'translation_title',key:'translation_title',render:(_,data)=>{return data===null||data===void 0?void 0:data.title;},is_show:true,sorter:(a,b)=>{var _a$translation,_b$translation;return a===null||a===void 0?void 0:(_a$translation=a.translation)===null||_a$translation===void 0?void 0:_a$translation.title.localeCompare(b===null||b===void 0?void 0:(_b$translation=b.translation)===null||_b$translation===void 0?void 0:_b$translation.title);}},{title:t('order.count'),key:'count',dataIndex:'count',is_show:true,sorter:(a,b)=>a.quantity-b.quantity},{title:t('price'),dataIndex:'price',key:'price',is_show:true,render:(_,data)=>numberToPrice(data===null||data===void 0?void 0:data.total_price,defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol),sorter:(a,b)=>a.price-b.price},{title:t('quantity'),key:'quantity',dataIndex:'quantity',is_show:true,sorter:(a,b)=>a.quantity-b.quantity},{title:t('status'),key:'active',dataIndex:'active',render:(_,data)=>{const status=Boolean(data===null||data===void 0?void 0:data.active);return/*#__PURE__*/_jsx(Tag,{color:status?'green':'red',children:status?'Active':'Inactive'},data.id);},is_show:true}// {\n//   title: t('stock'),\n//   key: 'stocks_total',\n//   dataIndex: 'stocks_total',\n//   is_show: true,\n//   render: (_, data) => {\n//     return data.stocks?.map((stock) => stock.quantity);\n//   },\n// },\n]);const chart_type=useMemo(()=>[{label:'item.sold',value:'avg_quantity',qty:'quantity',price:false},{label:'net.sales',value:'price',qty:'price',price:true},{label:'Orders',value:'count',qty:'count',price:false}],[]);const fetchReport=()=>{const params={date_from,date_to,type:by_time,chart};if(category_id)params.categories=[category_id];if(product_id)params.products=[product_id];dispatch(fetchExtrasChart(params));};const fetchExtras=(page,perPage)=>{const params={date_from,date_to,type:by_time,page,perPage,search:search||null};if(category_id)params.categories=[category_id];if(product_id)params.products=[product_id];dispatch(fetchExtrasList(params));};useEffect(()=>{handleChart(chart_type[0].value);},[]);useEffect(()=>{if(activeMenu.refetch){fetchExtras();fetchReport();dispatch(disableRefetch(activeMenu));}},[activeMenu.refetch]);useDidUpdate(()=>{fetchExtras();},[date_to,search,category_id,product_id,date_from]);useDidUpdate(()=>{fetchReport();},[date_to,by_time,chart,category_id,product_id,date_from]);const onChangePagination=pagination=>{const{pageSize:perPage,current:page}=pagination;fetchExtras(page,perPage);};const excelExport=()=>{setDownloading(true);ReportService.getReportProductList({date_from,date_to,type:by_time,export:'excel',products:rowSelection===null||rowSelection===void 0?void 0:rowSelection.selectedRowKeys}).then(res=>{const body=res.data.link;if(body){window.location.href=body;}}).finally(()=>setDownloading(false));};const onSelectChange=newSelectedRowKeys=>{setSelectedRowKeys(newSelectedRowKeys);};const rowSelection={selectedRowKeys,onChange:onSelectChange};return/*#__PURE__*/_jsxs(Spin,{size:\"large\",spinning:loading,children:[/*#__PURE__*/_jsx(Row,{gutter:24,className:\"mb-3\",children:/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Space,{size:\"large\",children:/*#__PURE__*/_jsx(RangePicker,{defaultValue:[moment(date_from),moment(date_to)],onChange:handleDateRange})})})}),/*#__PURE__*/_jsx(Row,{gutter:24,className:\"report-products\",children:chart_type===null||chart_type===void 0?void 0:chart_type.map(item=>/*#__PURE__*/_jsx(Col,{span:8,onClick:()=>handleChart(item.value),children:/*#__PURE__*/_jsxs(Card,{className:chart===item.value&&'active',children:[/*#__PURE__*/_jsx(Row,{className:\"mb-5\",children:/*#__PURE__*/_jsx(Col,{children:/*#__PURE__*/_jsx(Text,{children:t(item.label)})})}),/*#__PURE__*/_jsxs(Row,{gutter:24,children:[/*#__PURE__*/_jsx(Col,{span:12,children:/*#__PURE__*/_jsx(Title,{level:2,children:!item.price?reportData[item.qty]:numberToPrice(reportData[item.qty],defaultCurrency===null||defaultCurrency===void 0?void 0:defaultCurrency.symbol)})}),/*#__PURE__*/_jsx(Col,{span:12,className:\"d-flex justify-content-end\",children:/*#__PURE__*/_jsx(Tag,{color:\"geekblue\",className:\"d-flex align-items-center\",children:\"5%\"})})]})]})},item.label))}),/*#__PURE__*/_jsx(ReportChart,{reportData:reportData,chart_data:\"quantities_sum\"}),/*#__PURE__*/_jsxs(Card,{children:[/*#__PURE__*/_jsxs(Space,{className:\"d-flex justify-content-between align-center\",children:[/*#__PURE__*/_jsx(Typography.Text,{strong:true,level:3,children:\"Extras\"}),/*#__PURE__*/_jsxs(Space,{className:\"d-flex justify-content-between\",children:[/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(CloudDownloadOutlined,{}),loading:downloading,onClick:excelExport,children:t('download')}),/*#__PURE__*/_jsx(FilterColumns,{columns:columns,setColumns:setColumns})]})]}),/*#__PURE__*/_jsx(Table,{rowSelection:rowSelection,columns:columns===null||columns===void 0?void 0:columns.filter(item=>item.is_show),dataSource:extrasList===null||extrasList===void 0?void 0:extrasList.data,rowKey:row=>row.id,loading:loading,pagination:{pageSize:10,page:(extrasList===null||extrasList===void 0?void 0:extrasList.page)||1,total:extrasList===null||extrasList===void 0?void 0:extrasList.total,defaultCurrent:1},onChange:onChangePagination,scroll:{x:1500}})]})]});};export default ReportExtras;","map":null,"metadata":{},"sourceType":"module"}