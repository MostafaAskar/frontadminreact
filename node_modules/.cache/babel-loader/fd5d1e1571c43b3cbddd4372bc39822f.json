{"ast":null,"code":"import React,{useEffect,useState}from'react';import{Button,Card,Col,Form,Input,InputNumber,Row,Switch}from'antd';import{DebounceSelect}from'components/search';import brandService from'services/rest/brand';import categoryService from'services/rest/category';import{shallowEqual,useDispatch,useSelector}from'react-redux';import productService from'services/seller/product';import{addMenu,replaceMenu,setMenuData}from'redux/slices/menu';import unitService from'services/seller/unit';import{useNavigate,useParams}from'react-router-dom';import{useTranslation}from'react-i18next';import MediaUpload from'components/upload';import TextArea from'antd/lib/input/TextArea';import{DeploymentUnitOutlined,PlusOutlined}from'@ant-design/icons';import{AsyncTreeSelect}from'components/async-tree-select-category';import VideoUploaderWithModal from'components/video-uploader';import generateRandomNumbers from'helpers/generateRandomNumbers';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";const ProductsIndex=_ref=>{var _activeMenu$data,_activeMenu$data2,_activeMenu$data2$ima;let{next,action_type='',isRequest}=_ref;const{t}=useTranslation();const[form]=Form.useForm();const dispatch=useDispatch();const{uuid}=useParams();const navigate=useNavigate();const{activeMenu}=useSelector(state=>state.menu,shallowEqual);const[mediaList,setMediaList]=useState((activeMenu===null||activeMenu===void 0?void 0:(_activeMenu$data=activeMenu.data)===null||_activeMenu$data===void 0?void 0:_activeMenu$data.initialMediaFile)||{images:[],previews:[]});const{defaultLang,languages}=useSelector(state=>state.formLang,shallowEqual);const[fileList,setFileList]=useState(((_activeMenu$data2=activeMenu.data)===null||_activeMenu$data2===void 0?void 0:(_activeMenu$data2$ima=_activeMenu$data2.images)===null||_activeMenu$data2$ima===void 0?void 0:_activeMenu$data2$ima.filter(item=>!item.isVideo))||[]);const[loadingBtn,setLoadingBtn]=useState(false);const randomNumbersLength=6;const{settings}=useSelector(state=>state.globalSettings);function fetchUserBrandList(username){const params={search:username};return brandService.getAll(params).then(res=>res.data.map(item=>({label:item.title,value:item.id})));}function fetchUserCategoryList(username){const params={search:username?username:null,type:'main'};return categoryService.paginateSelect(params).then(res=>res.data.map(item=>{var _item$translation,_item$children,_item$children2;return{label:(_item$translation=item.translation)===null||_item$translation===void 0?void 0:_item$translation.title,value:item.id,key:item.id,type:'main',disabled:(_item$children=item.children)===null||_item$children===void 0?void 0:_item$children.length,children:(_item$children2=item.children)===null||_item$children2===void 0?void 0:_item$children2.map(el=>{var _el$translation,_el$children,_el$children2;return{label:(_el$translation=el.translation)===null||_el$translation===void 0?void 0:_el$translation.title,value:el.id,key:el.id,type:'sub_main',disabled:(_el$children=el.children)===null||_el$children===void 0?void 0:_el$children.length,children:(_el$children2=el.children)===null||_el$children2===void 0?void 0:_el$children2.map(three=>{var _three$translation;return{label:(_three$translation=three.translation)===null||_three$translation===void 0?void 0:_three$translation.title,value:three.id,key:three.id,type:'child'};})};})};}));}function fetchUnits(search){const params={perPage:10,page:1,active:1,search};return unitService.getAll(params).then(_ref2=>{let{data}=_ref2;return formatUnits(data);});}const onFinish=values=>{var _values$brand,_values$category,_values$shop,_values$unit,_mediaList$previews;setLoadingBtn(true);const params={...values,digital:values.digital?1:0,active:Number(values.active),brand_id:(_values$brand=values.brand)===null||_values$brand===void 0?void 0:_values$brand.value,category_id:((_values$category=values.category)===null||_values$category===void 0?void 0:_values$category.value)||values.category,shop_id:(_values$shop=values.shop)===null||_values$shop===void 0?void 0:_values$shop.value,unit_id:(_values$unit=values.unit)===null||_values$unit===void 0?void 0:_values$unit.value,images:undefined,brand:values.brand,category:values.category,shop:values.shop,unit:values.unit,tax:values.tax||0,...Object.assign({},...[...(mediaList===null||mediaList===void 0?void 0:mediaList.images),...fileList].map((item,index)=>({[`images[${index}]`]:item.name}))),...Object.assign({},...(mediaList===null||mediaList===void 0?void 0:(_mediaList$previews=mediaList.previews)===null||_mediaList$previews===void 0?void 0:_mediaList$previews.map((item,index)=>({[`previews[${index}]`]:item.name}))))};if(isRequest){var _values$brand2,_values$category2,_values$shop2,_values$unit2;dispatch(setMenuData({activeMenu,data:{...activeMenu.data,...values,active:Number(values.active),// vegetarian: Number(values.vegetarian),\nbrand_id:(_values$brand2=values.brand)===null||_values$brand2===void 0?void 0:_values$brand2.value,category_id:((_values$category2=values.category)===null||_values$category2===void 0?void 0:_values$category2.value)||values.category,shop_id:(_values$shop2=values.shop)===null||_values$shop2===void 0?void 0:_values$shop2.value,unit_id:(_values$unit2=values.unit)===null||_values$unit2===void 0?void 0:_values$unit2.value,// kcal: nutrition ? String(values.kcal) : undefined,\n// carbs: nutrition ? String(values.carbs) : undefined,\n// protein: nutrition ? String(values.protein) : undefined,\n// fats: nutrition ? String(values.fats) : undefined,\ntax:values.tax||0,title:{...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`title[${lang.locale}]`]})))},description:{...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`description[${lang.locale}]`]})))},...Object.assign({},...fileList.map((item,index)=>({[`images[${index}]`]:item.name})))}}));next();return;}let isMainInfoChanged=false;Object.entries(values).forEach(_ref3=>{var _activeMenu$data5,_activeMenu$data5$ima;let[key,value]=_ref3;if(key.startsWith('title')||key.startsWith('description')){if(activeMenu.data&&activeMenu.data[key]!==value){isMainInfoChanged=true;}}if(key==='category'){var _activeMenu$data3,_activeMenu$data3$cat;if(((_activeMenu$data3=activeMenu.data)===null||_activeMenu$data3===void 0?void 0:(_activeMenu$data3$cat=_activeMenu$data3.category)===null||_activeMenu$data3$cat===void 0?void 0:_activeMenu$data3$cat.value)!==(value===null||value===void 0?void 0:value.value)){isMainInfoChanged=true;}}if(key==='brand'){var _activeMenu$data4,_activeMenu$data4$bra;if(((_activeMenu$data4=activeMenu.data)===null||_activeMenu$data4===void 0?void 0:(_activeMenu$data4$bra=_activeMenu$data4.brand)===null||_activeMenu$data4$bra===void 0?void 0:_activeMenu$data4$bra.value)!==(value===null||value===void 0?void 0:value.value)){isMainInfoChanged=true;}}const changedFile=fileList===null||fileList===void 0?void 0:fileList.find(file=>file.status==='done');if(!!changedFile||(fileList===null||fileList===void 0?void 0:fileList.length)!==((_activeMenu$data5=activeMenu.data)===null||_activeMenu$data5===void 0?void 0:(_activeMenu$data5$ima=_activeMenu$data5.images)===null||_activeMenu$data5$ima===void 0?void 0:_activeMenu$data5$ima.length)){isMainInfoChanged=true;}});if(action_type==='edit'){const tempParams={...params};tempParams.title={...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`title[${lang.locale}]`]})))};tempParams.description={...Object.assign({},...languages.map(lang=>({[lang.locale]:values[`description[${lang.locale}]`]})))};setMenuData({activeMenu,data:tempParams});if(isMainInfoChanged&&(settings===null||settings===void 0?void 0:settings.product_auto_approve)==='0'){saveRequest(tempParams);return;}productUpdate(values,params);}else{productCreate(values,params);}};function saveRequest(values){navigate(`/seller/product/${uuid}?step=1`,{state:values});}const createMediaFile=items=>{const mediaObject={images:[],previews:[]};const previews=items.filter(item=>item.preview).map(item=>({uid:item.id,name:item.preview,url:item.preview}));const videos=items.filter(item=>item.preview).map(item=>({uid:item.id,name:item.path,url:item.path,isVideo:true}));mediaObject.previews=previews;mediaObject.images=videos;return mediaObject;};function productCreate(values,params){productService.create(params).then(_ref4=>{let{data}=_ref4;dispatch(replaceMenu({id:`product-${data.uuid}`,url:`seller/product/${data.uuid}`,name:t('add.product'),data:{...values,initialMediaFile:createMediaFile(data.galleries)},refetch:false}));navigate(`/seller/product/${data.uuid}?step=1`,{state:{create:true}});}).finally(()=>setLoadingBtn(false));}function productUpdate(values,params){var _activeMenu$data6;params.product_id=(_activeMenu$data6=activeMenu.data)===null||_activeMenu$data6===void 0?void 0:_activeMenu$data6.product_id;productService.update(uuid,params).then(()=>{dispatch(setMenuData({activeMenu,data:{...params,...(activeMenu===null||activeMenu===void 0?void 0:activeMenu.data)}}));next();}).finally(()=>setLoadingBtn(false));}function formatUnits(data){return data.map(item=>{var _item$translation2;return{label:item===null||item===void 0?void 0:(_item$translation2=item.translation)===null||_item$translation2===void 0?void 0:_item$translation2.title,value:item===null||item===void 0?void 0:item.id,key:item===null||item===void 0?void 0:item.id};});}useEffect(()=>{return()=>{const data=form.getFieldsValue(true);dispatch(setMenuData({activeMenu,data:{...activeMenu.data,...data}}));};},[]);const goToAddCategory=()=>{dispatch(addMenu({url:`seller/category/add`,id:'seller/category/add',name:t('edit.category')}));navigate(`/seller/category/add`);};return/*#__PURE__*/_jsxs(Form,{layout:\"vertical\",form:form,initialValues:{active:true,vegetarian:true,min_qty:1,max_qty:1,tax:0,interval:1,age_limit:12,digital:false,...activeMenu.data},onFinish:onFinish,children:[/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:16,children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('basic.info'),children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:languages.map(item=>/*#__PURE__*/_jsx(Form.Item,{label:t('name'),name:`title[${item.locale}]`,rules:[{required:item.locale===defaultLang,message:t('required')}],hidden:item.locale!==defaultLang,children:/*#__PURE__*/_jsx(Input,{})},'name'+item.id))}),/*#__PURE__*/_jsx(Col,{span:24,children:languages.map(item=>/*#__PURE__*/_jsx(Form.Item,{label:t('description'),name:`description[${item.locale}]`,rules:[{required:item.locale===defaultLang,message:t('required')}],hidden:item.locale!==defaultLang,children:/*#__PURE__*/_jsx(TextArea,{rows:3})},'description'+item.id))})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('pricing'),children:/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(Form.Item,{label:t('min.qty'),name:\"min_qty\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(InputNumber,{min:1,className:\"w-100\"})})}),/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(Form.Item,{label:t('max.qty'),name:\"max_qty\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(InputNumber,{min:1,className:\"w-100\"})})}),/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsx(Form.Item,{label:t('tax'),name:\"tax\",children:/*#__PURE__*/_jsx(InputNumber,{min:0,className:\"w-100\",addonAfter:\"%\"})})})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('additions'),children:/*#__PURE__*/_jsxs(Row,{gutter:12,children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('age.limit'),name:\"age_limit\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(InputNumber,{min:1,className:\"w-100\"})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('active'),name:\"active\",valuePropName:\"checked\",children:/*#__PURE__*/_jsx(Switch,{})})}),/*#__PURE__*/_jsx(Col,{span:6,children:/*#__PURE__*/_jsx(Form.Item,{label:t('digital'),name:\"digital\",valuePropName:\"checked\",children:/*#__PURE__*/_jsx(Switch,{})})})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('video'),children:/*#__PURE__*/_jsx(VideoUploaderWithModal,{form:form,mediaList:mediaList,setMediaList:setMediaList})})})]})}),/*#__PURE__*/_jsx(Col,{span:8,children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('organization'),children:/*#__PURE__*/_jsxs(Row,{children:[/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('category'),name:\"category\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(AsyncTreeSelect,{fetchOptions:fetchUserCategoryList,dropdownRender:menu=>/*#__PURE__*/_jsxs(_Fragment,{children:[menu,/*#__PURE__*/_jsx(\"div\",{className:\"p-1\",children:/*#__PURE__*/_jsx(Button,{icon:/*#__PURE__*/_jsx(PlusOutlined,{}),className:\"w-100\",onClick:goToAddCategory,children:t('add.category')})})]})})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('brand'),name:\"brand\",rules:[{required:false,message:t('required')}],children:/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchUserBrandList})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('unit'),name:\"unit\",rules:[{required:true,message:t('required')}],children:/*#__PURE__*/_jsx(DebounceSelect,{fetchOptions:fetchUnits})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{label:t('interval'),name:\"interval\",rules:[{required:true,message:t('required')},{type:'number',min:1,message:t('should.be.more.than.1')}],children:/*#__PURE__*/_jsx(InputNumber,{className:\"w-100\"})})})]})})}),/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Card,{title:t('media'),children:/*#__PURE__*/_jsx(Row,{children:/*#__PURE__*/_jsx(Col,{span:24,children:/*#__PURE__*/_jsx(Form.Item,{name:\"images\",children:/*#__PURE__*/_jsx(MediaUpload,{type:\"products\",imageList:fileList,setImageList:setFileList,form:form,multiple:true})})})})})})]})})]}),/*#__PURE__*/_jsx(Button,{type:\"primary\",htmlType:\"submit\",loading:loadingBtn,children:t('next')})]});};export default ProductsIndex;","map":null,"metadata":{},"sourceType":"module"}